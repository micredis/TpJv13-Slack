Grigory Kislin [2:15 AM]
joined #hw7.

Grigory Kislin [2:29 AM]
7е занятие: REST контроллеры и их тестирование
https://github.com/JavaWebinar/topjava/blob/doc/doc/lesson07.md (edited)

tema.emelyan [2:36 AM]
joined #hw7 along with 18 others.

qf05 [3:08 PM]
Кто-нибудь уже разобрался почему при запуске testUser в  RootControllerTest не вызывается метод postConstruct() и mockMvc получается null? или это только у меня так?

Grigory Kislin [6 hours ago]
у меня вызывается. с гитхаб проект сравнивал?
попробуй новый в сторонке вычекать


alexey [4:43 PM]
Народ, кто натали первые 6 патчей, скиньте  код *app_ru.properties* пжлст.

Oleksii Leshchenko [4:44 PM]
added this JavaScript/JSON snippet: Untitled 
app.title=Подсчет калорий
app.home=Главная
app.footer=Приложение по проекту <a href="https://github.com/JavaOPs/topjava" target=_blank>Maven/ Spring/ Security/ JPA(Hibernate)/ Jackson/jQuery</a>
app.login=Зайти как
​
user.title=Пользователи
user.name=Имя
user.email=Почта
user.roles=Роли
user.active=Активный
user.registered=Зарегистрирован
​
meal.title=Моя еда
meal.edit=Редактирование еды
meal.add=Добавление еды
meal.filter=Отфильтровать
meal.startDate=От даты
meal.endDate=До даты
meal.startTime=От времени
meal.endTime=До времени
meal.description=Описание
meal.dateTime=Дата/Время
meal.calories=Калории
​
common.select=Выбрать
common.delete=Удалить
common.update=Обновить
common.save=Сохранить
common.cancel=Отмена
common.actions=Выполнить
Collapse 

Oleksii Leshchenko [5:38 PM]
added and commented on this Java snippet: Untitled 
public static void assertMatch(Iterable<Meal> actual, Iterable<Meal> expected) {
    assertThat(actual).usingElementComparatorIgnoringFields("user").isEqualTo(expected);
  }
Интересует вопрос, должны ли обе коллекции отсортированы одинаково в этом методе? Что, если сравниваемые коллекции одинаковые, но элементы в разном порядке хранятся...?


Oleksii Leshchenko [Today at 6:11 PM]
in #hw7
Я так понимаю, что вместо SoapUI можно использовать и Postman?
https://www.getpostman.com/ (edited)


1 reply
Dmitry Neustupov [1 hour ago]
Можно, кому как удобней. По мне и Соап норм.


alexey [7:57 PM]
commented on Oleksii Leshchenko’s snippet Untitled
спасибо

dustnfox [10:18 PM]
commented on Oleksii Leshchenko’s snippet Untitled
Сейчас подебажил это хозяйство и таки да - должны. Просто берутся два итератора (от actual и expected) и поочередно сравниваются очередные результаты вызова `next()` на каждой коллекции.
dustnfox [10:19 PM]
  ```private boolean compareElementsOf(Iterable<T> actual, Iterable<T> other) {
    if (sizeOf(actual) != sizeOf(other)) return false;
    // compare their elements with elementComparator
    Iterator<T> iterator = other.iterator();
    for (T actualElement : actual) {
      T otherElement = iterator.next();
      if (elementComparator.compare(actualElement, otherElement) != 0) return false;
    }
    return true;
  }```
dustnfox [10:29 PM]
В общем, довольно ожидаемый результат. Думаю, если бы была какая-то экзотика, (например, сравнить поэлементно и если не равны, то отсортировать и сравнить снова) то это в явном виде описали бы в документации.


CRCx86 [10:59 PM]
Добрый вечер!
подскажите, что-то непонятное для меня творится c IDEA
добавляю проект, добавляю maven
переоткрываю заново IDEA, всё пусто

CRCx86 [11:01 PM]
uploaded this image: image.png 


CRCx86 [11:01 PM]
что может быть такое?

Viktor [11:02 PM]
закрой проект и покажи окно идеи, там где идет выбор проекта

CRCx86 [11:04 PM]
uploaded this image: image.png 


realcorwin [Yesterday at 11:18 PM]
in #hw7
Смотрю сейчас видео к патчам. REST - это у нас настройка над MVC, так?


2 replies
Oleksii Leshchenko [13 hours ago]
Нет. Просто ранее наши методы в контроллере перенаправляли на JSP и в результате клиенту выплевывали HTML. Rest - мы формируем json данные и отдаем клиенту. А уже клиент при помощи JavaScript будет с ними чтото делать...


realcorwin [1 hour ago]
O, так понятно :slightly_smiling_face:.


Oleksii Leshchenko [11:54 PM]
commented on Untitled
@dustnfox ясно, спасибо) 
Это на самом деле недостаток. Непонятно, чего в наших тестах рассчитывают на то, что порядок будет одинаковый. В Хармкрест есть метчеры, которые могут сравнивать неотсортированнын коллекции...


Arthur [Today at 1:13 AM]
in #hw7
Ребят, а у вас все патчи в этом уроке гладко легли?
У меня 2 и 9 патч дал коллизии. (edited)


3 replies
Oleksii Leshchenko [4 hours ago]
Без коллизий... Но были в прошлом уроке. Я накатывал изменения из гитхаба отсюда #project_change


Oleksii Leshchenko [4 hours ago]
Т. е.  Смерджил их мастер с моим по тем комитам... И были чегото конфликты при этом...


Arthur [3 hours ago]
ок, спасибо


aleksey [1:51 AM]
Привет всем
   1.2 ResourceControllerTest для style.css (проверить status и ContentType)
Это о чем вообще? В каком видео об этой штуке что-то упоминается?

Dzmitry Shalukhau [7:39 AM]
@CRCx86 У меня такое было когда ненароком imp файл прибил. Помогло удаление папки .idea в проекте и открытие заново

dustnfox [7:49 AM]
commented on CRCx86’s file image.png
Судя по пути, лежит на OneDrive. Это только версия, но вчера РКН положил по 15й маске часть адресов Microsoft. Большая часть относилась к Azure, т.е. к "облакам" MS. Возможно как-то и OneDrive зацепило, ибо черт его знает, кто и для чего эти облака использует.  У меня вот, например, вчера PSN вырубился после всех этих экспериментов роскомнадзоровских волшебников. 
Вообще, конечно папка OneDrive должна быть локально выкачана и прилетать только обновами, но если синхронизация первая или MS чего-то хитрого намудрил, то может и так глючить.

qf05 [10:11 AM]
Ну вот и у меня теперь слака через тор только пашет(((( 
В этом в роскомнадзоре совсем поехавшие деб..лы сидят? Какая же это всё х..ня, какой смысл? Каккие нафиг переписки террористов... Будто шахиды совсем тупые и не умеют гуглить как обходить блокировки?..  Да любой из нас уже может за пару дней, ну максимум за недельку накатать свой простенький мессенджер со своим шифрованием, я не говорю уже о сотнях вариантах готового кода по всему интернету... Да кому надо, тот может спокойно у себя в сарае атомную бомбу собрать... Да, у меня тут полигон артелирийский в 2-х км, можно вообще спокойно туда придти и из неразорвавшихся снарядов гегс..гена хоть тонну наковырять, у нас месные им костры в сырую погоду разводят))))

LeoJames [10:18 AM]
/*Чисто для протокола товарищу майору*/
"Да любой из нас..." звучит как то странно в таком контексте:grin:

qf05 [10:22 AM]
Любой из нас - в смысле что, все кто зесь проходит практику, уже имеют достаточную базу знаний, что бы реализовать обмен сообщений между двумя юзерами.

LeoJames [10:24 AM]
:thinking_face:Товарищ майор сказал, что поздно заднюю давать

qf05 [10:33 AM]
ушел в лес... пускай ищут...))))

qf05 [10:53 AM]
Для тех, у кого так же как у меня, не вызывается PostConstruct, надо добавить зависимость:
<dependency>
   <groupId>javax.annotation</groupId>
   <artifactId>javax.annotation-api</artifactId>
   <version>1.3.1</version>
</dependency>
Актуально для java 9.


Viktor [9:00 PM]
@qf05 думаю у тебя проблема со слаком локальная, я тоже из РФ, все спокойно запускается без проблем. Либо моему оператоору пофиг на блокировки :smiley: (edited)

druxa [9:12 PM]
@GetMapping("/owners/{ownerId}/pets/{petId}")
public Pet findPet(@PathVariable Long ownerId, @PathVariable Long petId) {
   // ...
} Если в @PathVariable не указано имя ("ownerId" и "petId") , то спринг подставляет имена по именам переменных?

Vyacheslav [6:29 PM]
Народ. SoapUI нормально качается? У меня что-то не прет.  https://www.soapui.org/downloads/thank-you-for-downloading-soapui.html
soapui.org
Download REST & SOAP Automated API Testing Tool | Open Source | SoapUI
Compare SoapUI Pro vs Open Source. Try out the most widely used API testing tool in the world today!

Ma3stro [8:12 PM]
После накатки всех патчей вылетает `ConflictingBeanDefinitionException: Annotation-specified bean name 'jspMealController'` и открываться ничего не хочет, как это исправить? (edited)


qf05 [Yesterday at 8:32 PM]
in #hw7
@Vyacheslav А что soap так и надо качать триал на 14 дней? Крякнутой нет?


3 replies
Vyacheslav [7 hours ago]
Да вроде нет. https://www.soapui.org/downloads/soapui.html
soapui.org
Download REST & SOAP Automated API Testing Tool | Open Source | SoapUI
Compare SoapUI Pro vs Open Source. Try out the most widely used API testing tool in the world today!


Vyacheslav [7 hours ago]
Заработала загрузка. Наверное опять Роскомнадзор гадит.


Grigory Kislin [5 hours ago]
я бесплатный ставил


realcorwin [8:38 PM]
В Идею вшит Test RESTful Web Service (в меню Tools)


realcorwin [Yesterday at 8:51 PM]
in #hw7
testDelete падает - статус 204, а не 200



9 replies
aleksey [6 hours ago]
у нас над delete аннотация
   @ResponseStatus(value = HttpStatus.NO_CONTENT)
https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/204
так что он не падает, а успешно выполняется.
MDN Web Docs
204 No Content
The HTTP 204 No Content success status response code indicates that the request has succeeded, but that the client doesn't need to go away from its current page. A 204 response is cacheable by default. An ETag header is included in such a response.
 


realcorwin [6 hours ago]
это у вас аннотация, а у нас в патчах никакой аннотации нет :slightly_smiling_face:


aleksey [6 hours ago]
тоесть у меня какие-то другие патчи?

qf05 [6 hours ago]
я закоммитил эту аннотацию)


qf05 [6 hours ago]
теперь сижу и думаю, может раскомитить и в тестах изменение сделать?

realcorwin [6 hours ago]
пацаны, вы что издеваетесь? :slightly_smiling_face: что вы делаете с патчами Григория :slightly_smiling_face:


aleksey [6 hours ago]
черт, да, я же сам ее поставил, забыл уже :smiley:


realcorwin [6 hours ago]
короче, тесты изменяются, пока не дают правильный результат :slightly_smiling_face: предлагаю выпилить их нахрен :slightly_smiling_face: толку-то :slightly_smiling_face:


realcorwin [5 hours ago]
@aleksey не работает твоя аннотация. status().is2xxSuccessful() работает


Grigory Kislin [10:54 PM]
*В после патчей этого урока валятся AdminRestControllerTest.testDelete и ProfileRestControllerTest.testDelete (в контроллере поменялся код ответа)*
Моя бага, добавлю в ДЗ: починить. (edited)

realcorwin [10:55 PM]
Ага. Ну, я собственно уже спалил строчку починки

Grigory Kislin [10:56 PM]
:slightly_smiling_face:

realcorwin [11:35 PM]
Ребята, кто уже делал MealRestControllerTest, там можно метод contentJson реализовывать аналогично как для User только для Meal, или там есть какие-то свои хитрости? Я почти всё сделал, но тут уже начал уставать...

Ma3stro [11:38 PM]
И все же не могу понять в чём дело. Возникает сие при запуске приложения
В расшифровке ошибки сказано, что бин "jspMealController" из пакета ru.javawebinar.topjava.web.meal.JspMealController конфликтует с одноименным(!) бином из пакета ru.javawebinar.topjava.web.JspMealController, хотя в пакете .web нет такого класса вовсе, только в web.meal!!! Гугления мне не помогли:/
```ConflictingBeanDefinitionException: Annotation-specified bean name 'jspMealController' for bean class [ru.javawebinar.topjava.web.meal.JspMealController] conflicts with existing, non-compatible bean definition of same name and class [ru.javawebinar.topjava.web.JspMealController]```
(edited)

Ma3stro [11:44 PM]
Пришлось чинить это тем, что прописал отдельно сканы на web.meal и web.user

realcorwin [11:52 PM]
@Ma3stro это у тебя после твоих изменений такая бяка появилась?.. потому что в патчах такого нет
я бы покопался в *.xml файлах. где-то что-то не туда указывает, дублирует итп.

Grigory Kislin [12:33 AM]
@Ma3stro mvn clean попробуй
у тебя мог class остаться

realcorwin [1:51 AM]
ребята, кто-нибудь получал такую радость на тестах?

Cannot deserialize instance of `java.util.LinkedHashMap` out of START_ARRAY token

Вылетает у меня на testGet и testGetAll
для информации:

@test
   public void testGet() throws Exception {
       mockMvc.perform(get(REST_URL + MEAL1_ID))
               .andExpect(status().isOk())
               .andDo(print())
               .andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))
               .andExpect(contentJson(MEAL1));
   }
-----------------
@Override
   @GetMapping("/{id}")
   public Meal get(@PathVariable("id") int id) {
       return super.get(id);
   }
-----------------
MockHttpServletResponse:
          Status = 200
   Error message = null
         Headers = {Content-Type=[application/json;charset=UTF-8]}
    Content type = application/json;charset=UTF-8
            Body = {"id":100002,"dateTime":"2015-05-30T10:00:00","description":"Завтрак","calories":500,"user":null} (edited)
---------------
Исключение вылетает на .andExpect(contentJson(MEAL1))
---------------
public static ResultMatcher contentJson(Meal... expected) {
      return content().json(writeIgnoreProps(expected, "user"));
  }


qf05 [11:06 AM]
помогите разобраться, сейчас мучаю Test RESTful Web Service, с get запросами всё работает, а вот с post и put не могу разобраться как в боди передать объект meal.
В HTTP method выбираю post, в Host/port: http://localhost:8080, в Path: /rest/meals, в requestBody: text: {"dateTime":2017-10-20T11:00,"description":qwerty,"calories":300}
пробовал в Path: /rest/meals?{"dateTime":2017-10-20T11:00,"description":qwerty,"calories":300}
На всё один ответ: The origin server is refusing to service the request because the payload is in a format not supported by this method on the target resource.

aleksey [5:39 PM]
Кто-нибудь уже делал optional? кастомные форматтеры? У меня проблема, может кто сможет помочь?
Я успешно создаю свои форматтеры, они даже работают в виде аннотаций, но при подключении
<mvc:annotation-driven conversion-service="conversionService" /> в spring-mvc.xml
у меня начинают валиться половина тестов с чем-то подобным:
*** java.lang.instrument ASSERTION FAILED ***: "!errorOutstanding" with message transform method call failed at JPLISAgent.c line: 844
*** java.lang.instrument ASSERTION FAILED ***: "!errorOutstanding" with message transform method call failed at JPLISAgent.c line: 844
*** java.lang.instrument ASSERTION FAILED ***: "!errorOutstanding" with message transform method call failed at JPLISAgent.c line: 844
17:34:46.738 WARN  o.s.w.s.m.support.DefaultHandlerExceptionResolver.handleHttpMessageNotWritable:442 - Failed to write HTTP message: org.springframework.http.converter.HttpMessageNotWritableException: Could not write JSON: Infinite recursion (StackOverflowError); nested exception is com.fasterxml.jackson.databind.JsonMappingException: Infinite recursion (StackOverflowError) (through reference chain: ru.javawebinar.topjava.model
кто-нибудь понимает в чем причина? (edited)


alexey [6:43 PM]
added and commented on this Plain Text snippet: MealRestControllerTest.update 
org.springframework.http.InvalidMediaTypeException: Invalid mime type "{"id":100002,"dateTime":"2015-05-30T10:00:00","description":"Завтрак","calories":666}": does not contain '/'
  at org.springframework.http.MediaType.parseMediaType(MediaType.java:512)
  at org.springframework.test.web.servlet.request.MockHttpServletRequestBuilder.contentType(MockHttpServletRequestBuilder.java:282)
  at ru.javawebinar.topjava.web.meal.MealRestControllerTest.TestUpdate(MealRestControllerTest.java:77)
  at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
  at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
  at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
  at java.lang.reflect.Method.invoke(Method.java:498)
  at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)
  at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
  at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)
  at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)
  at org.springframework.test.context.junit4.statements.RunBeforeTestExecutionCallbacks.evaluate(RunBeforeTestExecutionCallbacks.java:73)
  at org.springframework.test.context.junit4.statements.RunAfterTestExecutionCallbacks.evaluate(RunAfterTestExecutionCallbacks.java:83)
  at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)
  at org.springframework.test.context.junit4.statements.RunBeforeTestMethodCallbacks.evaluate(RunBeforeTestMethodCallbacks.java:75)
  at org.springframework.test.context.junit4.statements.RunAfterTestMethodCallbacks.evaluate(RunAfterTestMethodCallbacks.java:86)
  at org.springframework.test.context.junit4.statements.SpringRepeat.evaluate(SpringRepeat.java:84)
  at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:251)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:97)
  at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)
  at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)
  at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)
  at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)
  at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)
  at org.springframework.test.context.junit4.statements.RunBeforeTestClassCallbacks.evaluate(RunBeforeTestClassCallbacks.java:61)
  at org.springframework.test.context.junit4.statements.RunAfterTestClassCallbacks.evaluate(RunAfterTestClassCallbacks.java:70)
  at org.junit.runners.ParentRunner.run(ParentRunner.java:363)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.run(SpringJUnit4ClassRunner.java:190)
  at org.junit.runner.JUnitCore.run(JUnitCore.java:137)
  at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:68)
  at com.intellij.rt.execution.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:47)
  at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:242)
  at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:70)
Caused by: org.springframework.util.InvalidMimeTypeException: Invalid mime type "{"id":100002,"dateTime":"2015-05-30T10:00:00","description":"Завтрак","calories":666}": does not contain '/'
  at org.springframework.util.MimeTypeUtils.parseMimeType(MimeTypeUtils.java:193)
  at org.springframework.http.MediaType.parseMediaType(MediaType.java:509)
  ... 33 more
Collapse 
Народ подскажите в куда смотреть, update валиться с ошибкой. Пол дня сижу туплю


roma [Today at 6:52 PM]
in #hw7
я так понял ни у одного меня soapUi open source не качается? (edited)


1 reply
alexey [5 hours ago]
такая же фигня(


roma [7:18 PM]
Может это как то связано с попыткой блокировки телеграма

roma [7:19 PM]
uploaded this image: image.png 


qf05 [7:21 PM]
у меня тоже не грузило, пока через тор не открыл))))

roma [7:24 PM]
с 15 этажа - красиво летит бумажный самолетик )

qf05 [7:54 PM]
блин, целый день убил, так и не понял как сформировать запрос на создание еды и юзера. например вот для юзера в боди пишу: {"name":"User2","email":"use2r@yandex.ru","password":"password","roles":["ROLE_USER"]}
что не так?
