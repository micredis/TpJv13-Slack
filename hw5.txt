Grigory Kislin [2:51 PM]
joined #hw5.

Grigory Kislin [2:53 PM]
пятое занятие: заканчиваем с DB.
https://github.com/JavaWebinar/topjava/blob/doc/doc/lesson05.md
на следующем занятии 10.04 начинается web (edited)

tema.emelyan [2:55 PM]
joined #hw5 along with 18 others.

Arthur [10:43 PM]
Всем привет! 
Кто-нибудь уже смотрел новые темы и накатывал патчи?
Меня интересует: выбор spring профиля, а точнее говоря - как IDEA реагирует на выбор того или иного профиля? Есть ли какая-нибудь подсветка активного и неактивного профиля. 
Лично у меня IDEA никак в плане подсветки кода не реагирует на смену профиля.
(флажок в настройках выставлен) (edited)

Dmitry Neustupov [11:01 PM]
@Arthur
Аналогично, никакой реакции.

Arthur [11:01 PM]
ok

Andrew Manik [4:50 PM]
Для корректного отображения неактивного профиля в IDEA проверьте флаг Inactive profile highlighting и сделайте проекту clean
https://github.com/JavaWebinar/topjava/blob/doc/doc/lesson05.md
doc/lesson05.md
```
# Онлайн проект <a href="https://github.com/JavaWebinar/topjava">Topjava</a>

## <a href="https://drive.google.com/drive/folders/0B9Ye2auQ_NsFfmctT3oyNW1qaVhDb2p0bGpyTFVlaUJ2VVpOdVgtWF9KTUFBMWFaR2xVYVE">Материалы занятия</a>
### ![error](https://cloud.githubusercontent.com/assets/13649199/13672935/ef09ec1e-e6e7-11e5-9f79-d1641c05cbe6.png) Правки в проекте

#### Apply 5_0_fix.patch
> Удалил из зависимостей commons-logging: [Spring Framework 5.0 comes with its own Commons Logging bridge](https://github.com/spring-projects/spring-framework/wiki/What's-New-in-Spring-Framework-5.x#general-core-revision)

## ![hw](https://cloud.githubusercontent.com/assets/13649199/13672719/09593… Show more

JavaWebinar/topjava
Added by GitHub


saudabaew [9:35 AM]
кто понял о чем патч 5_2_fix_hibernate_issue?

Vladimir Gorbatenko [11:25 AM]
Накатил все патчи с изучением того что происходит, всквозную прочел статьи в описании патчей... Это же капец, у нас получается калькулятор с использованием нанотехнологий. Надо еще видео посмотреть. Афигеть какой огромный объем информации, это же как все запоминать??? Читаешь статьи и прозреваешь сколько всего люди знают...

tema.emelyan [11:31 AM]
недавно прочитал прикольную фразу: когда читаешь статьи в интернете, важно помнить, что не все они написаны одним человеком :smiley:

Oleksii Leshchenko [11:31 AM]
Все сразу читать не обязательно

tema.emelyan [11:31 AM]
по-моему очень точно в тему импостер синдрома

Vladimir Gorbatenko [11:48 AM]
Вот это (Самый быстрый пул соединений на java (читаем комменты)) особенно понравилось, прочел начало статьи и пошел читать комменты, где развели дикий срачь про хикари это таки быстро и не может этого быть ))
https://habrahabr.ru/post/269023/ (edited)


poleg [Today at 12:55 PM]
in #hw5
Для переключения на HSQLDB необходимо:
поменять в окне Maven Projects профиль (Profiles) на hsqldb и сделать Reimport All Maven Projects (1я кнопка)
поменять Profiles.ACTIVE_DB = HSQLDB
почистить проект mvn clean (фаза clean не выполняется автоматически, чтобы каждый раз не перекомпилировать весь проект)

Все сделал, тесты валятся с ошибкой
java.lang.IllegalStateException: Failed to load ApplicationContext at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContext(DefaultCacheAwareContextLoaderDelegate.java:125)

При переключении на постгрес все ок. Что я делаю не так?


1 reply
Oleksii Leshchenko [2 hours ago]
А можно полное сообщение об ошибке, весь стэк?


poleg [1:00 PM]
added this Plain Text snippet: Untitled 
12:59:25.462 ERROR o.springframework.test.context.TestContextManager.prepareTestInstance:246 - Caught exception while allowing TestExecutionListener [org.springframework.test.context.support.DependencyInjectionTestExecutionListener@543e710e] to prepare test instance [ru.javawebinar.topjava.service.MealServiceTest@4b200971]
java.lang.IllegalStateException: Failed to load ApplicationContext
  at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContext(DefaultCacheAwareContextLoaderDelegate.java:125)
  at org.springframework.test.context.support.DefaultTestContext.getApplicationContext(DefaultTestContext.java:107)
  at org.springframework.test.context.support.DependencyInjectionTestExecutionListener.injectDependencies(DependencyInjectionTestExecutionListener.java:117)
  at org.springframework.test.context.support.DependencyInjectionTestExecutionListener.prepareTestInstance(DependencyInjectionTestExecutionListener.java:83)
  at org.springframework.test.context.TestContextManager.prepareTestInstance(TestContextManager.java:242)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.createTest(SpringJUnit4ClassRunner.java:227)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner$1.runReflectiveCall(SpringJUnit4ClassRunner.java:289)
  at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.methodBlock(SpringJUnit4ClassRunner.java:291)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:246)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:97)
  at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)
  at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)
  at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)
  at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)
  at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)
  at org.springframework.test.context.junit4.statements.RunBeforeTestClassCallbacks.evaluate(RunBeforeTestClassCallbacks.java:61)
  at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
  at org.springframework.test.context.junit4.statements.RunAfterTestClassCallbacks.evaluate(RunAfterTestClassCallbacks.java:70)
  at org.junit.runners.ParentRunner.run(ParentRunner.java:363)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.run(SpringJUnit4ClassRunner.java:190)
  at org.junit.runner.JUnitCore.run(JUnitCore.java:137)
  at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:68)
  at com.intellij.rt.execution.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:47)
  at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:242)
  at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:70)
Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.jdbc.datasource.init.DataSourceInitializer#0': Invocation of init method failed; nested exception is org.springframework.jdbc.datasource.init.ScriptStatementFailedException: Failed to execute SQL script statement #5 of class path resource [db/initDB.sql]: CREATE SEQUENCE global_seq START 100000; nested exception is java.sql.SQLSyntaxErrorException: unexpected token: 100000 required: WITH
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1710)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:583)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:502)
  at org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:312)
  at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:228)
  at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:310)
  at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:200)
  at org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:760)
  at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:868)
  at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:549)
  at org.springframework.test.context.support.AbstractGenericContextLoader.loadContext(AbstractGenericContextLoader.java:128)
  at org.springframework.test.context.support.AbstractGenericContextLoader.loadContext(AbstractGenericContextLoader.java:60)
  at org.springframework.test.context.support.AbstractDelegatingSmartContextLoader.delegateLoading(AbstractDelegatingSmartContextLoader.java:107)
  at org.springframework.test.context.support.AbstractDelegatingSmartContextLoader.loadContext(AbstractDelegatingSmartContextLoader.java:243)
  at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContextInternal(DefaultCacheAwareContextLoaderDelegate.java:99)
  at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContext(DefaultCacheAwareContextLoaderDelegate.java:117)
  ... 25 common frames omitted
Caused by: org.springframework.jdbc.datasource.init.ScriptStatementFailedException: Failed to execute SQL script statement #5 of class path resource [db/initDB.sql]: CREATE SEQUENCE global_seq START 100000; nested exception is java.sql.SQLSyntaxErrorException: unexpected token: 100000 required: WITH
  at org.springframework.jdbc.datasource.init.ScriptUtils.executeSqlScript(ScriptUtils.java:492)
  at org.springframework.jdbc.datasource.init.ResourceDatabasePopulator.populate(ResourceDatabasePopulator.java:240)
  at org.springframework.jdbc.datasource.init.CompositeDatabasePopulator.populate(CompositeDatabasePopulator.java:87)
  at org.springframework.jdbc.datasource.init.DatabasePopulatorUtils.execute(DatabasePopulatorUtils.java:48)
  at org.springframework.jdbc.datasource.init.DataSourceInitializer.execute(DataSourceInitializer.java:111)
  at org.springframework.jdbc.datasource.init.DataSourceInitializer.afterPropertiesSet(DataSourceInitializer.java:96)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeInitMethods(AbstractAutowireCapableBeanFactory.java:1769)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1706)
  ... 40 common frames omitted
Caused by: java.sql.SQLSyntaxErrorException: unexpected token: 100000 required: WITH
  at org.hsqldb.jdbc.JDBCUtil.sqlException(Unknown Source)
  at org.hsqldb.jdbc.JDBCUtil.sqlException(Unknown Source)
  at org.hsqldb.jdbc.JDBCStatement.fetchResult(Unknown Source)
  at org.hsqldb.jdbc.JDBCStatement.execute(Unknown Source)
  at org.springframework.jdbc.datasource.init.ScriptUtils.executeSqlScript(ScriptUtils.java:471)
  ... 47 common frames omitted
Caused by: org.hsqldb.HsqlException: unexpected token: 100000 required: WITH
  at org.hsqldb.error.Error.parseError(Unknown Source)
  at org.hsqldb.ParserBase.unexpectedTokenRequire(Unknown Source)
  at org.hsqldb.ParserBase.readThis(Unknown Source)
  at org.hsqldb.ParserTable.readSequenceOptions(Unknown Source)
  at org.hsqldb.ParserDDL.compileCreateSequence(Unknown Source)
  at org.hsqldb.ParserDDL.compileCreate(Unknown Source)
  at org.hsqldb.ParserCommand.compilePart(Unknown Source)
  at org.hsqldb.ParserCommand.compileStatements(Unknown Source)
  at org.hsqldb.Session.executeDirectStatement(Unknown Source)
  at org.hsqldb.Session.execute(Unknown Source)
  ... 50 common frames omitted
java.lang.IllegalStateException: Failed to load ApplicationContext
  at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContext(DefaultCacheAwareContextLoaderDelegate.java:125)
  at org.springframework.test.context.support.DefaultTestContext.getApplicationContext(DefaultTestContext.java:107)
  at org.springframework.test.context.support.DependencyInjectionTestExecutionListener.injectDependencies(DependencyInjectionTestExecutionListener.java:117)
  at org.springframework.test.context.support.DependencyInjectionTestExecutionListener.prepareTestInstance(DependencyInjectionTestExecutionListener.java:83)
  at org.springframework.test.context.TestContextManager.prepareTestInstance(TestContextManager.java:242)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.createTest(SpringJUnit4ClassRunner.java:227)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner$1.runReflectiveCall(SpringJUnit4ClassRunner.java:289)
  at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.methodBlock(SpringJUnit4ClassRunner.java:291)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:246)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:97)
  at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)
  at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)
  at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)
  at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)
  at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)
  at org.springframework.test.context.junit4.statements.RunBeforeTestClassCallbacks.evaluate(RunBeforeTestClassCallbacks.java:61)
  at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
  at org.springframework.test.context.junit4.statements.RunAfterTestClassCallbacks.evaluate(RunAfterTestClassCallbacks.java:70)
  at org.junit.runners.ParentRunner.run(ParentRunner.java:363)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.run(SpringJUnit4ClassRunner.java:190)
  at org.junit.runner.JUnitCore.run(JUnitCore.java:137)
  at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:68)
  at com.intellij.rt.execution.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:47)
  at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:242)
  at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:70)
Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.jdbc.datasource.init.DataSourceInitializer#0': Invocation of init method failed; nested exception is org.springframework.jdbc.datasource.init.ScriptStatementFailedException: Failed to execute SQL script statement #5 of class path resource [db/initDB.sql]: CREATE SEQUENCE global_seq START 100000; nested exception is java.sql.SQLSyntaxErrorException: unexpected token: 100000 required: WITH
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1710)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:583)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:502)
  at org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:312)
  at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:228)
  at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:310)
  at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:200)
  at org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:760)
  at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:868)
  at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:549)
  at org.springframework.test.context.support.AbstractGenericContextLoader.loadContext(AbstractGenericContextLoader.java:128)
  at org.springframework.test.context.support.AbstractGenericContextLoader.loadContext(AbstractGenericContextLoader.java:60)
  at org.springframework.test.context.support.AbstractDelegatingSmartContextLoader.delegateLoading(AbstractDelegatingSmartContextLoader.java:107)
  at org.springframework.test.context.support.AbstractDelegatingSmartContextLoader.loadContext(AbstractDelegatingSmartContextLoader.java:243)
  at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContextInternal(DefaultCacheAwareContextLoaderDelegate.java:99)
  at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContext(DefaultCacheAwareContextLoaderDelegate.java:117)
  ... 25 more
Caused by: org.springframework.jdbc.datasource.init.ScriptStatementFailedException: Failed to execute SQL script statement #5 of class path resource [db/initDB.sql]: CREATE SEQUENCE global_seq START 100000; nested exception is java.sql.SQLSyntaxErrorException: unexpected token: 100000 required: WITH
  at org.springframework.jdbc.datasource.init.ScriptUtils.executeSqlScript(ScriptUtils.java:492)
  at org.springframework.jdbc.datasource.init.ResourceDatabasePopulator.populate(ResourceDatabasePopulator.java:240)
  at org.springframework.jdbc.datasource.init.CompositeDatabasePopulator.populate(CompositeDatabasePopulator.java:87)
  at org.springframework.jdbc.datasource.init.DatabasePopulatorUtils.execute(DatabasePopulatorUtils.java:48)
  at org.springframework.jdbc.datasource.init.DataSourceInitializer.execute(DataSourceInitializer.java:111)
  at org.springframework.jdbc.datasource.init.DataSourceInitializer.afterPropertiesSet(DataSourceInitializer.java:96)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeInitMethods(AbstractAutowireCapableBeanFactory.java:1769)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1706)
  ... 40 more
Caused by: java.sql.SQLSyntaxErrorException: unexpected token: 100000 required: WITH
  at org.hsqldb.jdbc.JDBCUtil.sqlException(Unknown Source)
  at org.hsqldb.jdbc.JDBCUtil.sqlException(Unknown Source)
  at org.hsqldb.jdbc.JDBCStatement.fetchResult(Unknown Source)
  at org.hsqldb.jdbc.JDBCStatement.execute(Unknown Source)
  at org.springframework.jdbc.datasource.init.ScriptUtils.executeSqlScript(ScriptUtils.java:471)
  ... 47 more
Caused by: org.hsqldb.HsqlException: unexpected token: 100000 required: WITH
  at org.hsqldb.error.Error.parseError(Unknown Source)
  at org.hsqldb.ParserBase.unexpectedTokenRequire(Unknown Source)
  at org.hsqldb.ParserBase.readThis(Unknown Source)
  at org.hsqldb.ParserTable.readSequenceOptions(Unknown Source)
  at org.hsqldb.ParserDDL.compileCreateSequence(Unknown Source)
  at org.hsqldb.ParserDDL.compileCreate(Unknown Source)
  at org.hsqldb.ParserCommand.compilePart(Unknown Source)
  at org.hsqldb.ParserCommand.compileStatements(Unknown Source)
  at org.hsqldb.Session.executeDirectStatement(Unknown Source)
  at org.hsqldb.Session.execute(Unknown Source)
  ... 50 more
Collapse 
 This snippet was truncated for display; see it in full
poleg [1:02 PM]
Хм ругается на java.sql.SQLSyntaxErrorException: unexpected token: 100000 required: WITH


Oleksii Leshchenko [1:06 PM]
Оно пытается применить db/initDB.sql. Там для HSQLDB был другой скрипт


poleg [Today at 1:07 PM]
in #hw5
Так я ж ничего не менял. Я тоже вижу теперь что он initDB.sql берет вместо initDB_hsql.sql


2 replies
Oleksii Leshchenko [2 hours ago]
Попробуй clean и Reimport maven projects поменять местами. Т.е. вначале сделать clean


poleg [2 hours ago]
Уже. В разных комбинациях. Все равно ошибка. (edited)


poleg [1:08 PM]
Но:
   <beans profile="hsqldb">
       <context:property-placeholder location="classpath:db/hsqldb.properties" system-properties-mode="OVERRIDE"/>
А в hsqldb.properties:
jdbc.initLocation=initDB_hsql.sql

qf05 [1:27 PM]
А кто с такой ошибкой сталкивался?
Caused by: java.lang.ClassNotFoundException: com.sun.xml.internal.bind.v2.ContextFactory

qf05 [1:53 PM]
Вроде с этой ошибкой разобрался, это из-за 9 джавы ему нужны ещё com.sun.xml.bind зависимости...
но теперь вылазит такое : Caused by: java.lang.ClassNotFoundException: javax.activation.DataSource
причем ругается на entityManagerFactory:

Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'entityManagerFactory' defined in class path resource [spring/spring-db.xml]: Cannot create inner bean 'org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter#25b2cfcb' of type [org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter] while setting bean property 'jpaVendorAdapter'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter#25b2cfcb' defined in class path resource [spring/spring-db.xml]: Initialization of bean failed; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.config.internalCacheAdvisor': Cannot resolve reference to bean 'org.springframework.cache.annotation.AnnotationCacheOperationSource#0' while setting bean property 'cacheOperationSource'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.annotation.AnnotationCacheOperationSource#0': Initialization of bean failed; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.config.internalJCacheAdvisor': Cannot resolve reference to bean 'org.springframework.cache.jcache.interceptor.DefaultJCacheOperationSource#0' while setting bean property 'cacheOperationSource'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.jcache.interceptor.DefaultJCacheOperationSource#0': Cannot resolve reference to bean 'ehCacheManager' while setting bean property 'cacheManager'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'ehCacheManager' defined in class path resource [spring/spring-tools.xml]: Cannot create inner bean 'org.springframework.cache.jcache.JCacheManagerFactoryBean#58be6e8' of type [org.springframework.cache.jcache.JCacheManagerFactoryBean] while setting bean property 'cacheManager'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.jcache.JCacheManagerFactoryBean#58be6e8' defined in class path resource [spring/spring-tools.xml]: Invocation of init method failed; nested exception is java.lang.NoClassDefFoundError: javax/activation/DataSource

Вот что с эти делать?


qf05 [Today at 2:05 PM]
in #hw5
добавил ещё зависимость javax.activation, теперь тесты запускаются, но получаю пачку WARN сообщений, это нормально?


7 replies
Oleksii Leshchenko [1 hour ago]
а что за сообщения?


qf05 [1 hour ago]
WARNING: An illegal reflective access operation has occurred
WARNING: Illegal reflective access by com.sun.xml.bind.v2.runtime.reflect.opt.Injector (file:/C:/Users/Пользователь/.m2/repository/com/sun/xml/bind/jaxb-impl/2.3.0/jaxb-impl-2.3.0.jar) to method java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int)
WARNING: Please consider reporting this to the maintainers of com.sun.xml.bind.v2.runtime.reflect.opt.Injector
WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations
WARNING: All illegal access operations will be denied in a future release


Oleksii Leshchenko [1 hour ago]
не знаю. наверное не очень хорошо. скорее всего это относится к Java 9...


qf05 [1 hour ago]
у меня есть подозрение сто причина в пути к папке .m2 , но как её переместить в другое место незнаю(


Oleksii Leshchenko [1 hour ago]
В настройках Idea ищи по Maven


Oleksii Leshchenko [1 hour ago]
там будет или сама папка или конфиг файл, в котором прописана папка... не помню )


qf05 [1 hour ago]
ок, спасибо


qf05 [21 hours ago]
перемещение папки .m2 не помогло(


Vladimir Gorbatenko [Yesterday at 4:29 PM]
in #hw5
У всех в DataJpaMealRepositoryImpl так:
public Meal save(Meal Meal, int userId)
имя переменной написано с большой буквы?


1 reply
Oleksii Leshchenko [23 hours ago]
Да. Это ошибка....


Oleksii Leshchenko [Yesterday at 7:27 PM]
in #hw5
Это нормально, что DataJpaMealRepositoryImpl содержит 2 репозитория: CrudMealRepository и CrudUserRepository ?
CrudUserRepository - чтобы найти юзера перед созданием/сохранением еды....


1 reply
qf05 [19 hours ago]
Как раз тоже сижу над этим и думаю, наверное норм. Возможно ещё и DataUser.. надо будет второй интерфейс добавлять... что то не могу найти где у нас в проекте добавлен List с едой из 8 пункта подсказок, или его самим делать?
Но надо ещё подумать, не нравится мне такое решение...


qf05 [Yesterday at 8:05 PM]
in #hw5
Не пойму, что у нас должно не работать в JdbcMealRepositoryImpl для HSQLDB , у меня все тесты и так проходят. (edited)


1 reply
aleksey [14 hours ago]
Проверь точно, что у тебя все профили правильно настроены и включены.


qf05 [Yesterday at 8:20 PM]
in #hw5
на стаковерфлоу пишут:"HSQLDB 2.4.0 etc understand Java 8 Time API without any conversations", по этому вообще не понимаю 5-е задание.


2 replies
aleksey [12 hours ago]
У меня сначала была та же ситуация, все тесты проходились, и те же вопросы. Но мы используем 2.3.4 версию и она не поддерживает Time API, потом я перепроверил все настройки профилей. И ты еще проверь что в классе Profiles REPOSITORY_IMPLEMENTATION = JDBC


Tanya [7 hours ago]
*Цель задания - потренироваться с паттерном шаблонный метод и профилями Spring*


poleg [10:59 AM]
Так и не смог победить проблему с профилями...
Когда выбираю профиль hsqldb, запрос почему-то идет в initDB.sql вместо initDB_hsql.sql,  и тест валится.

  <beans profile="hsqldb">
       <context:property-placeholder location="classpath:db/hsqldb.properties" system-properties-mode="OVERRIDE"/>

       <!--no pooling-->
       <bean id="dataSource"
             class="org.springframework.jdbc.datasource.DriverManagerDataSource"
             p:driverClassName="org.hsqldb.jdbcDriver"
             p:url="${database.url}"
             p:username="${database.username}"
             p:password="${database.password}"/>
   </beans>

hsqldb.properties:
#database.url=jdbc:hsqldb:file:D:/temp/topjava
database.url=jdbc:hsqldb:mem:topjava

database.username=sa
database.password=

database.init=true

jdbc.initLocation=initDB_hsql.sql
jpa.showSql=true
hibernate.format_sql=true
hibernate.use_sql_comments=true

Ошибка:
org.springframework.jdbc.datasource.init.ScriptStatementFailedException: Failed to execute SQL script statement #5 of class path resource [db/initDB.sql]: CREATE SEQUENCE global_seq START 100000; nested exception is java.sql.SQLSyntaxErrorException: unexpected token: 100000 required: WITH

Если содержимое initDB_hsql.sql скопировать в initDB.sql, то тест конечно проходит. (edited)

Ilya [4 hours ago]
Глянь куда ты вставил -     <jdbc:script location=“classpath:db/${jdbc.initLocation}“/>
лучше оставить это вне профиля. насколько я понял, мы эти строки только ради hsqldb вставляли, т.к. каждый раз новая база создается в памяти.
ну и по стандарту - проверь, что все профили выбраны верно, запили clean и рефреш в мавене.


poleg [4 hours ago]
хм. у меня вот так:
<jdbc:script location="classpath:db/initDB.sql"/>
Код накатываю патчами.


Ilya [4 hours ago]
копипастни себе в конфигу спринга для БД - 

   <jdbc:initialize-database data-source=“dataSource” enabled=“${database.init}“>
   <jdbc:script location=“classpath:db/${jdbc.initLocation}“/>
   <jdbc:script encoding=“utf-8” location=“classpath:db/populateDB.sql”/>
   </jdbc:initialize-database>


poleg [4 hours ago]
Профили выбраны, рефрешил и клининил в разных комбинациях.


poleg [4 hours ago]
${jdbc.initLocation} - cannot resolve


Ilya [4 hours ago]
у тебя, судя по всему, статический прописан путь до скрипта для иницилизации БД. (edited)


Ilya [4 hours ago]
Это норм, не важно. Проверь


poleg [4 hours ago]
Да, так работает. Но странно - откуда взялся статический путь если код в мастере только патчами накатываю...


Ilya [4 hours ago]
ну хз, эта часть кода появилась еще на прошлом занятии, последним патчем. Может не накатил чего. У меня все ок было.


poleg [4 hours ago]
Ясно, спсб, теперь все ок


Oleksii Leshchenko [Today at 11:28 AM]
in #hw5
> Разделить реализации Repository по профилям Spring: jdbc, jpa, datajpa
Почему только профили Спринг? А профили Мавен не надо также сделать?


1 reply
Ilya [4 hours ago]
Я так понимаю, что тогда в POM надо отдельно указывать spring-data-jpa и все что он покрывает ( jdbc, orm). А это лишние буквы в POM и, наверное, не гуд практика)


Oleksii Leshchenko [1:06 PM]
shared this post 
How to activate Spring profiles
Last edited 2 hours ago
Правильно ли я понимаю, что профили Мавен и Спринг между собой никак не связаны?

И как активировать профили в Спринге? Я нашел несколько, но они больше годятся для DEV, а как лучше в случае деплоймента на Prod или если надо сбилдить на travis-ci?

Вот способы, что нашел:

1) spring.profiles.active свойство. Задается как опция, например из командной строки при запуске:

-Dspring.profiles.active=production

2) Через контекст во время инициализации:

ConfigurableEnvironment env = ctx.getEnvironment();   
env.setActiveProfiles("test1", "test2");
3) Аннотацией перед классом или методами:

@ActiveProfiles
@Profile
Collapse 
Oleksii Leshchenko [1:06 PM]
О профилях Спринга

tema.emelyan [1:11 PM]
при запуске мавена это разве не профиль мавена так задаётся? (edited)

Oleksii Leshchenko [1:11 PM]
да, мавена, точно. подправил в документе

tema.emelyan [1:14 PM]
@Profile не задаёт профиль, а указывает, что аннотированный компонент должен попасть в контекст если один из профилей активен (edited)
@ActiveProfiles задаёт активные профили, но только в тестах
Ещё можно активировать профили через web.xml и через переменную окружения и через JNDI 
вот здесь про это написано https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#beans-property-source-abstraction (edited)

Oleksii Leshchenko [1:25 PM]
> 3.1 сделать один базовый класс для MealServiceTest и UserServiceTest.
Имеется в виду по одному базовому классу для Мил и Юзер, т.е. по сути 2 класса. Или таки один общий для Мил и Юзер?


alexey [Today at 1:33 PM]
in #hw5
Народ подскажите как в save назначить user-а  новой еде?


5 replies
Oleksii Leshchenko [2 hours ago]
meal.setUser(crudUserRepository.findById(userId).get());


Oleksii Leshchenko [2 hours ago]
пришлось добавить crudUserRepository...


alexey [2 hours ago]
так можно было!?)) блин


Oleksii Leshchenko [2 hours ago]
возможно это не лучший вариант. потом посмотрим что скажут после проверки и когда будут ответы... )


alexey [2 hours ago]
спасибо


alexey [Today at 1:57 PM]
in #hw5
Кто нибудь может пояснить пункт 3: Сделать тесты всех реализаций (jdbc, jpa, datajpa) через наследование (без дублирования) , не пойму что хотят:thinking_face:


1 reply
Oleksii Leshchenko [1 hour ago]
Я так понял, что класс MealServiceTest должен стать базовым и не зависеть от имплементации jdbc/jpa/datajpa. Т.е. он не использует профилиспринга. А взамен создаются через наследование пустые классы, которые будут включать соответ. профиль....


Oleksii Leshchenko [2:03 PM]
Тут кстати описали, как запускать тесты несколько раз с различными профилями, использую параметризированные тесты. Но, имхо, слишком заумно, сложноватенько такое сделать...
http://forum.spring.io/forum/spring-projects/container/120249-runwith-parameterized-class-with-different-set-of-spring-profiles-per-parameter (edited)


qf05 [Today at 2:39 PM]
in #hw5
блин, как сломать JdbcMealRepositoryImpl для HSQLDB, что не делаю, а оно всё равно работает:sweat_smile:


2 replies
Oleksii Leshchenko [32 minutes ago]
Сделай clean и Reimport Maven projects перед запуском тестов


qf05 [10 minutes ago]
делал, не помогло.
нашел причину: оказывается мне почему то в классе Profiles метод getActiveDbProfile() всегда возвращает Postgres.


Artem Murk [Today at 2:42 PM]
in #hw5
Не пойму почему у меня не падает контекст в spring-db.xml прописаны 2 способа сканирования для datajpa.
    ```<context:component-scan base-package="ru.javawebinar.**.repository.datajpa"/>
    <jpa:repositories base-package="ru.javawebinar.**.repository.datajpa"/>```


3 replies
Oleksii Leshchenko [26 minutes ago]
я так понимаю это 2 разные инструкции.
*<context:component-scan* сканирует и обрабатывает для *Spring* аннотации типа @Component, @Service, @Repository...
*<jpa:repositories* - обрабатывает репозитории для *Spring Data Jpa*


Artem Murk [22 minutes ago]
Идея видит инициализацию нескольких бинов (edited)


Artem Murk [3 minutes ago]
@Oleksii Leshchenko уловил суть твоего ответа


Artem Murk [2:43 PM]
Или бины инициализируются один раз понимая что это одно и тоже? что то я  запутался

Artem Murk [2:53 PM]
uploaded this image: 2 бина 


Artem Murk [4:37 PM]
Можно ли как то сделать фильтр для метода findAll SpringData? Или придется обратно писать Query? Пробовал через findAll(Example example, Sort sort) но не могу понять как правильно обращаться. При попытке переопределить данный метод выкидывает странную ошибку
```.JpaRepository have the same erasure, yet neither overrides the other```
, подчеркивает красным весь метод, запутался в Дженериках. Помогите кто силен)

Oleksii Leshchenko [4:43 PM]
Можно. Вот хорошее руководство из линков к уроку :slightly_smiling_face:
https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods.query-creation

Artem Murk [4:57 PM]
@Oleksii Leshchenko да, там только создание Query, для Meal не вижу преимуществ в Spring Data:unamused:.

Oleksii Leshchenko [5:00 PM]
@Artem Murk неа, смотри там Table 4. Supported keywords inside method names.
Т.е. можно создать метод как в интерфейсе, без реализации вовсе. Т.е. просто правильно задать имя. Spring Data Jpa само распарсит имя и создаст имплементацию метода
Например, я в репозитории в классе написал:
   List<Meal> findByDateTimeBetweenAndUser_Id(LocalDateTime startDate, LocalDateTime endDate, Integer userId, Sort sort);
И не создавал реализацию метода - само все сделало и заработало

Artem Murk [5:02 PM]
Чудеса... Наверное слишком поверхностно просмотрел доки

Oleksii Leshchenko [5:02 PM]
Обрати внимание на ; в конце, нет реализации {}. А это класс, а не интерфейс

Artem Murk [5:04 PM]
Ок, почитаю внимательно доки, спасибо!!


aleksey [Today at 4:00 AM]
in #hw5
Кто подскажет, как в optional 7 сделал отдельные тесты так, чтобы они выполнялись только для jpadata а соответствующим assertThat ?


9 replies
Ilya [19 hours ago]
реализовать новый тест только в том классе, который ты делал для jpadata в 3-м пункте задания. По части assert - я отдельно сравнивал каждый тип сущности через соответствующий ассерт.


aleksey [19 hours ago]
Что значит каждый тип сущности через соответствующий assert?


Ilya [19 hours ago]
В проекте есть  MealTestData и UserTestData. Внутри них есть реализации assertThat - для еды и юзеров, соотвественно. 
Когда достаешь юзера и еду, то отдельно проверяешь его еду, отдельно юзера. В общем, внутри метода теста будет что-то такое:
 MealTestData.assertMatch(user.getMeals(),USER_WITH_MEALS.getMeals());
assertMatch(user,USER_WITH_MEALS); (edited)


aleksey [19 hours ago]
Это довольно спорная практика, как пишут.
https://softwareengineering.stackexchange.com/questions/7823/is-it-ok-to-have-multiple-asserts-in-a-single-unit-test
http://www.owenpellegrin.com/blog/testing/how-do-you-solve-multiple-asserts/
softwareengineering.stackexchange.com
Is it OK to have multiple asserts in a single unit test?
In the comment to this great post, Roy Osherove mentioned the OAPT project that is designed to run each assert in a single test. The following is written on the project's home page: Proper unit
 
(edited)


Ilya [19 hours ago]
это тема для холиваров. кому-как удобней. даже комментарии из приведенных топиков это подверждают. в нашем случае я париться не стал. 
а так, пожалуйста - никто не запрещает написать свой ассерт, чтобы проверял все и сразу. там делов на 2 минуты. я просто решил юзать, что есть.


aleksey [19 hours ago]
Ну вот я почитал холиваров, так у меня этот вопрос и возник.


Ilya [19 hours ago]
ну, опять же - если вчитаться, то они там говорят в первую очередь о том, что не должно быть такого, что ты в одном тесте делаешь кучу действий и проверяешь результаты каждого действия. в нашем случае действие одно. и ты проверяешь его по частям. так что я думаю. что это норм. увидим, какой будет подход у Григория.


Ilya [19 hours ago]
вот, самый ок коммент: Tests should fail for one reason only, but that doesn’t always mean that there should be only one Assert statement. IMHO it is more important to hold to the “Arrange, Act, Assert” pattern.

The key is that you have only one action, and then you inspect the results of that action using asserts. But it is “Arrange, Act, Assert, End of test”. If you are tempted to continue testing by performing another action and more asserts afterwards, make that a separate test instead.


aleksey [18 hours ago]
OK, принято :smiley:


Oleksii Leshchenko [11:36 AM]
А 7е задание делать через UserService или MealService?

eageev [12:05 PM]
Что-то я не понял. Зачем имплементировать репозитории? В этом и смысл Spring Data - в том, что не нужно писать имплементацию. Ни в одном проекте пока не видел, чтобы это делали.

Pavel Klindziuk [12:07 PM]
Чтобы у нас было понимание что скрывается в реализации спринг дата, и как это работает. Потренироваться в общем)

realcorwin [12:18 PM]
не, лучше б не путали :slightly_smiling_face:

eageev [12:22 PM]
Потренироваться может и хорошо. Но надо сразу учиться писать так, как пишут в реальных проектах.

Pavel Klindziuk [12:25 PM]
foundation is key to creativity, слыхал о таком ? ))

eageev [12:29 PM]
Кто то (кажется Флёнов) сказал: "Неправильное знание хуже не знания")

Pavel Klindziuk [12:30 PM]
а что же там неправильного в том что мы пишем имплементацию ?

eageev [12:31 PM]
абстрагирование от реальных проектов.

Pavel Klindziuk [12:31 PM]
это скорее  подготовка к ним

Oleksii Leshchenko [1:57 PM]
`mvn -P hsqldb test`
Мне теперь приходится запускать так тесты из под Мавена, если хочу hsqldb...

Pavel Klindziuk [1:58 PM]
а что с резолверами ?

Oleksii Leshchenko [2:02 PM]
не использую - не получилось одновременно использовать резолвер для БД и тесты для каждой реализации jdbc/jpa/datajpa. Иначе в @ActiveProfiles мне надо одновременно юзать profiles и resolver, а у меня так не работает

Oleksii Leshchenko [2:15 PM]
На эту домашку у меня ушло 2 полных дня, если кому интересно... 
Это еще без многочисленных правок после проверки... :slightly_smiling_face:

Jan [3:29 PM]
Спасибо. Будем расчитывать это время как эталонное ) (edited)
Oleksii Leshchenko
На эту домашку у меня ушло 2 полных дня, если кому интересно... 
Это еще без многочисленных правок после проверки... :slightly_smiling_face:
Posted in #hw5
Today at 2:15 PM

realcorwin [5:12 PM]
мы используем выражение SELECT m FROM Meal m WHERE m.user.id=:userId (edited)
а если бы SELECT m FROM Meal m WHERE m.user_id=:userId - что изменилось бы?

Viktor [5:14 PM]
а в чем разница?

realcorwin [5:14 PM]
m.user_id и m.user.id

Viktor [5:14 PM]
а вижу, такое стоит уточнять :smiley:
у meal нет поля user_id поэтому второй запрос упадет

realcorwin [5:16 PM]
действительно. User есть. в таблице user_id есть. а вот в Meal user_id нет
благодарю

Grigory Kislin [7:31 PM]
этож гораздо проще проверить чем вопрос задавать

realcorwin [1 day ago]
Да. Но на ходу всплыл вопрос :slightly_smiling_face:. Надо было не забыть :slightly_smiling_face:.


Ma3stro [Yesterday at 4:51 PM]
in #hw5
Нам ведь нельзя в CrudMealRepository менять аргументы методов?


1 reply
Ma3stro [1 day ago]
Менял названия методов и с этим структуру. Большинство  методов через @Query


Alexander Shnaider [Yesterday at 5:05 PM]
in #hw5
Друзья, помогите утопающему)  Накатил все патчи из урока, пытаюсь запустить тест `UserServiceTest` Вылетает ошибка 'Failed to load ApplicationContext'  причина `org.hibernate.HibernateException: Access to DialectResolutionInfo cannot be null when 'hibernate.dialect' not set`
Вот не пойму причём здесь hibernate, он же к JPA реализации относится, а сейчас должно было всё сконфигурироваться для DataJPA. В Maven выставил postges профайл, делал clean and reimport all maven projects. Что я делаю не так? (За исключением того что делаю всё в последний момент) (edited)


3 replies
Fedor [1 day ago]
<context:property-placeholder location="classpath:db/postgres.properties" system-properties-mode="OVERRIDE"/>


Fedor [1 day ago]
Раскомментил данную строку в spring-db.xml?


Alexander Shnaider [17 hours ago]
да, точно, ещё оказалось что у меня пароль базы другой, я как-то раньше и не замечал. Спасибо


realcorwin [Yesterday at 9:18 PM]
in #hw5
Странно. Пишет "No qualifying bean of type 'ru.javawebinar.topjava.repository.MealRepository' available". При этом вроде всё есть. spring-db.xml куда надо смотрит. Нужный класс репозиторий имплементирует. Аннотация стоит... Опять замыленным взглядом какую-то мелочь не вижу :slightly_smiling_face:.


2 replies
Fedor [24 hours ago]
У меня такая же ошибка, всю голову поломал


Fedor [24 hours ago]
WARN  o.s.context.support.AbstractApplicationContext.refresh:557 - Exception encountered during context initialization - cancelling refresh attempt: org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'mealServiceImpl' defined in file [D:\Internship\topjava\target\classes\ru\javawebinar\topjava\service\MealServiceImpl.class]: Unsatisfied dependency expressed through constructor parameter 0; nested exception is org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type 'ru.javawebinar.topjava.repository.MealRepository' available: expected at least 1 bean which qualifies as autowire candidate. Dependency annotations: {}


realcorwin [Yesterday at 9:33 PM]
in #hw5
Кто пробовал просто нагло конструировать методы в CrudMealRepository безо всяких Query? Работает? Вроде Meal findByIdAndUserId(Integer id, Integer userId);


1 reply
Ma3stro [9 hours ago]
Да, это работает. Только возвращаемое значение Optional<Meal>


Vitaly Ch [10:27 PM]
Кто-нибудь сталкивался с такой проблемой?org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter#73455391' defined in class path resource [spring/spring-db.xml]: Initialization of bean failed; nested exception is org.springframework.beans.TypeMismatchException: Failed to convert property value of type 'java.lang.String' to required type 'boolean' for property 'showSql'; nested exception is java.lang.IllegalArgumentException: Invalid boolean value [${jpa.showSql}]

Viktor [11:10 PM]
@Vitaly Ch java.lang.IllegalArgumentException: Invalid boolean value [${jpa.showSql}] - поправь значение

Vitaly Ch [11:20 PM]
В properties все нормально jpa.showSql=true
Viktor
@Vitaly Ch java.lang.IllegalArgumentException: Invalid boolean value [${jpa.showSql}] - поправь значение
Posted in #hw5
Yesterday at 11:10 PM

Viktor [12:20 AM]
а ошибка говори, что Invalid boolean value [${jpa.showSql}]
Failed to convert property value of type 'java.lang.String' to required type 'boolean' for property 'showSql'
покажи свой конфиг

Vitaly Ch [12:43 AM]
все как у всех
<property name="jpaVendorAdapter">
<bean class="org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter"
p:showSql="${jpa.showSql}">
</bean>
</property>
создал новый проект


Vitaly Ch [Today at 12:45 AM]
in #hw5
все та же проблема


1 reply
Pavel Zaitcev [22 hours ago]
В spring-db.xml разделение на профили сделал? А теперь в качестве эксперимента верни все как было (без разделения) и проверь, заработает ли.


Alexander Shnaider [Today at 11:01 AM]
in #hw5
Что-то не пойму как CrudMealRepository написать, у нас же везде требуется проверка по двум параметрам userId and id поэтому родительские крудовские методы не подходят. Я так понял все писали свои методы используя @Query аннотации с двумя входными параметрами userId и id? Не понимаю как написать метод save или его нужно разбить на два метода update и insert?


8 replies
Ilya [13 hours ago]
save можно реализовать на основе готовых getOne и save


Oleksii Leshchenko [13 hours ago]
Можно написать без @Query. Оно потом парсит имя и само делает имплементацию:
https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods.query-creation


Oleksii Leshchenko [13 hours ago]
Например,    
`List<Meal> findByDateTimeBetweenAndUser_Id(LocalDateTime startDate, LocalDateTime endDate, Integer userId, Sort sort);`

Alexander Shnaider [13 hours ago]
это я понял, уже видел твой пример. Значит можно все методы таким образом написать...


Alexander Shnaider [13 hours ago]
я просто думал, что он парсит только ключевое слово find, во всех примерах только оно


Oleksii Leshchenko [13 hours ago]
ДУмаю не все. Методы с FETCH JOIN писал через @Query


realcorwin [12 hours ago]
можно вообще Repository имплементить безо всяких методов


realcorwin [12 hours ago]
чтобы убрать Sort можешь писать так: findByDateTimeBetweenAndUserIdOrderByStartDateDesc


realcorwin [1:51 PM]
сделал в тестах @ActiveProfiles({Profiles.REPOSITORY_IMPLEMENTATION, Profiles.POSTGRES_DB}). Kак сделать оба профиля активным через resolver?

realcorwin [2:02 PM]
понял.
>>>@Override
   public String[] resolve(Class<?> aClass) {
return new String[]{Profiles.REPOSITORY_IMPLEMENTATION, Profiles.getActiveDbProfile()};
(edited)
что-то не получается у меня блоком кода сделать :disappointed: все кавычки уже перепробовал...

Ma3stro [2:31 PM]
replied to a thread:
Да, это работает. Только возвращаемое значение Optional<Meal>

Kirilo [2:42 PM]
@Alexander Shnaider не во всех методах @Query аннотации нужно использовать, там есть готовые уже, например, для save и update можно сделать похоже, как c jpa делали, а далее вызвать save у crudRepository вместо  persist и merge

Ma3stro [2:46 PM]
    ```<jdbc:initialize-database data-source="dataSource" enabled="${database.init}">
        <jdbc:script location="classpath:db/${jdbc.initLocation}"/>
        <jdbc:script encoding="utf-8" location="classpath:db/populateDB.sql"/>
    </jdbc:initialize-database>```
Эта часть ведь не только для jdbc используется?

alexey [2:59 PM]
Да,она общая
Ma3stro
    ```<jdbc:initialize-database data-source="dataSource" enabled="${database.init}">
        <jdbc:script location="classpath:db/${jdbc.initLocation}"/>
        <jdbc:script encoding="utf-8" location="classpath:db/populateDB.sql"/>
    </jdbc:initialize-database>```
Эта часть ведь не только для jdbc используется?
Posted in #hw5
Today at 2:46 PM

Ma3stro [3:22 PM]
В getActiveDbProfile у нас возвращается нужный профиль БД по названию класса драйвера.
Что можно сделать для getActiveRepositoryProfile?

Arthur [3:31 PM]
для репозитария подход другой. Для него у нас же нет понятия "драйвер"

realcorwin [7:42 PM]
Где и что надо поменять, чтобы профили datajpa/jpa/... правильно подхватились тестами?

Oleksii Leshchenko [7:48 PM]
в зависимсти от того, что указано в @ActiveProfiles

realcorwin [7:53 PM]
ну я выше написал, как я @ActiveProfiles сделал. но не работает: не находит апп контекст

realcorwin [8:02 PM]
что любопытно. оставляю spring_db.xml как есть. меняю только CrudMealRepository и DataJpaMealRepositoryImpl - и вылетают все тесты UserServiceTest. хотя по юзеру ведь ничего вообще не изменилось
может, на какую-то кнопку надо нажать, чтоб заапдейтилось всё в нужном месте? :slightly_smiling_face: так вроде нет...

Viktor [8:05 PM]
@realcorwin опиши свою реальную проблему, с чем падают тесты.

realcorwin [8:13 PM]
@Viktor постоянно вылетала такая хрень:
>>>Error creating bean with name 'mealServiceImpl' defined in file [D:\Internship\topjava\target\classes\ru\javawebinar\topjava\service\MealServiceImpl.class]: Unsatisfied dependency expressed through constructor parameter 0; nested exception is org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type 'ru.javawebinar.topjava.repository.MealRepository' available: expected at least 1 bean which qualifies as autowire candidate. Dependency annotations: {}

Сейчас я что-то таки изменил и стало вылетать другое.
>>>Caused by: org.springframework.data.mapping.PropertyReferenceException: No property save found for type Meal!
ну и всегда сверху
>java.lang.IllegalStateException: Failed to load ApplicationContext

Viktor [8:17 PM]
смотреть надо на верх самого нижнего исключения.
@realcorwin гугл спрашивал?

realcorwin [8:22 PM]
@Viktor да, его и смотрю. закомментил сейчас метод save в CrudMealRepository - все тесты юзера стали зелёными. Но хоть убей меня кто, если я понял, почему изменился стектрейс. Причём изменился он только тогда, когда я запустил его в очередной раз, чтобы для тебя скопировать :slightly_smiling_face: "Эффект демонстрации" (edited)

Viktor [8:23 PM]
покажи CrudMealRepository

realcorwin [8:23 PM]
@Viktor
>>>package ru.javawebinar.topjava.repository.datajpa;

import org.springframework.data.domain.Sort;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.transaction.annotation.Transactional;
import ru.javawebinar.topjava.model.Meal;

import java.time.LocalDateTime;
import java.util.List;

@Transactional(readOnly = true)
public interface CrudMealRepository extends JpaRepository<Meal, Integer> {

   //@Transactional
   //Meal save(Meal meal, int userId);

   @Transactional
   @Modifying
   @Query ("DELETE FROM Meal m WHERE m.id=:id AND m.user.id=:userId")
   boolean deleteByIdAndUserId(@Param("id") Integer id, @Param("userId") Integer userId);

   Meal findByIdAndUserId(Integer id, Integer userId);

   List<Meal> findByUserId(Integer userId, Sort sort);

   List<Meal> findByDateTimeBetweenAndUserId(LocalDateTime startDate, LocalDateTime endDate, Integer userId, Sort sort);
}
(edited)

Viktor [8:25 PM]
а как по твоему должен работать метод save? Ну что делать с entity он знает, а что делать с примитивом, который там появился?

realcorwin [8:26 PM]
что в save хрень, это понятно. но до save не доходило раньше :slightly_smiling_face:

Ma3stro [8:26 PM]
Наверное, если ты меняешь аргументы, то тебе нужно прописать Query или дополнить название метода. Можно сделать не меняя. (edited)
На подобии Jpa реализации

realcorwin [8:27 PM]
@Ma3stro скинь без Query
просто
@Override
Meal save(Meal item);
не?

Ma3stro [8:31 PM]
Именно так
Попробовал разными способами указать профили в MealServlet: `ConfigurableEnvironment env.setActiveProfiles()`, `AnnotationConfigApplicationContext context.getEnvironment().setActiveProfiles`, в web.xml через `spring.active.profiles`, но по прежнему вылетает `org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type 'ru.javawebinar.topjava.repository.MealRepository' available: expected at least 1 bean which qualifies as autowire candidate. Dependency annotations: {}`

realcorwin [8:33 PM]
вот-вот. подобная хрень у меня всё время вылетала

Ma3stro [8:34 PM]
В чём я ошибаюсь?

Anton Kiselev [8:36 PM]
самый простой вариант в arg tomcata вбить 
-Dspring.profiles.active="datajpa,postgres"

Viktor [8:36 PM]
@realcorwin думаю спринг проверяет запросы репозиториев

realcorwin [8:47 PM]
@Ma3stro помогло с томкатом?

Ma3stro [8:47 PM]
Да)

Alexander Shnaider [8:58 PM]
Ребят, а вот эта настройка `<tx:annotation-driven/>` к чему относиться?

realcorwin [8:59 PM]
ко всему

Alexander Shnaider [9:06 PM]
странно, я пихнул эту стоку только в профиль `jpa` и `datajpa` нормально работает без этой настройки


Viktor [Today at 9:16 PM]
in #hw5
@Alexander Shnaider вот почитай про <tx:annotation-driven/> http://bit.ly/2H5dSEf
google.gik-team.com
| Давай я поищу в Google вместо тебя
Давай я поищу в Google вместо тебя. Этот сайт создан для людей, которые считают, что лучше побеспокоить вас своими вопросами, нежели самим поискать ответ в Google. Давай я поищу в Гугл вместо тебя; Давай я поищу в Гугл за тебя; Давай я поищу в Google за тебя


5 replies
Alexander Shnaider [2 hours ago]
ну такой запрос я догадался сделать) Но что-то мне не очень понравились результаты сверху выдачи, не очень было понятно. У меня в принципе проблема с этими настройками XML...


Viktor [2 hours ago]
конкретизируй, что не понятно.


Alexander Shnaider [2 hours ago]
в принципе нашёл ответ на этот вопрос https://coderanch.com/t/520903/frameworks/Understanding-tx-annotation-driven-working
эта настройка нужна для восприятия аннотации `@Transactional`
coderanch.com
Understanding  working (Spring forum at Coderanch)
From what I understand, this annotation enabled spring to interpret @Transactional annotation. But what does it actually do underneath.
 


Alexander Shnaider [2 hours ago]
но в принципе у меня каша в голове по настройке spring xml. Я сделал так чтобы все профили работали методом научного тыка


Viktor [2 hours ago]
это нормально :smiley:


realcorwin [Today at 2:21 AM]
in #hw5
может, есть у кого "java persistence api и hibernate" на русском в pdf или mobi/epub?


3 replies
Pavel Zaitcev [20 hours ago]
Я заказал себе печатную версию. Неделю назад пришла. Не думаю что ты найдешь ее сейчас в электронном виде.


realcorwin [11 hours ago]
много где есть, но везде просят ввести номер мобильного. а мне стрёмно :slightly_smiling_face:. может попробовать тот, кто постоянно меняет карточки :slightly_smiling_face:


realcorwin [5 hours ago]
@Pavel Zaitcev а в напечатанной книжке нет ссылки на pdf? иногда изд-ва так делают


saudabaew [Today at 8:27 AM]
in #hw5
Коллеги, а кто-нибудь реализовал метод get() без использования "магии"? Имею ввиду не придумали название метода типа findByIdAndUserId, а стандартными средствами crudRepository. Суть в том, что у меня почему-то падает Meal meal = crudRepository.getOne(id); с ошибкой org.hibernate.LazyInitializationException: could not initialize proxy - no Session. Может кто-нибудь подсказать по этой проблеме?


3 replies
aleksey [14 hours ago]
Добавь transactional. getOne возвращает не запись, а референс


saudabaew [14 hours ago]
@aleksey спасибо!


Ilya [14 hours ago]
transactional на чтение не есть гуд практика, т.к. будет проводиться dirty checking, а он здесь не нужен


alexey [Today at 9:39 AM]
in #hw5
Кто сделал 7 пункт, подскажите пожалуйста. Получается для  выполнения 7.1 нам нужно только в User добавить поле с зависимостью, а в сервисе с репозиторием мы можем воспользоваться методом get(id) или нужно отдельный метод писать?


2 replies
Ilya [13 hours ago]
новый метод. иначе нужно ставить везде Eager, а это не круто


alexey [13 hours ago]
в репозитории к интерфейсу его добавлять или есть другой способ?


Zhivchik [3:17 PM]
added and commented on this Plain Text snippet: Untitled 
<jdbc:script location="classpath:db/${jdbc.initLocation}"/>   
После установки патчей в spring-db.xml  ${jdbc.initLocation}  выделено красным и при наведении курсора выдает: Cannot resolve file ${jdbc.initLocation}.  Это ошибка или так и должно быть?
realcorwin [3:25 PM]
тупит Идея

Arthur [3:25 PM]
проект запускается и работает?


Zhivchik [Today at 3:33 PM]
in #hw5
Тесты запускаються.  А вот при запуске проэкта в Tomcat : java.lang.IllegalArgumentException: Invalid boolean value [${jpa.showSql}]


2 replies
Ma3stro [6 hours ago]
Посмотри, правильно ли ты профили базы установил. Глянь метод getActiveDbProfiles в Profiles, там может броситься это исключение (edited)


Zhivchik [6 hours ago]
Профили вроде бы правильно - и в maven и в Change profile выставлены hsqldb. Метод тоже не изменен - такой же как в патче


Vladimir Gorbatenko [Today at 3:40 PM]
in #hw5
Скажите, а вот на вас лень не нападает? Я например с прошлого вторника смог только, накатить патчи и посмотреть что происходит, и затем видео посмотреть, и то не все. Ну и идею обновил до 18-ой. А вот как только собираюсь заняться домашкой, так тут же из ниоткуда появляется такой большой ВЛОООООООМ, и на этом все заканчивается.


10 replies
poleg [7 hours ago]
Порой нападает, но потом как в анекдоте - хомячок очень не любил пылесос, а потом ничего, внятулся!
Сейчас в отпуске в Эмиратах, в дневной сон ребенка как раз получается пару часов уделить проекту.


Vladimir Gorbatenko [7 hours ago]
я вообще не могу себя заставить


alexey [7 hours ago]
это весенний авитаминоз:grin:


Sergey [6 hours ago]
Да не говори, нападает. Но надо, надо совершать над собой насилие...


Yevhen Maksymovych [6 hours ago]
я вот только сегодня начал, обычно как-то сразу бросаюсь за дело, а тут на работе прямо реальная задачка подвернулась, а потом как-то напряжно было возвращаться к домашке


Oleksii Leshchenko [6 hours ago]
А я сижу дома без работы... Так что времени валом. )
Делаю все сразу


Vladimir Gorbatenko [6 hours ago]
я так себе подумал, что наверное домашкой надо с утра заниматься, пока голова не забита другими мыслями и идеями )


Vitaly M. [5 hours ago]
И я с вами )


Vitaly M. [5 hours ago]
Только сел за ДЗ... Правда не в Эмиратах...


poleg [3 hours ago]
Курю кальян, читаю теорию )


Yevhen Maksymovych [5:52 PM]
ребят, а кто как назначал профили в тестах? Там ведь надо указывать по меньшей мере два, один для бд, второй для репозитория. Но сейчас там все сделано через ActiveProfileResolver, не получится ведь одним параметром указать резолвер, а вторым - имя профиля репозитория

Arthur [5:58 PM]
я так пытался сделать, у меня не заработало так.
Пришлось переписать resolver таким образом, чтобы он сразу содержал в себе два прифиля (edited)

realcorwin [6:05 PM]
@Yevhen Maksymovych я сверху кидал, как переписать резольвер, чтобы всё заработало

Arthur [6:29 PM]
resolver переписывать не надо, нужно тест в моем случае иначе организовать
Тест у меня и сейчас в текущем варианте работает (edited)

dustnfox [7:25 PM]
Друзья, поможите кто чем может. Не работает у меня `getActiveDbProfile()` Вне зависимости от выбранного профиля Maven, метод где-то выкапывает класс `org.postgresql.Driver` и ожидаемо возвращает профиль `postgres`. Хотя не должен бы. После переключения профиля фазу `clean` запускал и реимпорт нажимал.

Arthur [8:23 PM]
попробуй для pom.xml диаграмму построить, будет там драйвер для postgres или нет... (edited)

realcorwin [8:37 PM]
@dustnfox даже если прописываешь в ключах maven другой профиль?

dustnfox [9:25 PM]
@Arthur @realcorwin Спасибо ребята за помощь! Посмотрел dependency diagram - да, действительно postgres торчит. Полез в pom.xml а там и профили и раздел с DataBase. Ума не приложу, как так получилось. Ни один патч не ругался при апплае.  Как он при этом умудрился добавить профили и при этом не убрать DB? Это же все в одном патче. Выпилил - теперь все работает.

Yevhen Maksymovych [10:10 PM]
да, дейсытно, не надо резольвер трогать, всё само собой разрешилось :slightly_smiling_face:


Oleg K [11:30 PM]
Подскажите, после патча 5_8 UserServiceTest должен работать? или надо что-то сделать?

Yevhen Maksymovych [11:33 PM]
должен работать

Oleg K [11:48 PM]
added this Plain Text snippet: Untitled 
23:41:14.802 ERROR o.springframework.test.context.TestContextManager.prepareTestInstance:246 - Caught exception while allowing TestExecutionListener [org.springframework.test.context.support.DependencyInjectionTestExecutionListener@7c137fd5] to prepare test instance [ru.javawebinar.topjava.service.UserServiceTest@42561fba]
java.lang.IllegalStateException: Failed to load ApplicationContext
  at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContext(DefaultCacheAwareContextLoaderDelegate.java:125)
  at org.springframework.test.context.support.DefaultTestContext.getApplicationContext(DefaultTestContext.java:107)
  at org.springframework.test.context.support.DependencyInjectionTestExecutionListener.injectDependencies(DependencyInjectionTestExecutionListener.java:117)
  at org.springframework.test.context.support.DependencyInjectionTestExecutionListener.prepareTestInstance(DependencyInjectionTestExecutionListener.java:83)
  at org.springframework.test.context.TestContextManager.prepareTestInstance(TestContextManager.java:242)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.createTest(SpringJUnit4ClassRunner.java:227)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner$1.runReflectiveCall(SpringJUnit4ClassRunner.java:289)
  at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.methodBlock(SpringJUnit4ClassRunner.java:291)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:246)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:97)
  at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)
  at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)
  at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)
  at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)
  at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)
  at org.springframework.test.context.junit4.statements.RunBeforeTestClassCallbacks.evaluate(RunBeforeTestClassCallbacks.java:61)
  at org.springframework.test.context.junit4.statements.RunAfterTestClassCallbacks.evaluate(RunAfterTestClassCallbacks.java:70)
  at org.junit.runners.ParentRunner.run(ParentRunner.java:363)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.run(SpringJUnit4ClassRunner.java:190)
  at org.junit.runner.JUnitCore.run(JUnitCore.java:137)
  at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:68)
  at com.intellij.rt.execution.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:47)
  at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:242)
  at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:70)
Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'entityManagerFactory' defined in class path resource [spring/spring-db.xml]: Cannot create inner bean 'org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter#77a98a6a' of type [org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter] while setting bean property 'jpaVendorAdapter'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter#77a98a6a' defined in class path resource [spring/spring-db.xml]: Initialization of bean failed; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.config.internalCacheAdvisor': Cannot resolve reference to bean 'org.springframework.cache.annotation.AnnotationCacheOperationSource#0' while setting bean property 'cacheOperationSource'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.annotation.AnnotationCacheOperationSource#0': Initialization of bean failed; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.config.internalJCacheAdvisor': Cannot resolve reference to bean 'org.springframework.cache.jcache.interceptor.DefaultJCacheOperationSource#0' while setting bean property 'cacheOperationSource'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.jcache.interceptor.DefaultJCacheOperationSource#0': Cannot resolve reference to bean 'ehCacheManager' while setting bean property 'cacheManager'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'ehCacheManager' defined in class path resource [spring/spring-tools.xml]: Cannot create inner bean 'org.springframework.cache.jcache.JCacheManagerFactoryBean#58326051' of type [org.springframework.cache.jcache.JCacheManagerFactoryBean] while setting bean property 'cacheManager'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.jcache.JCacheManagerFactoryBean#58326051' defined in class path resource [spring/spring-tools.xml]: Invocation of init method failed; nested exception is javax.cache.CacheException: org.ehcache.xml.exceptions.XmlConfigurationException: Error parsing XML configuration at file:/home/sebastian/my_java_projects/topjava/target/classes/cache/ehcache.xml
  at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveInnerBean(BeanDefinitionValueResolver.java:327)
  at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveValueIfNecessary(BeanDefinitionValueResolver.java:124)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.applyPropertyValues(AbstractAutowireCapableBeanFactory.java:1613)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.populateBean(AbstractAutowireCapableBeanFactory.java:1357)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:582)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:502)
  at org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:312)
  at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:228)
  at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:310)
  at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:200)
  at org.springframework.context.support.AbstractApplicationContext.getBean(AbstractApplicationContext.java:1085)
  at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:858)
  at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:549)
  at org.springframework.test.context.support.AbstractGenericContextLoader.loadContext(AbstractGenericContextLoader.java:128)
  at org.springframework.test.context.support.AbstractGenericContextLoader.loadContext(AbstractGenericContextLoader.java:60)
  at org.springframework.test.context.support.AbstractDelegatingSmartContextLoader.delegateLoading(AbstractDelegatingSmartContextLoader.java:107)
  at org.springframework.test.context.support.AbstractDelegatingSmartContextLoader.loadContext(AbstractDelegatingSmartContextLoader.java:243)
  at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContextInternal(DefaultCacheAwareContextLoaderDelegate.java:99)
  at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContext(DefaultCacheAwareContextLoaderDelegate.java:117)
  ... 24 common frames omitted
Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter#77a98a6a' defined in class path resource [spring/spring-db.xml]: Initialization of bean failed; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.config.internalCacheAdvisor': Cannot resolve reference to bean 'org.springframework.cache.annotation.AnnotationCacheOperationSource#0' while setting bean property 'cacheOperationSource'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.annotation.AnnotationCacheOperationSource#0': Initialization of bean failed; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.config.internalJCacheAdvisor': Cannot resolve reference to bean 'org.springframework.cache.jcache.interceptor.DefaultJCacheOperationSource#0' while setting bean property 'cacheOperationSource'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.jcache.interceptor.DefaultJCacheOperationSource#0': Cannot resolve reference to bean 'ehCacheManager' while setting bean property 'cacheManager'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'ehCacheManager' defined in class path resource [spring/spring-tools.xml]: Cannot create inner bean 'org.springframework.cache.jcache.JCacheManagerFactoryBean#58326051' of type [org.springframework.cache.jcache.JCacheManagerFactoryBean] while setting bean property 'cacheManager'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.jcache.JCacheManagerFactoryBean#58326051' defined in class path resource [spring/spring-tools.xml]: Invocation of init method failed; nested exception is javax.cache.CacheException: org.ehcache.xml.exceptions.XmlConfigurationException: Error parsing XML configuration at file:/home/sebastian/my_java_projects/topjava/target/classes/cache/ehcache.xml
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:591)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:502)
  at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveInnerBean(BeanDefinitionValueResolver.java:312)
  ... 42 common frames omitted
Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.config.internalCacheAdvisor': Cannot resolve reference to bean 'org.springframework.cache.annotation.AnnotationCacheOperationSource#0' while setting bean property 'cacheOperationSource'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.annotation.AnnotationCacheOperationSource#0': Initialization of bean failed; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.config.internalJCacheAdvisor': Cannot resolve reference to bean 'org.springframework.cache.jcache.interceptor.DefaultJCacheOperationSource#0' while setting bean property 'cacheOperationSource'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.jcache.interceptor.DefaultJCacheOperationSource#0': Cannot resolve reference to bean 'ehCacheManager' while setting bean property 'cacheManager'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'ehCacheManager' defined in class path resource [spring/spring-tools.xml]: Cannot create inner bean 'org.springframework.cache.jcache.JCacheManagerFactoryBean#58326051' of type [org.springframework.cache.jcache.JCacheManagerFactoryBean] while setting bean property 'cacheManager'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.jcache.JCacheManagerFactoryBean#58326051' defined in class path resource [spring/spring-tools.xml]: Invocation of init method failed; nested exception is javax.cache.CacheException: org.ehcache.xml.exceptio...
Collapse 
 This snippet was truncated for display; see it in full
Oleg K [11:48 PM]
Не хочет.


Viktor [Today at 12:34 AM]
in #hw5
@Oleg K "Caused by: java.lang.ClassNotFoundException: com.sun.xml.internal.bind.v2.ContextFactory" - скорее всего проблема в 9 java (edited)


1 reply
Oleg K [3 hours ago]
Да, так и есть, спасибо. Помогло добавление com.sun.xml.bind и javax.activation. Тесты проходят с предупреждениями. Наверное пора менять 9 на 8:grin:


Yevhen Maksymovych [Today at 7:55 AM]
in #hw5
а как проверить, что все обращения выполняются в рамках одной транзакции?


3 replies
Oleksii Leshchenko [2 hours ago]
Вроде в логах надо смотреть


Yevhen Maksymovych [2 hours ago]
ну, т.е. если сконструлился один hibernate-запрос, значит всё путём?


Oleksii Leshchenko [2 hours ago]
Скорее всего да. Я сам не смотрел, но задавал такой вопрос. Мне сказали смотреть в логах. 
И у меня в методе save() было 2 обращения к БД - для get и insert. Каждый в своей тарнзакции, что не правильно...


Oleg K [Today at 8:34 AM]
in #hw5
Кто-нибудь уже сдался и сменил 9 java?)


6 replies
Yevhen Maksymovych [2 hours ago]
я сменил на восьмёрку, надоели предупреждения о том, что всё, чем я пользуюсь, деприкэйтед, и скоро будет отключено


Vladimir Gorbatenko [2 hours ago]
неужели такие кардинальные изменения в 9 ???


Yevhen Maksymovych [2 hours ago]
ну хотя бы вот:
```Java 9 has deprecated java.xml.bind module and has removed it from the default classpath. That's why we get the class not found exception. The javax.xml.bind package is now a sub package of Module java.xml.bind.```


Yevhen Maksymovych [2 hours ago]
это, конечно, лечится добавлением зависимости


Yevhen Maksymovych [2 hours ago]
но постоянно вылезают другие глюки


Yevhen Maksymovych [2 hours ago]
тот же junit
```Java 9 is much more restrictive concerning reflective access to non-public fields/methods. For example setAccessible called by org.assertj.core.util.introspectionFieldUtils#readField on a private field fails with:

java.lang.reflect.InaccessibleObjectException: Unable to make field private transient long java.util.Date.fastTime accessible: module java.base does not "opens java.util" to unnamed module @66b72664
This means that assertj methods which use reflection on non-public fields/methods will fail/behave differently. For example the isEqualTo*Fields methods.```


alexey [Today at 9:37 AM]
in #hw5
Достаю в тестах еду с пользователем, у пользователя все поля кроме калорий и даты - null. Не пойму как получить остальное. Подскажите куда копать:face_with_rolling_eyes:


5 replies
Yevhen Maksymovych [2 hours ago]
а ты как достаёшь собственно юзера? если ручным назначением полей, то где-то ошибся в присваивании, если через join fetch, то такого быть не должно, все не-объектные поля должны примапиться (edited)


alexey [2 hours ago]
Вообще через cruduser getOne(id). Через join fetch это вручную запрос написать?


Yevhen Maksymovych [2 hours ago]
ага


alexey [1 hour ago]
Я так понимаю getOne(id) возращает мне proxy!?


Yevhen Maksymovych [21 minutes ago]
ага, findOne возвращает живую энтити, а getOne - референс


Yevhen Maksymovych [10:16 AM]
и ещё вопрос, почему для jpa-реализации нам достаточно указать
```<context:component-scan base-package="ru.javawebinar.**.repository.jpa"/>```
а для spring data нужно ещё
```<jpa:repositories base-package="ru.javawebinar.**.repository.datajpa"/>```


alexey [Today at 10:23 AM]
in #hw5
Было же в видео вроде. <jpa:repositories base-package="ru.javawebinar.**.repository.datajpa"/> ищет наследников от  Repository<T, ID>
Yevhen Maksymovych
и ещё вопрос, почему для jpa-реализации нам достаточно указать
```<context:component-scan base-package="ru.javawebinar.**.repository.jpa"/>```
а для spring data нужно ещё
```<jpa:repositories base-package="ru.javawebinar.**.repository.datajpa"/>```
Thread in #hw5Today at 10:16 AM
 


1 reply
Yevhen Maksymovych [1 hour ago]
спасибо!


Vitaly M. [10:47 AM]
Всем привет.
Я что-то сразу в тупик стал.
Настраиваю профиль jdbc...
У меня ошибка
```No qualifying bean of type 'ru.javawebinar.topjava.repository.MealRepository' available: expected at least 1 bean which qualifies as autowire candidate. Dependency annotations: {}```
Я не пойму, почему она выскакивает. Даже вопрос сформулировать не могу...


Vitaly M. [Today at 10:48 AM]
in #hw5
Ведь бин jdbcMealRepositoryImpl есть


5 replies
alexey [1 hour ago]
spring -db внимательнее смотри. видимо не убрал под профиль какой то скан


Grigory Kislin [1 hour ago]
смотри какой у тебя профиль в тестах и попадает ли в конфигурации в этом профиле jdbcMealRepositoryImpl


Vitaly M. [34 minutes ago]
В конфигурации:
```<beans profile="jdbc">
        <context:component-scan base-package="ru.javawebinar.**.repository.jdbc"/>

        <jdbc:initialize-database data-source="dataSource" enabled="${database.init}">
            <jdbc:script location="classpath:db/${jdbc.initLocation}"/>
            <jdbc:script encoding="utf-8" location="classpath:db/populateDB.sql"/>
        </jdbc:initialize-database>

        <bean id="jdbcTemplate"
              class="org.springframework.jdbc.core.JdbcTemplate">
        <constructor-arg ref="dataSource"/>
        </bean>

        <bean id="namedJdbcTemplate" class="org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate">
        <constructor-arg ref="dataSource"/>
        </bean>
    </beans>```
Да все убрал, и идея показывает слева иконку со стереотипами, где есть jdbcMealRepositoryImpl


Vitaly M. [29 minutes ago]
в логах теста видна такая строка:
```Skipped XML bean definition file due to specified profiles [jdbc] not matching: class path resource [spring/spring-db.xml]```


alexey [25 minutes ago]
инициализацию зачем в профиль ?