Grigory Kislin [2:51 PM]
joined #hw5.

Grigory Kislin [2:53 PM]
пятое занятие: заканчиваем с DB.
https://github.com/JavaWebinar/topjava/blob/doc/doc/lesson05.md
на следующем занятии 10.04 начинается web (edited)

tema.emelyan [2:55 PM]
joined #hw5 along with 18 others.

Arthur [10:43 PM]
Всем привет! 
Кто-нибудь уже смотрел новые темы и накатывал патчи?
Меня интересует: выбор spring профиля, а точнее говоря - как IDEA реагирует на выбор того или иного профиля? Есть ли какая-нибудь подсветка активного и неактивного профиля. 
Лично у меня IDEA никак в плане подсветки кода не реагирует на смену профиля.
(флажок в настройках выставлен) (edited)

Dmitry Neustupov [11:01 PM]
@Arthur
Аналогично, никакой реакции.

Arthur [11:01 PM]
ok

Andrew Manik [4:50 PM]
Для корректного отображения неактивного профиля в IDEA проверьте флаг Inactive profile highlighting и сделайте проекту clean
https://github.com/JavaWebinar/topjava/blob/doc/doc/lesson05.md
doc/lesson05.md
```
# Онлайн проект <a href="https://github.com/JavaWebinar/topjava">Topjava</a>

## <a href="https://drive.google.com/drive/folders/0B9Ye2auQ_NsFfmctT3oyNW1qaVhDb2p0bGpyTFVlaUJ2VVpOdVgtWF9KTUFBMWFaR2xVYVE">Материалы занятия</a>
### ![error](https://cloud.githubusercontent.com/assets/13649199/13672935/ef09ec1e-e6e7-11e5-9f79-d1641c05cbe6.png) Правки в проекте

#### Apply 5_0_fix.patch
> Удалил из зависимостей commons-logging: [Spring Framework 5.0 comes with its own Commons Logging bridge](https://github.com/spring-projects/spring-framework/wiki/What's-New-in-Spring-Framework-5.x#general-core-revision)

## ![hw](https://cloud.githubusercontent.com/assets/13649199/13672719/09593… Show more

JavaWebinar/topjava
Added by GitHub


saudabaew [9:35 AM]
кто понял о чем патч 5_2_fix_hibernate_issue?

Vladimir Gorbatenko [11:25 AM]
Накатил все патчи с изучением того что происходит, всквозную прочел статьи в описании патчей... Это же капец, у нас получается калькулятор с использованием нанотехнологий. Надо еще видео посмотреть. Афигеть какой огромный объем информации, это же как все запоминать??? Читаешь статьи и прозреваешь сколько всего люди знают...

tema.emelyan [11:31 AM]
недавно прочитал прикольную фразу: когда читаешь статьи в интернете, важно помнить, что не все они написаны одним человеком :smiley:

Oleksii Leshchenko [11:31 AM]
Все сразу читать не обязательно

tema.emelyan [11:31 AM]
по-моему очень точно в тему импостер синдрома

Vladimir Gorbatenko [11:48 AM]
Вот это (Самый быстрый пул соединений на java (читаем комменты)) особенно понравилось, прочел начало статьи и пошел читать комменты, где развели дикий срачь про хикари это таки быстро и не может этого быть ))
https://habrahabr.ru/post/269023/ (edited)


poleg [Today at 12:55 PM]
in #hw5
Для переключения на HSQLDB необходимо:
поменять в окне Maven Projects профиль (Profiles) на hsqldb и сделать Reimport All Maven Projects (1я кнопка)
поменять Profiles.ACTIVE_DB = HSQLDB
почистить проект mvn clean (фаза clean не выполняется автоматически, чтобы каждый раз не перекомпилировать весь проект)

Все сделал, тесты валятся с ошибкой
java.lang.IllegalStateException: Failed to load ApplicationContext at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContext(DefaultCacheAwareContextLoaderDelegate.java:125)

При переключении на постгрес все ок. Что я делаю не так?


1 reply
Oleksii Leshchenko [2 hours ago]
А можно полное сообщение об ошибке, весь стэк?


poleg [1:00 PM]
added this Plain Text snippet: Untitled 
12:59:25.462 ERROR o.springframework.test.context.TestContextManager.prepareTestInstance:246 - Caught exception while allowing TestExecutionListener [org.springframework.test.context.support.DependencyInjectionTestExecutionListener@543e710e] to prepare test instance [ru.javawebinar.topjava.service.MealServiceTest@4b200971]
java.lang.IllegalStateException: Failed to load ApplicationContext
  at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContext(DefaultCacheAwareContextLoaderDelegate.java:125)
  at org.springframework.test.context.support.DefaultTestContext.getApplicationContext(DefaultTestContext.java:107)
  at org.springframework.test.context.support.DependencyInjectionTestExecutionListener.injectDependencies(DependencyInjectionTestExecutionListener.java:117)
  at org.springframework.test.context.support.DependencyInjectionTestExecutionListener.prepareTestInstance(DependencyInjectionTestExecutionListener.java:83)
  at org.springframework.test.context.TestContextManager.prepareTestInstance(TestContextManager.java:242)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.createTest(SpringJUnit4ClassRunner.java:227)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner$1.runReflectiveCall(SpringJUnit4ClassRunner.java:289)
  at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.methodBlock(SpringJUnit4ClassRunner.java:291)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:246)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:97)
  at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)
  at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)
  at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)
  at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)
  at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)
  at org.springframework.test.context.junit4.statements.RunBeforeTestClassCallbacks.evaluate(RunBeforeTestClassCallbacks.java:61)
  at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
  at org.springframework.test.context.junit4.statements.RunAfterTestClassCallbacks.evaluate(RunAfterTestClassCallbacks.java:70)
  at org.junit.runners.ParentRunner.run(ParentRunner.java:363)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.run(SpringJUnit4ClassRunner.java:190)
  at org.junit.runner.JUnitCore.run(JUnitCore.java:137)
  at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:68)
  at com.intellij.rt.execution.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:47)
  at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:242)
  at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:70)
Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.jdbc.datasource.init.DataSourceInitializer#0': Invocation of init method failed; nested exception is org.springframework.jdbc.datasource.init.ScriptStatementFailedException: Failed to execute SQL script statement #5 of class path resource [db/initDB.sql]: CREATE SEQUENCE global_seq START 100000; nested exception is java.sql.SQLSyntaxErrorException: unexpected token: 100000 required: WITH
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1710)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:583)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:502)
  at org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:312)
  at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:228)
  at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:310)
  at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:200)
  at org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:760)
  at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:868)
  at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:549)
  at org.springframework.test.context.support.AbstractGenericContextLoader.loadContext(AbstractGenericContextLoader.java:128)
  at org.springframework.test.context.support.AbstractGenericContextLoader.loadContext(AbstractGenericContextLoader.java:60)
  at org.springframework.test.context.support.AbstractDelegatingSmartContextLoader.delegateLoading(AbstractDelegatingSmartContextLoader.java:107)
  at org.springframework.test.context.support.AbstractDelegatingSmartContextLoader.loadContext(AbstractDelegatingSmartContextLoader.java:243)
  at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContextInternal(DefaultCacheAwareContextLoaderDelegate.java:99)
  at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContext(DefaultCacheAwareContextLoaderDelegate.java:117)
  ... 25 common frames omitted
Caused by: org.springframework.jdbc.datasource.init.ScriptStatementFailedException: Failed to execute SQL script statement #5 of class path resource [db/initDB.sql]: CREATE SEQUENCE global_seq START 100000; nested exception is java.sql.SQLSyntaxErrorException: unexpected token: 100000 required: WITH
  at org.springframework.jdbc.datasource.init.ScriptUtils.executeSqlScript(ScriptUtils.java:492)
  at org.springframework.jdbc.datasource.init.ResourceDatabasePopulator.populate(ResourceDatabasePopulator.java:240)
  at org.springframework.jdbc.datasource.init.CompositeDatabasePopulator.populate(CompositeDatabasePopulator.java:87)
  at org.springframework.jdbc.datasource.init.DatabasePopulatorUtils.execute(DatabasePopulatorUtils.java:48)
  at org.springframework.jdbc.datasource.init.DataSourceInitializer.execute(DataSourceInitializer.java:111)
  at org.springframework.jdbc.datasource.init.DataSourceInitializer.afterPropertiesSet(DataSourceInitializer.java:96)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeInitMethods(AbstractAutowireCapableBeanFactory.java:1769)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1706)
  ... 40 common frames omitted
Caused by: java.sql.SQLSyntaxErrorException: unexpected token: 100000 required: WITH
  at org.hsqldb.jdbc.JDBCUtil.sqlException(Unknown Source)
  at org.hsqldb.jdbc.JDBCUtil.sqlException(Unknown Source)
  at org.hsqldb.jdbc.JDBCStatement.fetchResult(Unknown Source)
  at org.hsqldb.jdbc.JDBCStatement.execute(Unknown Source)
  at org.springframework.jdbc.datasource.init.ScriptUtils.executeSqlScript(ScriptUtils.java:471)
  ... 47 common frames omitted
Caused by: org.hsqldb.HsqlException: unexpected token: 100000 required: WITH
  at org.hsqldb.error.Error.parseError(Unknown Source)
  at org.hsqldb.ParserBase.unexpectedTokenRequire(Unknown Source)
  at org.hsqldb.ParserBase.readThis(Unknown Source)
  at org.hsqldb.ParserTable.readSequenceOptions(Unknown Source)
  at org.hsqldb.ParserDDL.compileCreateSequence(Unknown Source)
  at org.hsqldb.ParserDDL.compileCreate(Unknown Source)
  at org.hsqldb.ParserCommand.compilePart(Unknown Source)
  at org.hsqldb.ParserCommand.compileStatements(Unknown Source)
  at org.hsqldb.Session.executeDirectStatement(Unknown Source)
  at org.hsqldb.Session.execute(Unknown Source)
  ... 50 common frames omitted
java.lang.IllegalStateException: Failed to load ApplicationContext
  at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContext(DefaultCacheAwareContextLoaderDelegate.java:125)
  at org.springframework.test.context.support.DefaultTestContext.getApplicationContext(DefaultTestContext.java:107)
  at org.springframework.test.context.support.DependencyInjectionTestExecutionListener.injectDependencies(DependencyInjectionTestExecutionListener.java:117)
  at org.springframework.test.context.support.DependencyInjectionTestExecutionListener.prepareTestInstance(DependencyInjectionTestExecutionListener.java:83)
  at org.springframework.test.context.TestContextManager.prepareTestInstance(TestContextManager.java:242)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.createTest(SpringJUnit4ClassRunner.java:227)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner$1.runReflectiveCall(SpringJUnit4ClassRunner.java:289)
  at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.methodBlock(SpringJUnit4ClassRunner.java:291)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:246)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:97)
  at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)
  at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)
  at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)
  at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)
  at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)
  at org.springframework.test.context.junit4.statements.RunBeforeTestClassCallbacks.evaluate(RunBeforeTestClassCallbacks.java:61)
  at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
  at org.springframework.test.context.junit4.statements.RunAfterTestClassCallbacks.evaluate(RunAfterTestClassCallbacks.java:70)
  at org.junit.runners.ParentRunner.run(ParentRunner.java:363)
  at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.run(SpringJUnit4ClassRunner.java:190)
  at org.junit.runner.JUnitCore.run(JUnitCore.java:137)
  at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:68)
  at com.intellij.rt.execution.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:47)
  at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:242)
  at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:70)
Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.jdbc.datasource.init.DataSourceInitializer#0': Invocation of init method failed; nested exception is org.springframework.jdbc.datasource.init.ScriptStatementFailedException: Failed to execute SQL script statement #5 of class path resource [db/initDB.sql]: CREATE SEQUENCE global_seq START 100000; nested exception is java.sql.SQLSyntaxErrorException: unexpected token: 100000 required: WITH
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1710)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:583)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:502)
  at org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:312)
  at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:228)
  at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:310)
  at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:200)
  at org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:760)
  at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:868)
  at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:549)
  at org.springframework.test.context.support.AbstractGenericContextLoader.loadContext(AbstractGenericContextLoader.java:128)
  at org.springframework.test.context.support.AbstractGenericContextLoader.loadContext(AbstractGenericContextLoader.java:60)
  at org.springframework.test.context.support.AbstractDelegatingSmartContextLoader.delegateLoading(AbstractDelegatingSmartContextLoader.java:107)
  at org.springframework.test.context.support.AbstractDelegatingSmartContextLoader.loadContext(AbstractDelegatingSmartContextLoader.java:243)
  at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContextInternal(DefaultCacheAwareContextLoaderDelegate.java:99)
  at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContext(DefaultCacheAwareContextLoaderDelegate.java:117)
  ... 25 more
Caused by: org.springframework.jdbc.datasource.init.ScriptStatementFailedException: Failed to execute SQL script statement #5 of class path resource [db/initDB.sql]: CREATE SEQUENCE global_seq START 100000; nested exception is java.sql.SQLSyntaxErrorException: unexpected token: 100000 required: WITH
  at org.springframework.jdbc.datasource.init.ScriptUtils.executeSqlScript(ScriptUtils.java:492)
  at org.springframework.jdbc.datasource.init.ResourceDatabasePopulator.populate(ResourceDatabasePopulator.java:240)
  at org.springframework.jdbc.datasource.init.CompositeDatabasePopulator.populate(CompositeDatabasePopulator.java:87)
  at org.springframework.jdbc.datasource.init.DatabasePopulatorUtils.execute(DatabasePopulatorUtils.java:48)
  at org.springframework.jdbc.datasource.init.DataSourceInitializer.execute(DataSourceInitializer.java:111)
  at org.springframework.jdbc.datasource.init.DataSourceInitializer.afterPropertiesSet(DataSourceInitializer.java:96)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeInitMethods(AbstractAutowireCapableBeanFactory.java:1769)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1706)
  ... 40 more
Caused by: java.sql.SQLSyntaxErrorException: unexpected token: 100000 required: WITH
  at org.hsqldb.jdbc.JDBCUtil.sqlException(Unknown Source)
  at org.hsqldb.jdbc.JDBCUtil.sqlException(Unknown Source)
  at org.hsqldb.jdbc.JDBCStatement.fetchResult(Unknown Source)
  at org.hsqldb.jdbc.JDBCStatement.execute(Unknown Source)
  at org.springframework.jdbc.datasource.init.ScriptUtils.executeSqlScript(ScriptUtils.java:471)
  ... 47 more
Caused by: org.hsqldb.HsqlException: unexpected token: 100000 required: WITH
  at org.hsqldb.error.Error.parseError(Unknown Source)
  at org.hsqldb.ParserBase.unexpectedTokenRequire(Unknown Source)
  at org.hsqldb.ParserBase.readThis(Unknown Source)
  at org.hsqldb.ParserTable.readSequenceOptions(Unknown Source)
  at org.hsqldb.ParserDDL.compileCreateSequence(Unknown Source)
  at org.hsqldb.ParserDDL.compileCreate(Unknown Source)
  at org.hsqldb.ParserCommand.compilePart(Unknown Source)
  at org.hsqldb.ParserCommand.compileStatements(Unknown Source)
  at org.hsqldb.Session.executeDirectStatement(Unknown Source)
  at org.hsqldb.Session.execute(Unknown Source)
  ... 50 more
Collapse 
 This snippet was truncated for display; see it in full
poleg [1:02 PM]
Хм ругается на java.sql.SQLSyntaxErrorException: unexpected token: 100000 required: WITH


Oleksii Leshchenko [1:06 PM]
Оно пытается применить db/initDB.sql. Там для HSQLDB был другой скрипт


poleg [Today at 1:07 PM]
in #hw5
Так я ж ничего не менял. Я тоже вижу теперь что он initDB.sql берет вместо initDB_hsql.sql


2 replies
Oleksii Leshchenko [2 hours ago]
Попробуй clean и Reimport maven projects поменять местами. Т.е. вначале сделать clean


poleg [2 hours ago]
Уже. В разных комбинациях. Все равно ошибка. (edited)


poleg [1:08 PM]
Но:
   <beans profile="hsqldb">
       <context:property-placeholder location="classpath:db/hsqldb.properties" system-properties-mode="OVERRIDE"/>
А в hsqldb.properties:
jdbc.initLocation=initDB_hsql.sql

qf05 [1:27 PM]
А кто с такой ошибкой сталкивался?
Caused by: java.lang.ClassNotFoundException: com.sun.xml.internal.bind.v2.ContextFactory

qf05 [1:53 PM]
Вроде с этой ошибкой разобрался, это из-за 9 джавы ему нужны ещё com.sun.xml.bind зависимости...
но теперь вылазит такое : Caused by: java.lang.ClassNotFoundException: javax.activation.DataSource
причем ругается на entityManagerFactory:

Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'entityManagerFactory' defined in class path resource [spring/spring-db.xml]: Cannot create inner bean 'org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter#25b2cfcb' of type [org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter] while setting bean property 'jpaVendorAdapter'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter#25b2cfcb' defined in class path resource [spring/spring-db.xml]: Initialization of bean failed; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.config.internalCacheAdvisor': Cannot resolve reference to bean 'org.springframework.cache.annotation.AnnotationCacheOperationSource#0' while setting bean property 'cacheOperationSource'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.annotation.AnnotationCacheOperationSource#0': Initialization of bean failed; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.config.internalJCacheAdvisor': Cannot resolve reference to bean 'org.springframework.cache.jcache.interceptor.DefaultJCacheOperationSource#0' while setting bean property 'cacheOperationSource'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.jcache.interceptor.DefaultJCacheOperationSource#0': Cannot resolve reference to bean 'ehCacheManager' while setting bean property 'cacheManager'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'ehCacheManager' defined in class path resource [spring/spring-tools.xml]: Cannot create inner bean 'org.springframework.cache.jcache.JCacheManagerFactoryBean#58be6e8' of type [org.springframework.cache.jcache.JCacheManagerFactoryBean] while setting bean property 'cacheManager'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.jcache.JCacheManagerFactoryBean#58be6e8' defined in class path resource [spring/spring-tools.xml]: Invocation of init method failed; nested exception is java.lang.NoClassDefFoundError: javax/activation/DataSource

Вот что с эти делать?


qf05 [Today at 2:05 PM]
in #hw5
добавил ещё зависимость javax.activation, теперь тесты запускаются, но получаю пачку WARN сообщений, это нормально?


7 replies
Oleksii Leshchenko [1 hour ago]
а что за сообщения?


qf05 [1 hour ago]
WARNING: An illegal reflective access operation has occurred
WARNING: Illegal reflective access by com.sun.xml.bind.v2.runtime.reflect.opt.Injector (file:/C:/Users/Пользователь/.m2/repository/com/sun/xml/bind/jaxb-impl/2.3.0/jaxb-impl-2.3.0.jar) to method java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int)
WARNING: Please consider reporting this to the maintainers of com.sun.xml.bind.v2.runtime.reflect.opt.Injector
WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations
WARNING: All illegal access operations will be denied in a future release


Oleksii Leshchenko [1 hour ago]
не знаю. наверное не очень хорошо. скорее всего это относится к Java 9...


qf05 [1 hour ago]
у меня есть подозрение сто причина в пути к папке .m2 , но как её переместить в другое место незнаю(


Oleksii Leshchenko [1 hour ago]
В настройках Idea ищи по Maven


Oleksii Leshchenko [1 hour ago]
там будет или сама папка или конфиг файл, в котором прописана папка... не помню )


qf05 [1 hour ago]
ок, спасибо


qf05 [21 hours ago]
перемещение папки .m2 не помогло(


Vladimir Gorbatenko [Yesterday at 4:29 PM]
in #hw5
У всех в DataJpaMealRepositoryImpl так:
public Meal save(Meal Meal, int userId)
имя переменной написано с большой буквы?


1 reply
Oleksii Leshchenko [23 hours ago]
Да. Это ошибка....


Oleksii Leshchenko [Yesterday at 7:27 PM]
in #hw5
Это нормально, что DataJpaMealRepositoryImpl содержит 2 репозитория: CrudMealRepository и CrudUserRepository ?
CrudUserRepository - чтобы найти юзера перед созданием/сохранением еды....


1 reply
qf05 [19 hours ago]
Как раз тоже сижу над этим и думаю, наверное норм. Возможно ещё и DataUser.. надо будет второй интерфейс добавлять... что то не могу найти где у нас в проекте добавлен List с едой из 8 пункта подсказок, или его самим делать?
Но надо ещё подумать, не нравится мне такое решение...


qf05 [Yesterday at 8:05 PM]
in #hw5
Не пойму, что у нас должно не работать в JdbcMealRepositoryImpl для HSQLDB , у меня все тесты и так проходят. (edited)


1 reply
aleksey [14 hours ago]
Проверь точно, что у тебя все профили правильно настроены и включены.


qf05 [Yesterday at 8:20 PM]
in #hw5
на стаковерфлоу пишут:"HSQLDB 2.4.0 etc understand Java 8 Time API without any conversations", по этому вообще не понимаю 5-е задание.


2 replies
aleksey [12 hours ago]
У меня сначала была та же ситуация, все тесты проходились, и те же вопросы. Но мы используем 2.3.4 версию и она не поддерживает Time API, потом я перепроверил все настройки профилей. И ты еще проверь что в классе Profiles REPOSITORY_IMPLEMENTATION = JDBC


Tanya [7 hours ago]
*Цель задания - потренироваться с паттерном шаблонный метод и профилями Spring*


poleg [10:59 AM]
Так и не смог победить проблему с профилями...
Когда выбираю профиль hsqldb, запрос почему-то идет в initDB.sql вместо initDB_hsql.sql,  и тест валится.

  <beans profile="hsqldb">
       <context:property-placeholder location="classpath:db/hsqldb.properties" system-properties-mode="OVERRIDE"/>

       <!--no pooling-->
       <bean id="dataSource"
             class="org.springframework.jdbc.datasource.DriverManagerDataSource"
             p:driverClassName="org.hsqldb.jdbcDriver"
             p:url="${database.url}"
             p:username="${database.username}"
             p:password="${database.password}"/>
   </beans>

hsqldb.properties:
#database.url=jdbc:hsqldb:file:D:/temp/topjava
database.url=jdbc:hsqldb:mem:topjava

database.username=sa
database.password=

database.init=true

jdbc.initLocation=initDB_hsql.sql
jpa.showSql=true
hibernate.format_sql=true
hibernate.use_sql_comments=true

Ошибка:
org.springframework.jdbc.datasource.init.ScriptStatementFailedException: Failed to execute SQL script statement #5 of class path resource [db/initDB.sql]: CREATE SEQUENCE global_seq START 100000; nested exception is java.sql.SQLSyntaxErrorException: unexpected token: 100000 required: WITH

Если содержимое initDB_hsql.sql скопировать в initDB.sql, то тест конечно проходит. (edited)

Ilya [4 hours ago]
Глянь куда ты вставил -     <jdbc:script location=“classpath:db/${jdbc.initLocation}“/>
лучше оставить это вне профиля. насколько я понял, мы эти строки только ради hsqldb вставляли, т.к. каждый раз новая база создается в памяти.
ну и по стандарту - проверь, что все профили выбраны верно, запили clean и рефреш в мавене.


poleg [4 hours ago]
хм. у меня вот так:
<jdbc:script location="classpath:db/initDB.sql"/>
Код накатываю патчами.


Ilya [4 hours ago]
копипастни себе в конфигу спринга для БД - 

   <jdbc:initialize-database data-source=“dataSource” enabled=“${database.init}“>
   <jdbc:script location=“classpath:db/${jdbc.initLocation}“/>
   <jdbc:script encoding=“utf-8” location=“classpath:db/populateDB.sql”/>
   </jdbc:initialize-database>


poleg [4 hours ago]
Профили выбраны, рефрешил и клининил в разных комбинациях.


poleg [4 hours ago]
${jdbc.initLocation} - cannot resolve


Ilya [4 hours ago]
у тебя, судя по всему, статический прописан путь до скрипта для иницилизации БД. (edited)


Ilya [4 hours ago]
Это норм, не важно. Проверь


poleg [4 hours ago]
Да, так работает. Но странно - откуда взялся статический путь если код в мастере только патчами накатываю...


Ilya [4 hours ago]
ну хз, эта часть кода появилась еще на прошлом занятии, последним патчем. Может не накатил чего. У меня все ок было.


poleg [4 hours ago]
Ясно, спсб, теперь все ок


Oleksii Leshchenko [Today at 11:28 AM]
in #hw5
> Разделить реализации Repository по профилям Spring: jdbc, jpa, datajpa
Почему только профили Спринг? А профили Мавен не надо также сделать?


1 reply
Ilya [4 hours ago]
Я так понимаю, что тогда в POM надо отдельно указывать spring-data-jpa и все что он покрывает ( jdbc, orm). А это лишние буквы в POM и, наверное, не гуд практика)


Oleksii Leshchenko [1:06 PM]
shared this post 
How to activate Spring profiles
Last edited 2 hours ago
Правильно ли я понимаю, что профили Мавен и Спринг между собой никак не связаны?

И как активировать профили в Спринге? Я нашел несколько, но они больше годятся для DEV, а как лучше в случае деплоймента на Prod или если надо сбилдить на travis-ci?

Вот способы, что нашел:

1) spring.profiles.active свойство. Задается как опция, например из командной строки при запуске:

-Dspring.profiles.active=production

2) Через контекст во время инициализации:

ConfigurableEnvironment env = ctx.getEnvironment();   
env.setActiveProfiles("test1", "test2");
3) Аннотацией перед классом или методами:

@ActiveProfiles
@Profile
Collapse 
Oleksii Leshchenko [1:06 PM]
О профилях Спринга

tema.emelyan [1:11 PM]
при запуске мавена это разве не профиль мавена так задаётся? (edited)

Oleksii Leshchenko [1:11 PM]
да, мавена, точно. подправил в документе

tema.emelyan [1:14 PM]
@Profile не задаёт профиль, а указывает, что аннотированный компонент должен попасть в контекст если один из профилей активен (edited)
@ActiveProfiles задаёт активные профили, но только в тестах
Ещё можно активировать профили через web.xml и через переменную окружения и через JNDI 
вот здесь про это написано https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#beans-property-source-abstraction (edited)

Oleksii Leshchenko [1:25 PM]
> 3.1 сделать один базовый класс для MealServiceTest и UserServiceTest.
Имеется в виду по одному базовому классу для Мил и Юзер, т.е. по сути 2 класса. Или таки один общий для Мил и Юзер?


alexey [Today at 1:33 PM]
in #hw5
Народ подскажите как в save назначить user-а  новой еде?


5 replies
Oleksii Leshchenko [2 hours ago]
meal.setUser(crudUserRepository.findById(userId).get());


Oleksii Leshchenko [2 hours ago]
пришлось добавить crudUserRepository...


alexey [2 hours ago]
так можно было!?)) блин


Oleksii Leshchenko [2 hours ago]
возможно это не лучший вариант. потом посмотрим что скажут после проверки и когда будут ответы... )


alexey [2 hours ago]
спасибо


alexey [Today at 1:57 PM]
in #hw5
Кто нибудь может пояснить пункт 3: Сделать тесты всех реализаций (jdbc, jpa, datajpa) через наследование (без дублирования) , не пойму что хотят:thinking_face:


1 reply
Oleksii Leshchenko [1 hour ago]
Я так понял, что класс MealServiceTest должен стать базовым и не зависеть от имплементации jdbc/jpa/datajpa. Т.е. он не использует профилиспринга. А взамен создаются через наследование пустые классы, которые будут включать соответ. профиль....


Oleksii Leshchenko [2:03 PM]
Тут кстати описали, как запускать тесты несколько раз с различными профилями, использую параметризированные тесты. Но, имхо, слишком заумно, сложноватенько такое сделать...
http://forum.spring.io/forum/spring-projects/container/120249-runwith-parameterized-class-with-different-set-of-spring-profiles-per-parameter (edited)


qf05 [Today at 2:39 PM]
in #hw5
блин, как сломать JdbcMealRepositoryImpl для HSQLDB, что не делаю, а оно всё равно работает:sweat_smile:


2 replies
Oleksii Leshchenko [32 minutes ago]
Сделай clean и Reimport Maven projects перед запуском тестов


qf05 [10 minutes ago]
делал, не помогло.
нашел причину: оказывается мне почему то в классе Profiles метод getActiveDbProfile() всегда возвращает Postgres.


Artem Murk [Today at 2:42 PM]
in #hw5
Не пойму почему у меня не падает контекст в spring-db.xml прописаны 2 способа сканирования для datajpa.
    ```<context:component-scan base-package="ru.javawebinar.**.repository.datajpa"/>
    <jpa:repositories base-package="ru.javawebinar.**.repository.datajpa"/>```


3 replies
Oleksii Leshchenko [26 minutes ago]
я так понимаю это 2 разные инструкции.
*<context:component-scan* сканирует и обрабатывает для *Spring* аннотации типа @Component, @Service, @Repository...
*<jpa:repositories* - обрабатывает репозитории для *Spring Data Jpa*


Artem Murk [22 minutes ago]
Идея видит инициализацию нескольких бинов (edited)


Artem Murk [3 minutes ago]
@Oleksii Leshchenko уловил суть твоего ответа


Artem Murk [2:43 PM]
Или бины инициализируются один раз понимая что это одно и тоже? что то я  запутался

Artem Murk [2:53 PM]
uploaded this image: 2 бина 