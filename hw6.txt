Grigory Kislin [1:54 AM]
joined #hw6.

Grigory Kislin [1:58 AM]
Готово 6-е занятие:
https://github.com/JavaWebinar/topjava/blob/doc/doc/lesson06.md
Начинаем изучать Spring-MVC и слой Web. 
Занятие и домашнее задание относительно большие, следующее занятие будет в четверг, 19.04 (edited)

Daniil Kulak [2:09 AM]
joined #hw6 along with 18 others.


Хэм [10:15 PM]
у кого не работают тесты? у меня не определяет говорит No qualifying bean of type 'ru.javawebinar.topjava.repository.MealRepository' available: expected single matching bean but found 2: dataJpaMealRepositoryImpl,jpaMealRepositoryImpl
ноэтой ошибки не должно же быть ведь у нас профили теперь все четко я не знаю почему он находит jdbc  он не активен у меня:tired_face:

Jan [10:54 PM]
А как ты запускаешь ? Консоль, ide ?

Хэм [1:54 AM]
через мавен

Tanya [1:55 AM]
пролема не в том, что нет jdbc, а в том находит два dataJpaMealRepositoryImpl, jpaMealRepositoryImpl когда нужен один


Yevhen Maksymovych [Today at 9:09 AM]
in #hw6
у меня одного это занятие вызывает какой-то ступор? до этого всё было просто и последовательно, а теперь мы напихали новых контекстов, хмл, чего-то наподключали, наотключали я дошёл до шестого ролика, и начал понимать, что джава, по всей видимости, не моё


6 replies
dustnfox [4 hours ago]
Ну вот чего ты меня раньше времени пугаешь? Я еще даже до шестого не дошел :disappointed:


Dmitry Neustupov [3 hours ago]
Не переживай - дальше будет её интереснее )


Arthur [3 hours ago]
А в чем ступор то?


Jan [3 hours ago]
https://github.com/google/guice а еще вместо спринга можно вот это использовать )
google/guice
Guice (pronounced 'juice') is a lightweight dependency injection framework for Java 6 and above, brought to you by Google.
Website
----------------
https://github.com/google/guice

Watchers
----------------
523

Stars
----------------
6526

Forks
----------------
1022

google/guiceMay 29th, 2014 at 2:18 AM Added by GitHub


Ilya [3 hours ago]
Вызывает ступор, что не очень плавно перешли - на 6-7-8 видосы. Я вот сейчас пересматривать буду - не сращиваю, у нас томкат теперь впилен в проект ? Томкат сам управляет пулом коннектов ? На каждый запрос в браузере будет даваться свой коннект ?


Arthur [2 hours ago]
если я правильно понимаю, в базовой поставке томката этой функциональности нет. Поэтому мы ее прикручиваем сбоку...


Yevhen Maksymovych [9:10 AM]
uploaded this image: image.png 


qf05 [Today at 11:05 AM]
in #hw6
Сейчас вроде разобрался с первыми двумя пунктами дз, на третьем ступор.
1) В каком пакете надо размещать JspMealController? web или meal?
2)От куда надо получать userId ? Из AuthorizedUser.id()?
3)Когда надо использовать @PostMapping, а когда @RequestMapping?
4)Что это вообще такое: RootController#setUser? что за решётка, что она означает ? Или это просто имеется в виду метод сетЮзер или это где то в джсп искать?
Возможно вопросы тупые, но в голове реально каша.

А ещё очень пугает фраза: "Если нет понимания этих основ, двигаться дальше нельзя" начал судорожно перебирать всё что знаю про спринг, но вроде первые два задания сделал быстро и всего по паре строчек кода, хоть и методом научного тыка. Все тесты работают, наверно что то я всё-таки уже знаю и можно двигаться дальше.


4 replies
Oleksii Leshchenko [1 hour ago]
3) Не принципиально что именно использовать. Они взаимозаменяемые


Oleksii Leshchenko [1 hour ago]
4) RootController#setUser - где это? Скорее всего это Spring Expression Language (SpEL)


qf05 [40 minutes ago]
это в дз пункт 1.3.1


Oleksii Leshchenko [37 minutes ago]
ДУмаю # ничего не значит... Могли и через точку написать RootController.setUser


qf05 [Today at 11:14 AM]
in #hw6
И почему то у меня в мавене в плагинах не хочет томкат появляться...


2 replies
Oleksii Leshchenko [2 hours ago]
Он там заменен на cargo plugin...


qf05 [2 hours ago]
спасибо


Ilya [Today at 11:41 AM]
in #hw6
поясните, плз, 
1.что еще за messages? Когда они используются ? 
2. У нас в проекте есть tomcat-servlet-api ? Зачем ? Где используется  ?
3. В чем смысл следующего бина ?
  <beans profile=“tomcat”>
       <jee:jndi-lookup id=“dataSource” jndi-name=“java:comp/env/jdbc/topjava”/>
       <context:property-placeholder location=“classpath:db/tomcat.properties” system-properties-mode=“OVERRIDE”/>
   </beans>


5 replies
Arthur [1 hour ago]
Мэсаджи используются на фронте, для интернализации сообщений. Это встроенный в Spring механизм. Можно его не использовать, тогда тебе ручками придется заниматься интернализацией. (edited)


Arthur [1 hour ago]
По поводу третьего твоего вопроса - если правильно понимаю, в веб серверах JNDI механизм есть в исходной поставке. У нас томкат(это не полноценный веб сервер). У него нет этого механизма. Поэтому мы его прикручиваем ручками.
Если я не прав в свих высказываниях, пусть меня поправят (edited)


Arthur [1 hour ago]
По поводу второго вопроса - помойму Григорий в каком-то видео отвечает на твой вопрос


Ilya [1 hour ago]
@Arthur да, но перебирать все видео сейчас лень) спасибо за ответы!


Oleksii Leshchenko [1 hour ago]
Если не ошибаюсь, то tomcat-servlet-api используем для организации пула коннектов к БД


qf05 [12:03 PM]
return "redirect:meals";
С этим вроде понятно, а как сделать форвард?


qf05 [1:55 PM]
что то с кодировкой не могу справиться, фильтр CharacterEncodingFilter не помогает.

Vitaly M. [6:06 PM]
У меня, после всех патчей вылетает ошибка
```javax.servlet.jsp.JspTagException: No message found under code 'app.title' for locale 'ru_RU'.```


Vitaly M. [Yesterday at 6:09 PM]
in #hw6
я так понимаю, для locale 'ru_RU' у нас app_ru.properties... и spring его не ассоциирует с ru_RU


6 replies
Grigory Kislin [23 hours ago]
скорее всего spring не видит config\messages\app_ru.properties
попробуй захардкодить без переменной окуржения TOPJAVA_ROOT и проверить


Vitaly M. [23 hours ago]
все верно...
не могу вспомнить на каком занятии мы TOPJAVA_ROOT устанавливали, чтоб найти куда проверить как оно у меня в идее прописано


Fedor [6 hours ago]
Получилось решить?


Vitaly M. [4 hours ago]
нет ) просто поставил абсолютный путь и забил пока... тут бы найти время все видео просмотреть и въехать )


Vitaly M. [2 hours ago]
я работаю в линуксе, поэтому я добавил переменную окружения в /etc/environment
Для windows это подробно описано в последнем видео текущего урока.


Fedor [2 hours ago]
Да, я наковырял, спасибо


qf05 [6:37 PM]
подскажите, а фильтр CharacterEncodingFilter надо же в web.xml вставить и всё, дальше оно само должно работать? никак не могу разобраться почему у меня вместо букв знаки вопроса. (edited)


Евгений [Yesterday at 10:08 PM]
in #hw6
Всем привет! Я немного отстал, и пересел за другой комп вдобавок. Как с помощью GIT клонировать ветку master, которая была перед началом занятия 5?


1 reply
Oleksii Leshchenko [19 hours ago]
А твой репозиторий на ГитХабе в каком щас состоянии?


Oleg K [Yesterday at 11:15 PM]
in #hw6
Коллеги, после патча 6_02 при запуске tomcat и переходе на страничку еды вылетает
```org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type 'ru.javawebinar.topjava.repository.MealRepository' available: expected at least 1 bean which qualifies as autowire candidate. Dependency annotations: {}```
Тесты проходят. Я криво накатываю патчи, или проблема в ином?


2 replies
Kirilo [17 hours ago]
починка в других патчах. Это же задание optional, здесь мы еще не прикручивали профили в tomcat


Oleg K [5 hours ago]
В самом деле. Спасибо!


Kirilo [1:36 AM]
Накотил три патча. Хотел спросить "почему не работают тесты с профилем postgres?" А после отката в начало, увидел, что в месте, где меняем профиль БД файл не изменялся патчами :slightly_smiling_face: (edited)

Ilya [4:01 AM]
Как это работает ? 
public void testValidation() throws Exception {
       validateRootCause(() -> service.create(new Meal(null, of(2015, Month.JUNE, 1, 18, 0), ”  “, 300), USER_ID), ConstraintViolationException.class);
   
public <T extends Throwable> void validateRootCause(Runnable runnable, Class<T> exceptionClass) {
       try {
           runnable.run();
           Assert.fail(“Expected ” + exceptionClass.getName());
       } catch (Exception e) {
           Assert.assertThat(getRootCause(e), instanceOf(exceptionClass));
       }
   }

т.е. одним потоком запустили процесс создания мила, а потом в главном потоке сами бросаем эксепшион, который проверяем ?

Tanya [7:53 AM]
создаем еду, если исключение вылетело - тест ок, если нет - то тест fail

vch [7:58 AM]
@Ilya Тут нет нового потока. Runnable (т.е. создание Meal) в данном случае выполняется в том же главном потоке. (edited)


alexey [2:59 PM]
added and commented on this Plain Text snippet: Patch 6_13 
org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'entityManagerFactory' defined in class path resource [Spring/spring-db.xml]: Invocation of init method failed; nested exception is javax.persistence.PersistenceException: [PersistenceUnit: default] Unable to build Hibernate SessionFactory
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1710)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:583)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:502)
  at org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:312)
  at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:228)
  at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:310)
  at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:200)
  at org.springframework.context.support.AbstractApplicationContext.getBean(AbstractApplicationContext.java:1085)
  at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:858)
  at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:549)
  at org.springframework.web.context.ContextLoader.configureAndRefreshWebApplicationContext(ContextLoader.java:409)
  at org.springframework.web.context.ContextLoader.initWebApplicationContext(ContextLoader.java:291)
  at org.springframework.web.context.ContextLoaderListener.contextInitialized(ContextLoaderListener.java:103)
  at org.apache.catalina.core.StandardContext.listenerStart(StandardContext.java:4939)
  at org.apache.catalina.core.StandardContext.startInternal(StandardContext.java:5434)
  at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:150)
  at org.apache.catalina.core.ContainerBase$StartChild.call(ContainerBase.java:1559)
  at org.apache.catalina.core.ContainerBase$StartChild.call(ContainerBase.java:1549)
  at java.util.concurrent.FutureTask.run(FutureTask.java:266)
  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
  at java.lang.Thread.run(Thread.java:748)
Caused by: javax.persistence.PersistenceException: [PersistenceUnit: default] Unable to build Hibernate SessionFactory
  at org.hibernate.jpa.boot.internal.EntityManagerFactoryBuilderImpl.persistenceException(EntityManagerFactoryBuilderImpl.java:970)
  at org.hibernate.jpa.boot.internal.EntityManagerFactoryBuilderImpl.build(EntityManagerFactoryBuilderImpl.java:895)
  at org.springframework.orm.jpa.vendor.SpringHibernateJpaPersistenceProvider.createContainerEntityManagerFactory(SpringHibernateJpaPersistenceProvider.java:57)
  at org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean.createNativeEntityManagerFactory(LocalContainerEntityManagerFactoryBean.java:365)
  at org.springframework.orm.jpa.AbstractEntityManagerFactoryBean.buildNativeEntityManagerFactory(AbstractEntityManagerFactoryBean.java:388)
  at org.springframework.orm.jpa.AbstractEntityManagerFactoryBean.afterPropertiesSet(AbstractEntityManagerFactoryBean.java:377)
  at org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean.afterPropertiesSet(LocalContainerEntityManagerFactoryBean.java:341)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeInitMethods(AbstractAutowireCapableBeanFactory.java:1769)
  at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1706)
  ... 21 more
Caused by: org.hibernate.cfg.beanvalidation.IntegrationException: Error activating Bean Validation integration
  at org.hibernate.cfg.beanvalidation.BeanValidationIntegrator.integrate(BeanValidationIntegrator.java:138)
  at org.hibernate.internal.SessionFactoryImpl.<init>(SessionFactoryImpl.java:281)
  at org.hibernate.boot.internal.SessionFactoryBuilderImpl.build(SessionFactoryBuilderImpl.java:460)
  at org.hibernate.jpa.boot.internal.EntityManagerFactoryBuilderImpl.build(EntityManagerFactoryBuilderImpl.java:892)
  ... 28 more
Caused by: java.lang.NoClassDefFoundError: javax/el/ELManager
  at org.hibernate.validator.messageinterpolation.ResourceBundleMessageInterpolator.buildExpressionFactory(ResourceBundleMessageInterpolator.java:88)
  at org.hibernate.validator.messageinterpolation.ResourceBundleMessageInterpolator.<init>(ResourceBundleMessageInterpolator.java:47)
  at org.hibernate.validator.internal.engine.ConfigurationImpl.getDefaultMessageInterpolator(ConfigurationImpl.java:474)
  at org.hibernate.validator.internal.engine.ConfigurationImpl.getDefaultMessageInterpolatorConfiguredWithClassLoader(ConfigurationImpl.java:650)
  at org.hibernate.validator.internal.engine.ConfigurationImpl.getMessageInterpolator(ConfigurationImpl.java:397)
  at org.hibernate.validator.internal.engine.ValidatorFactoryImpl.<init>(ValidatorFactoryImpl.java:183)
  at org.hibernate.validator.HibernateValidator.buildValidatorFactory(HibernateValidator.java:38)
  at org.hibernate.validator.internal.engine.ConfigurationImpl.buildValidatorFactory(ConfigurationImpl.java:364)
  at javax.validation.Validation.buildDefaultValidatorFactory(Validation.java:103)
  at org.hibernate.cfg.beanvalidation.TypeSafeActivator.getValidatorFactory(TypeSafeActivator.java:501)
  at org.hibernate.cfg.beanvalidation.TypeSafeActivator.activate(TypeSafeActivator.java:84)
  at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
  at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
  at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
  at java.lang.reflect.Method.invoke(Method.java:498)
  at org.hibernate.cfg.beanvalidation.BeanValidationIntegrator.integrate(BeanValidationIntegrator.java:132)
  ... 31 more
Caused by: java.lang.ClassNotFoundException: javax.el.ELManager
  at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1702)
  at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1547)
  ... 47 more
Collapse 
У всех Томкат через мавен плагин запускается? У меня вылетает с ошибкой. В чем может быть причина?


Alexander_Gubanow [Yesterday at 3:06 PM]
in #hw6
@Ilya Когда мы в классе сущности указываем аннотации для валидации полей (например @NotNull), Hibernate будет проверять эти поля при сохранении объекта в БД с помощью org.hibernate.cfg.beanvalidation.BeanValidationEventListener. В случае не соответствия указанному критерию он выкидывает ошибку – ConstraintViolationException. Чтобы проверить, что наше приложение работает правильно  - сделали тесты на валидацию вводимых данных. В базовом тестовом классе мы сделали
метод public <T extends Throwable> void validateRootCause(Runnable runnable, Class<T> exceptionClass) {
   try {
       runnable.run();
       Assert.fail("Expected " + exceptionClass.getName());
   } catch (Exception e) {
       Assert.assertThat(getRootCause(e), instanceOf(exceptionClass));
   }
}
В Assert.fail("Expected " +exceptionClass.getName())проверяем, что блок try отработал с ошибкой. В Assert.assertThat(getRootCause(e), instanceOf(exceptionClass)) проверяем, что аргумент getRootCause(e) удовлетворяет условию instanceOf(exceptionClass). В getRootCause(e) мы узнаем первопричину исключения.  Собственно в  тестовом субклассе вызываем validateRootCause() и передаем ему аргументы. Первый аргумент -  () -> service.create(new Meal(null, of(2015, Month.JUNE, 1, 18, 0), "  ", 300) записан в виде лямбда-выражении- реализации интерфейса Runnable "на ходу";
второй аргумент - ConstraintViolationException.class. (edited)



3 replies
EdK [4 hours ago]
Хотел немного поправить, мы запускаем задачу и если исключения не произошло, тогда мы говорим, что тест провален и сообщаем что ждали исключения ( Assert.fail("Expected " +exceptionClass.getName()). Ну а дальше все правильно. Только я так пока и не понял почему у нас в jdbc не выбрасывается исключение.


Ilya [3 hours ago]
@EdK вангую, потому что с jdbc работаем через API спринга, а валидация через хибернейт. Кстати, спасибо за корректировку! А то после первого прочтения в голове что-то не укладывалось.


EdK [3 hours ago]
Да, что нет хибернейта понял когда начал дебажить и увидел что данные добавляются в таблицу с неправильными полями.


Ma3stro [Yesterday at 6:26 PM]
in #hw6
Можно ли в контроллере в аргументах у методов указывать и model, и HttpServletRequest чтобы ловить action'ы и реализовывать функциональность из сервлета?


1 reply
pro [2 hours ago]
https://ru.stackoverflow.com/questions/604088/%D0%90%D0%BD%D0%B0%D0%BB%D0%BE%D0%B3-spring-controller-%D0%B2-java-servlet
ru.stackoverflow.com
Аналог Spring @Controller в Java Servlet
Спринговые контроллеры (@Controller) позволяют обрабатывать множество URL - паттернов. А как быть с сервлетами, один сервлет на один url? Спасибо.
 
 
 
pro [8:50 PM]
да

Vladimir Gorbatenko [11:32 PM]
Да, про сову очень четко. Очень много разорванной информации, не только в HW6, но и ранее. Это как изучать математику, учимся считать 1,2,3 а потом фигак и сразу логарифмы. И ты такой - эй, уважаемый, а где же яйца? Может это я такой непонятливый, хотя спринг и хибернейт ранее сам пытался штудировать, т.е. инфа отчасти знакомая, а все равно достаточно часто не понимаю что требуется сделать. И еще мне так кажется, что видео пора обновить, с 2014 года в проекте было сделано не мало изменений, например в тех же именах классов, иногда просто запутывает. Это не претензии. Информации действительно много. Но возможно так и надо кормить информацией... (edited)

saudabaew [7:03 AM]
uploaded and commented on this image: image.png 

При накате первого патча вышло предупреждение, что означает?

Yevhen Maksymovych [7:28 AM]
не по-русски написано, но вроде кто-то пропустил три хука слева


saudabaew [Today at 7:46 AM]
in #hw6
ну да, это я перевел) но что это значит?)


3 replies
alexey [3 hours ago]
это значит что твой мастер отличается от мастера григория (т.е. мастер после патча 5_8) и эти 3 куска кода не будут добавлены в твою версию. откатывайся на 5_8 и ищи отличия


saudabaew [2 hours ago]
а, понял в чем ошибка. спасибо большое!


pro [2 hours ago]
я бы просто сделал ctrl+prtScr этого диффа и добавил бы затем эти фрагменты вручную))


saudabaew [7:46 AM]
просто первый раз такое


alexey [Today at 8:47 AM]
in #hw6
кто дошел до установки патча 6_13?


2 replies
Yevhen Maksymovych [2 hours ago]
я только что поставил


alexey [1 hour ago]
TomCat как у тебя запускается? Из плагина запускается или только из командной


VadimSimonov [Today at 10:04 AM]
in #hw6
народ подскажите комнату обсуждения выпускного проекта


1 reply
Oleksii Leshchenko [1 hour ago]
#graduation


qf05 [1:09 PM]
Подскажите, где я что пропустил. Томкат из плагина не запускается, пишет:
Failed to execute goal org.codehaus.cargo:cargo-maven2-plugin:1.6.7:run (default-cli) on project topjava: Execution default-cli of goal org.codehaus.cargo:cargo-maven2-plugin:1.6.7:run failed: Failed to create deployable with implementation class org.codehaus.cargo.container.tomcat.TomcatWAR for the parameters (container [id = [tomcat8x]], deployable type [war]). InvocationTargetException: Failed to parse Tomcat WAR file in [C:\Project\qf05\topjava\target\topjava.war]: Failed to find file [C:\Project\qf05\topjava\target\topjava.war]: C:\Project\qf05\topjava\target\topjava.war (Не удается найти указанный файл) -> [Help 1]


qf05 [1 day ago]
Решил тем, что в мавене сделал package. 
Теперь лог заканчивается этим:
[INFO] [talledLocalContainer] Tomcat 8.x started on port [8080]
[INFO] Press Ctrl-C to stop the container...
И больше ничего не происходит. http://localhost:8080 пишет что страница не найдена.


Pavel Zaitcev [1 day ago]
В IDEA, внизу, во вкладке "Terminal" попробуй выполнить   mvn clean package -DskipTests=true org.codehaus.cargo:cargo-maven2-plugin:1.6.7:run


Pavel Zaitcev [1 day ago]
Запустилось?


qf05 [1 day ago]
нет, пишет тоже самое( (edited)


Grigory Kislin [1 day ago]
карго деплоит war в контекст приложения topjava
http://localhost:8080/topjava


qf05 [1 day ago]
Точно!) Спасибо) Всё работает)


Zhivchik [4:35 PM]
После накатки  6_14_spring_webmvc ссылка "моя еда" - ведет на страницу со статусом 404. Так и должно быть или это у меня косяк в проекте?

Ma3stro [4:37 PM]
Да, и это нужно будет править:)

Zhivchik [4:39 PM]
Ок. Спасибо:)

Ma3stro [4:45 PM]
Так и не понял, в какую сторону глядеть для починки mock тестов?


Ma3stro [Yesterday at 4:47 PM]
in #hw6
Странно, написал сюда и решение пришло


1 reply
Nedfrench [1 hour ago]
Намекнешь в какую сторону смотреть?


Ma3stro [4:47 PM]
хд

Ma3stro [6:26 PM]
Как можно исправить то, что при выполнении метода post у меня формируется запрос /topjava/meals/meals?
    ```@PostMapping("/meals")
    public String post(HttpServletRequest request) {
        Meal meal = new Meal(
                LocalDateTime.parse(request.getParameter("dateTime")),
                request.getParameter("description"),
                Integer.parseInt(request.getParameter("calories")));

        ValidationUtil.checkNew(meal);

        if (request.getParameter("id").isEmpty()) {
            mealService.create(meal, AuthorizedUser.id());
        } else {
            mealService.update(meal, AuthorizedUser.id());
        }

        return "meals";
    }

    @GetMapping("/meals/create")
    public String create(Model model) {
        Meal meal = new Meal(LocalDateTime.now().truncatedTo(ChronoUnit.MINUTES), "", 1000);
        model.addAttribute("meal", meal);
        return "mealForm";
    }```


ilya t. [1 day ago]
посмотри у диспетчер сервлета url pattern какой


ilya t. [1 day ago]
если ничего не менял


Ma3stro [1 day ago]
Прости, куда конкретно посмотреть?


ilya t. [1 day ago]
ну в web.xml

ilya t. [1 day ago]
там твой сервлет определен и у него такое

ilya t. [1 day ago]
<servlet-mapping>
       <servlet-name>mvc-dispatcher</servlet-name>
       <url-pattern>/</url-pattern>
   </servlet-mapping>


Ma3stro [1 day ago]
url pattern /


ilya t. [1 day ago]
аа


ilya t. [1 day ago]
тогда в другом месте смотреть надо)

ilya t. [1 day ago]
попробуй вот что

ilya t. [1 day ago]
перепиши на @RequestMapping с method POST также


ilya t. [1 day ago]
может подействует


ilya t. [1 day ago]
сходу так не скажешь почему


Ma3stro [1 day ago]
Возможно, здесь с самой логикой немного проблемы. Делаю метод create, в нем отправляюсь на mealForm, где `<form method="post" action="meals">` отправляет данные на "meals". В контроллере я ловлю это `@PostMapping("/meals")`, выполняю метод create у сервиса и отправлюсь meals.jsp


Ma3stro [1 day ago]
Верно мыслю?


ilya t. [1 day ago]
да вроде бы


ilya t. [1 day ago]
сейчас еще подумаю

Ma3stro [1 day ago]
При дебаге выполнение даже не доходит до этого метода. После отправки данных формируется запрос и просто вылетает 404


Ma3stro [1 day ago]
Можно попробовать сделать через @ModelAttribute


ilya t. [1 day ago]
пост вроде норм написан

ilya t. [1 day ago]
Попробуй все таки изменить url запроса


ilya t. [1 day ago]
С телефона сложно сказать


EdK [1 day ago]
попробуй в mealForm у формы указать action="/meals"


Grigory Kislin [1 day ago]
Подсказки по HW06 п.3


aleksey [2:26 AM]
Кому-нибудь удалось нормально прописать basenames для messageSource под Linux ?

tema.emelyan [3:04 AM]
@aleksey а там разве как-то по-другому? (edited)

aleksey [3:07 AM]
@tema.emelyan это праздный интерес или у тебя linux ?

tema.emelyan [3:07 AM]
ubuntu у меня

Vyacheslav [10:26 AM]
Народ. У меня у одного ИДЕЯ намертво виснет при накатке 15-го патча?

Dmitry Neustupov [10:53 AM]
@Vyacheslav у меня всё норм


Vyacheslav [Today at 11:15 AM]
in #hw6
IDEA 2018.1 билд от 27 марта.  Вмоем случае помогла накатка патча в 2 этапа. Сначала выполнить перемещение пропертей в config\messages. Потом все остальное включая удаление старого app_ru.properties и src\main\resourсes.



1 reply
Arseniit [3 hours ago]
Да, так же подвисала идея. Сделал поэтапно. IDEA 2016.3,3


Vyacheslav [11:21 AM]
А есть ли что-то типа дебага накладывания патчей?

Vyacheslav [11:30 AM]
uploaded and commented on this image: redDataSourse.jpg 

Я видимо упустил. Как от этого подчеркивания правильно избавиться?


Vladimir Gorbatenko [Today at 11:47 AM]
in #hw6
Всем привет! есть у кого-то видео с объяснением про все что связано EntityGraph или может вообще про графы?


2 replies
ilya t. [5 hours ago]
вчера только читал про них, только ссылку не найду, Видео тоже нету, ну смысл в общем как я понял что нам не надо непосредственно в запросе join fetch писать, вместо этого можем просто обозначить нужные нам поля в атрибутах и они вытянутся из базы игером.


Grigory Kislin [1 hour ago]
в уроке же есть ссылка (edited)


qf05 [Today at 11:56 AM]
in #hw6
кто сталкивался, подскажите, почему в mealForm стили отваливаются? это происходит если адрес http://localhost:8080/meals/mealForm, а если адрес http://localhost:8080/mealsForm то всё норм работает. (edited)


4 replies
Pavel Zaitcev [10 hours ago]
Перейди в отладчик браузера (F12 в Firefox), и попробуй отследить подгрузку стилей для страничек. Причина в том, что страничка не может найти ресурс (style.css).


Pavel Zaitcev [10 hours ago]
Посмотри, как мапятся ресурсы в spring-mvc.xml. В этом, в общем-то и кроется ответ.


Pavel Zaitcev [9 hours ago]
Менять там ничего не нужно, нужно просто посмотреть, и понять, почему это  происходит. Если уж надо поменять, то делать это нужно в другом месте :slightly_smiling_face:


qf05 [9 hours ago]
@Pavel Zaitcev Спасибо! В отладчик браузера я зайти не догадался... 
Как там всё интересно)))
Я только не понял, можно ли в jsp пути как то прописывать через * ? Типа ищи где хочешь папку такую-то, а в ней такой-то файл.
Конкретно в этом случае это не надо, тут я обошёлся этим:  ../


Aleksei Kirillov [4:00 PM]
commented on Vyacheslav’s file redDataSourse.jpg
Никак не избавиться.  Ругается на отсутствие класса org.apache.tomcat.jdbc.pool.DataSource.
А он у нас импортируется в pom при включенном postgtes.
Это сделано для автоматического определения профиля:
  public static String getActiveDbProfile() {
      try {
          Class.forName("org.postgresql.Driver");
          return POSTGRES_DB;
      } catch (ClassNotFoundException ex) {
          try {
              Class.forName("org.hsqldb.jdbcDriver");
              return Profiles.HSQL_DB;
          } catch (ClassNotFoundException e) {
              throw new IllegalStateException("Could not find DB driver");
          }
      }
  }

Dzmitry Shalukhau [7:10 PM]
Подскажите пожалуйста: почему у меня в DataJpa*RepositoryImpl красным выделено свойство на Crud*Repository. Idea не может кандидата к @Autowired найти... Что-то явно забыл настроить

Ma3stro [7:32 PM]
Вероятно, бин не попадает в контекст спринга. Смотри xml'ки
Как в этом случае избавиться от редиректа, но чтобы путь после фильтра оставался на /meals ? с return "meals" этого сделать, увы, нельзя
    ```@PostMapping("/meals/filter")
    public String filter(HttpServletRequest request) {
        LocalDate startDate = parseLocalDate(request.getParameter("startDate"));
        LocalDate endDate = parseLocalDate(request.getParameter("endDate"));
        LocalTime startTime = parseLocalTime(request.getParameter("startTime"));
        LocalTime endTime = parseLocalTime(request.getParameter("endTime"));
        request.setAttribute("meals", getBetween(startDate, startTime, endDate, endTime));

        return "redirect:/meals";
    }```
(edited)

Dzmitry Shalukhau [7:55 PM]
Он не попадает, т.к. нет аннотации @Repository (но в видео ее нет и ничего страшного не отображается)

Nedfrench [8:14 PM]
uploaded and commented on this image: Коллеги,  добрый вечер! 

У меня у одного такая структура wepapp?
Arseniit [8:18 PM]
у меня так же
Nedfrench [8:21 PM]
не смущает?
Arseniit [8:33 PM]
смущает)) особенно когда в патче указан ,например, адрес src/main/webapp/WEB-INF/jsp/fragments/bodyHeader.jsp

Nedfrench [8:36 PM]
Я до патча 6_13 откатился и заново загрузил 6_14 и 6_15. Проблема решилась.


Nedfrench [Today at 9:19 PM]
in #hw6
Два раза пересмотрел видео, но так и не понял каким образом создается WebApplicationContext?


1 reply
Grigory Kislin [33 minutes ago]
преред 10м видео есть вопрос. про это?


Grigory Kislin [9:48 PM]
commented on Vyacheslav’s file redDataSourse.jpg
в профилях мавен выбери postgres и обнови зависимости. либо выбери в spring профиль hsgldb

Grigory Kislin [10:05 PM]
uploaded this image: image.png 


aleksey [Yesterday at 2:32 AM]
in #hw6
Для optional, как я понял, необходимо создать новый Entity Role, соответствующий репозиторий и прочую приблуду?


9 replies
Aleksei Kirillov [1 day ago]
Мне кажется, что ничего дополнительно создавать не надо. 
Просто добавить еще одну роль в 
public static final User ADMIN = new User(ADMIN_ID, "Admin", "admin@gmail.com", "admin", Role.ROLE_ADMIN);

А entity User уже работает с набором ролей
   public User(Integer id, String name, String email, String password, Role role, Role... roles) {
       this(id, name, email, password, DEFAULT_CALORIES_PER_DAY, true, new Date(), EnumSet.of(role, roles));
   }

Ну и подшаманить все (edited)


aleksey [1 day ago]
А сохранять этого юзера ты как будешь? Чтобы при этом его новые роли тоже сохранились?


Aleksei Kirillov [1 day ago]
Так
public static final User ADMIN = new User(ADMIN_ID, "Admin", "admin@gmail.com", "admin", Role.ROLE_ADMIN, Role.ROLE_USER); (edited)


aleksey [1 day ago]
поздравляю, ты создал инстанс. В базу как его будешь сохранять?

Aleksei Kirillov [1 day ago]
За нас все делает определение roles:
   @Cache(usage = CacheConcurrencyStrategy.NONSTRICT_READ_WRITE)
   @Enumerated(EnumType.STRING)
   @CollectionTable(name = "user_roles", joinColumns = @JoinColumn(name = "user_id"))
   @Column(name = "role")
   @ElementCollection(fetch = FetchType.EAGER)
//    @Fetch(FetchMode.SUBSELECT)
   @BatchSize(size = 200)
   private Set<Role> roles;

Ломается только для jdbc, поэтому есть пункт 2.4


Aleksei Kirillov [1 day ago]
посмотри отображение коллекций 
@CollectionTable


aleksey [1 day ago]
да, извиняюсь, про 2.4 я и спрашиваю, все остальное я сделал. (edited)


Aleksei Kirillov [1 day ago]
не дошел пока до optional


aleksey [1 day ago]
Если разберёшься раньше меня, буду благодарен, если поделишься


aleksey [3:21 AM]
И вообще, кто optional сделал? До кого можно чуток докопаться?

Alexander_Gubanow [9:54 AM]
@aleksey Какой вопрос по 2.4?


Zhivchik [Yesterday at 2:04 PM]
in #hw6
Запнулся на пункте 1.2. Насколько я понял не видит jpaUtil. В какую сторону смотреть кто то может сказать?


8 replies
Mikhail Makar [1 day ago]
Погляди в spring-db.xml!


Mikhail Makar [1 day ago]
А точнее на профиль datajpa, jpa



Fedor [1 day ago]
Профиль вроде как и у всех. А можно плиз поконкретнее место, куда глядеть?


Zhivchik [1 day ago]
Наверное нужно в профиль jdbc добавить несколько бинов необходимых для jpaUtil


Zhivchik [1 day ago]
Но тогда у меня при запуске JdbcUserServiceTest возникает уже проблема с  entityManagerFactory


Zhivchik [1 day ago]
Спасибо. Вроде заработало - всего то одно слово добавить)


Fedor [1 day ago]
Можешь в личку это слово кинуть?


Nedfrench [1 day ago]
Такая же проблема.


Nedfrench [9:20 PM]
при нажатии "моя еда" получаю

Nedfrench [9:20 PM]
uploaded this image: image.png 


Nedfrench [9:21 PM]
Никто не сталкивался?


Ma3stro [Yesterday at 9:25 PM]
in #hw6
Перезапусти томкат


3 replies
Nedfrench [1 day ago]
"Перезапусти томкат" - в смысле передеплоить проект?


Zhivchik [13 hours ago]
Возникла та же проблема. Что значит "Перезапусти томкат"?)


Zhivchik [13 hours ago]
Дело было не в томкате)


Nedfrench [9:29 PM]
Не взлетело))

Nedfrench [11:00 PM]
Перезапустил томкат, проблема исчезла, спасибо.


dmitry_ov [Yesterday at 11:04 PM]
in #hw6
Коллеги, а что значит термин “инвалидируем” в лекции HW06 ?


1 reply
ilya t. [1 day ago]
Удаляем кеш. Инвалидация - очистка. (edited)


Ilya [5:31 AM]
У кого-нибудь получилось реализовать ROW_MAPER для Role ?


Ilya [Today at 5:48 AM]
in #hw6
Так, гугл учит, что это не реально - тогда другой вопрос, кто-нибудь понял, как его заменить при запросах на роли ?


2 replies
qf05 [13 hours ago]
да, там ROW_MAPER не нужен, нужно лябда выражение с двумя переменными, одна из которых это ResultSet(который по сути типа вся таблица), и из него достаём значение по имени столбца, а второе просто id, оно не используется напрямую в этой лямбде. после лямбды надо поставить , и указать юзер ид, который является параметром в sql запросе.


Ilya [12 hours ago]
@qf05 да, уже нагуглил. 
полезные ссыли тем, кто будет делать http://www.byteslounge.com/tutorials/java-8-lambda-expressions-example и https://books.google.ru/books?id=x_IwBgAAQBAJ&pg=PA424&lpg=PA424&dq=(rs,+rowNum)+-%3E&source=bl&ots=cTDqjXDDzn&sig=KJ6AHcK1DWGpzlFMG6bM6I2zElo&hl=en&sa=X&ved=0ahUKEwjLxfDw5L3aAhUIZCwKHYsFD2UQ6AEIdzAI#v=onepage&q&f=false (edited)


qf05 [Today at 10:08 AM]
in #hw6
А зачем нам вообще нужен MealRestController, почему не правильно его делать абстрактным, или он потом будет нужен? Сейчас я так понимаю, надо весь код из MealRestController перенести в другой абстрактный класс?


1 reply
Ilya [12 hours ago]
рестовый контроллер нужен будет дальше. да, нужно запилить общий абстрактный класс, где будет будет выход на сервис. и пилить наследников jsp и rest


Oleksii Leshchenko [11:04 AM]
> 1.2 Починить Jdbc тесты (валидацию исключить)
Не совсем понятен этот пункт. Там ссылки даны как исключить тесты по условию.
Отсюда вопрос: должен JDBC тест запускаться всегда, или только когда соответсвующий профиль активирован?
И второе, там ошибка с этим:
`@Autowired`
`protected JpaUtil jpaUtil;`
Зачем для JDBC тестов jpaUtil. это надо выносить в отдельный класс...


Oleksii Leshchenko [Today at 11:09 AM]
in #hw6
я починил  Jdbc тесты  переконфигурируя Спринг... Но это не правильно. Надо было как-то исключить protected JpaUtil jpaUtil;


4 replies
Ma3stro [9 hours ago]
А как ты без JpaUtil будешь выполнять clear 2nd level cache, который и на JDBC реализации тоже используется?


Oleksii Leshchenko [9 hours ago]
Разве используется? Надо глянуть будет... Мне кажется это Hybernate кеш...


Grigory Kislin [5 hours ago]
валидация и JpaUtil  - это реализация JPA, которой в jdbc нет. поэтому и исключить (edited)


Grigory Kislin [5 hours ago]
@Oleksii Leshchenko сделай как считаешь правильно


poleg [Today at 12:06 PM]
in #hw6
После применения 6_09_hibernate_cache.patch в помнике ошибка у hsqldb - dependency org.hsqldb 2.4.0 not found. Что не так?


1 reply
Grigory Kislin [5 hours ago]
в мавен central есть:
http://search.maven.org/#artifactdetails%7Corg.hsqldb%7Chsqldb%7C2.4.0%7Cjar
обнови reimport maven
если не поможет удали из maven локал


dustnfox [Today at 6:12 PM]
in #hw6
Друзья, а я один тут не понимаю, как чинить InMemoryAdminRestControllerTest? Все остальное задание сделал, а это никак. Видимо, где-то сильно туплю.  С пятницы безрезультатно пытаюсь с ним бороться и даже не понимаю, в какую сторону копать и что читать. Все на что натыкаюсь крутиться вокруг `@WebAppConfiguration` которым я чинил InMemoryAdminRestControllerSpringTest. Как руками собрать иерархию WebApplicationContext, ума не приложу.


3 replies
Grigory Kislin [4 hours ago]
я просто в mock.xml добавил сканирование пакета контроллеров


Anton Kiselev [4 hours ago]
у нас же web перестал сканироваться. он не виден из spring-app если я правильно понял (edited)


dustnfox [4 hours ago]
Мда... Таких ударов судьбы великий комбинатор не испытывал давно. Я то пытался иерархию контекстов поднять и через аннотацию спринга это получилось. А вот без аннотаций - беда. Оказалось все гораздо проще. Как-то даже не подумал, что весь тот stuff который этот контекст просит, нам в тесте нафиг не нужен. В общем, всем огромное спасибо, а мне позор и порицание. :)


Nedfrench [9:21 PM]
Добрый вечер, коллеги.


Nedfrench [Today at 9:21 PM]
in #hw6
"попробуйте вообще без action=" - намекните пож-та куда смотреть.


12 replies
ilya t. [2 hours ago]
смотри, ты можешь вообще во вьюхе удалить в ссылках action'ы тогда у тебя они будут напрямую мапиться на методы контроллера


ilya t. [2 hours ago]
но это в случае ссылок,а в случае например форм постов там action остается


Oleksii Leshchenko [2 hours ago]
смотри тут примеры (смотри только сам контроллер). Без экшен меняется урл:
https://www.javatpoint.com/spring-mvc-crud-example
http://javawebtutor.com/articles/spring/spring-mvc-hibernate-crud-example.php (edited)


ilya t. [2 hours ago]
т.е. <a href="${pageContext.request.contextPath}/meals/create"> например


Nedfrench [2 hours ago]
Спасибо. Я уж начал думать, что по http методам раскидать нужно.


Nedfrench [2 hours ago]
" во вьюхе удалить в ссылках action'ы" под вьюхой понимается jsp, верно?


ilya t. [2 hours ago]
да


Nedfrench [2 hours ago]
Oleksii Leshchenko, ссылки то что надо.


ilya t. [2 hours ago]
через @PathVariable можно сделать, забыл упомянуть, ну собственно в ссылке сверху есть

dustnfox [1 hour ago]
Да вот нельзя, как я понял, через `@PathVariable` сделать. Я как последний осел, написал через все через `@PathVariable` и `@RequestParam`. А как только все заработало, прочитал вот это:
>принимать HttpServletRequest request (аннотации на параметры и адаптеры для LocalDate/Time мы введем позже)


пришлось все удалить и переписать через HttpServletRequest


ilya t. [1 hour ago]
хмм... ну строгого запрета я здесь не вижу :slightly_smiling_face: некоторые написал с реквестом, некоторые с pathvariable, думается мне последний более прогрессивный путь


dustnfox [1 hour ago]
Прогрессивный - да. Но Григорий, как я понял, пытается заставить нас написать все что есть и использованием всех имеющихся технологий :slightly_smiling_face:  Ну и заодно показать как каменный топор превратился в spaceX falcon и объяснить для чего это нужно и почему это удобнее. Если сначала написать два вагона boilerplate кода, то ценность технологии, которая делает это за тебя становится намного понятнее. Так что, боюсь, реализация этого пункта  с использованием аннотаций будет рассматриваться как перепрыгивание через ступеньки. Хотя, повторюсь, да, я тоже считаю, что с аннотациями намного удобнее.


ilya t. [Today at 9:34 PM]
in #hw6
подскажите как можно локализировать следующее выражение, что-то не могу сообразить :slightly_smiling_face:
<h2>${meal.id == null ? 'Create meal' : 'Edit meal'}</h2>
<spring message> туда не засунешь... получается что все приложение локализировано, и если у нас русский язык то эта запись остается на англ


1 reply
dustnfox [2 hours ago]
Я сделал через `<spring:message code="some_code" var=editingText>`  Этот код создает переменную указанную в `var`. Ну а дальше переменную уже можно пихать в тернарный оператор


druxa [Today at 9:43 PM]
in #hw6
Как в JdbcUserServiceTest можно получить Environment или context спринга


1 reply
ilya t. [1 hour ago]
http://www.ekiras.com/2015/09/spring-how-to-get-current-profiles-in-spring-application.html
ekiras.com
Spring : How to get Current Profiles in Spring Application
How to get the current environment or profile in spring, spring boot application. Get list of all active profiles in controller, service or pojo classes


realcorwin [12:03 AM]
uploaded and commented on this image: image.png 

Один из MVC контекстов надо убить?
Ilya [3:42 AM]
так ты посмотри, что внутри этих контекстов. думаю, что все вопросы отпадут)

Zhivchik [10:36 AM]
added and commented on this Plain Text snippet: Untitled 
2.2 Добавить еще одну роль к ADMIN (будет 2 роли: ROLE_USER, ROLE_ADMIN)
У нас же уже есть роли ADMIN и USER Обьясните что здесь требуеться сделать

Arthur [11:27 AM]
Пользователь под именем Admin теперь в системе должен будет иметь целый набор ролей: User и Admin.
Раньше админ имел только одну роль - Admin (edited)

realcorwin [11:27 AM]
@Ilya я слишком стар и мудр, чтоб считать себя умнее разрабов Идеи, которая автодетектнула эти контексты :slightly_smiling_face:


alexey [Today at 11:39 AM]
in #hw6
Добрый день. Подскажите, а в пункте 1.1 эти тесты надо создать или они уже должны быть в проекте?


1 reply
Oleksii Leshchenko [10 hours ago]
уже есть


roma [11:53 AM]
Друзья. а у меня после накатки патча 6 13 не появилась функциональность tomcat в плагинах мавена... Что делаю не так? (edited)

Aleksei Kirillov [11:56 AM]
Кажется в pom этот плагин закомментирован
roma
Друзья. а у меня после накатки патча 6 13 не появилась функциональность tomcat в плагинах мавена... Что делаю не так?
Posted in #hw6Today at 11:53 AM

Oleksii Leshchenko [12:20 PM]
У меня почему-то в шапке страницы в браузере надписи не разрезолвились, пишет вместо заголовка:
???app.title???
Там используется 
`<fmt:setBundle basename="messages.app"/>`
и
`<fmt:message key="app.home"/>`

Oleksii Leshchenko [12:21 PM]
uploaded this image: image.png 


realcorwin [12:24 PM]
Ты на каком сейчас патче? Там эти бандлы убрали же под конец

Oleksii Leshchenko [12:26 PM]
я вроде все накатил с самого начала. Но в процессе накатки в этом уроке пару раз что-то выскакивало, какое-то предупреждеие, что что-то перезатрется. Хотя мастер я не трогал... Может что-то не так накатилось.

realcorwin [12:28 PM]
Похоже на то. Должно быть без бандлов, с тегами спринга, которые подхватываются после перестарта Идеи


dustnfox [Today at 12:32 PM]
in #hw6
Ты запускаешь из IDEA или Maven plugin? Копай в сторону переменной TOPJAVA_ROOT. Spring через нее ресурсы ищет. У меня та же фигня была. Всю голову изломал, а оказалось, что проект переносил в другую папку и переменную не исправил. Плюсом в самом tomcat она прописана была в setenv.bat - а у него приоритет выше.
Oleksii Leshchenko
У меня почему-то в шапке страницы в браузере надписи не разрезолвились, пишет вместо заголовка:
???app.title???
Там используется 
`<fmt:setBundle basename="messages.app"/>`
и Show more…
Thread in #hw6Today at 12:20 PM


1 reply
Oleksii Leshchenko [9 hours ago]
Запускал по всякому. Все равно одно и тоже.
И Tomcat из IDE, и cargo:run  из IDE, и из терминала  `mvn clean package -DskipTests=true org.codehaus.cargo:cargo-maven2-plugin:1.6.7:run`


Edgar Zed [12:35 PM]
диар комрадс) а JpaUtil с очистой кэша нам только для тестов нужен? Чего он тогда не в тестах?


Yevhen Maksymovych [Today at 12:45 PM]
in #hw6
ребят, чет просмотрел вопросы, вроде такого не было, ругается на "Error:(10, 24) java: package org.slf4j.bridge does not exist"


7 replies
dustnfox [9 hours ago]
О! Хорошую тему @Yevhen Maksymovych затронул. У меня уже не первое занятие так - все руки не доходили покопаться.


dustnfox [9 hours ago]
То ли я чего-то не понимаю, то ли какой-то косяк. У нас для моста указан Runtime в maven. А мост этот торчит в тестах.
        ```// needed only for java.util.logging (postgres driver)
        SLF4JBridgeHandler.install();```
У меня напрочь компилировать отказывался, пока я у `jul-to-slf4j` scope в compile не переставил.


Yevhen Maksymovych [9 hours ago]
у меня такая фигня началась после реимпорта проекта. причём странно, склонил один и тот же гит, на домашнем пк всё отрабатывает корректно, на рабочем ноуте - валится с ошибкой


dustnfox [9 hours ago]
Мне вот что непонятно. В соответствии с доками:
>runtime This scope indicates that the dependency _is not required for compilation_, but is for execution. It is in the runtime and test classpaths, but not the compile classpath.
То есть для компиляции зависимость не нужна. Только вот как она нам может быть не нужная, если мы в коде в явном виде вызываем метод из этого JAR?


dustnfox [8 hours ago]
Причем, что характерно, фаза test из maven отрабатывает без ошибок.


druxa [3 hours ago]
такая же фигня была, на 5 уроке, делал клон проекта помогло, а на 6 уроке опять вылетает, подключал в ручную jar, но так не правильно же, твой вариант с compile помог


dustnfox [3 hours ago]
Ребят, подскажите кто получше с этим разобрался. Возможно я неправильно это понимаю. Как я понял, `compile` заставляет maven вытянуть jar и включить его в classpath при компиляции, запуске тестов и запуске приложения. При scope `runtime` maven вытягивает jar, но не включает его в classpath при копиляции. В classpath jar попадает только при запуске тестов и запуске приложения. Поясните мне, друзья, я что-то не так понимаю? Ведь если все так, то  мы не можем напрямую вызывать в нашем коде код зависимости со скоупом runtime ибо компилятор просто не разрезолвит ссылки импорта.


Yevhen Maksymovych [12:46 PM]
поменял в поме скоп для jul-to-slf4j c runtime на compile - все завелось, но почему сломалось-то - непонятно


Oleksii Leshchenko [Today at 1:15 PM]
in #hw6
> 2.1 Добавить транзакционность (DataSourceTransactionManager) в Jdbc реализации
Как проверить, что все работает правильно?
Я добавил, тесты работают, но в логах не вижу упоминания. И если в контексте закомментировать DataSourceTransactionManager бин, то все равно работает и не валится


1 reply
dustnfox [8 hours ago]
`TransactionSynchronizationManager.isActualTransactionActive()` если я правильно понимаю, показывает исполяется ли код в транзакции. Поставь в искомое место и посмотри.  Как-то можно в лог подключить вывод инфы о транзакциях, но я не осилил. :disappointed:


Oleksii Leshchenko [Today at 1:35 PM]
in #hw6
> 2.2 Добавить еще одну роль к ADMIN (будет 2 роли: ROLE_USER, ROLE_ADMIN)
Пока не сильно понял, в чем прикол...
Добавил в SQL и UserTestData. Все тесты проходят, Сервлет работает....


1 reply
dustnfox [8 hours ago]
Прикол в том, что добавить юзера мало. Нужно еще подправить логику сравнения пользователей (следующий пункт задания). Пока процедуре сравнения по барабану, что у юзера вписано в поле роли.  Ну а сервлету вообще пофиг - он с datajpa работает, а там hibernate вытягивает eager поля сам.


realcorwin [Today at 3:42 PM]
in #hw6
что именно надо чинить в 1.2?


4 replies
dustnfox [5 hours ago]
Тест на валидацию не проходит в JDBC реализации, ибо это валидации там просто нет. Если запустишь тесты по JDBC, то валидационный тест там сфейлит.


realcorwin [5 hours ago]
А, так исключить валидацию - и есть "починить"?


dustnfox [5 hours ago]
http://iliachemodanov.ru/ru/blog-ru/12-tools/57-junit-ignore-test-by-condition-ru


realcorwin [5 hours ago]
о, вот это понятно. спасибо!


ilya t. [Today at 5:01 PM]
in #hw6
скиньте пожалуйста какой-нибудь пример по пункту 2.1, не понимаю как впилить транзакционность в jdbc. Мы должны обозначить бин в дб контексте, потом заинжектить его в репозитории, а вот дальше что-то не уверен что делать. Что-то по типу пункта 7 указанного по ссылке? - https://examples.javacodegeeks.com/enterprise-java/spring/jdbc/spring-transaction-management-example-with-jdbc-example/ (edited)


5 replies
Oleksii Leshchenko [4 hours ago]
я сделал так, но чего-то скорее всего не хватает. не уверен, что работает.
1) в спринг контекст добавил:
<bean id="txManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
           <property name="dataSource" ref="dataSource"/>
       </bean>
2) На класс повесил:
@Transactional(readOnly = true)
3) На некоторые методы добавил:
@Transactional


Oleksii Leshchenko [4 hours ago]
и все :slightly_smiling_face:


Oleksii Leshchenko [4 hours ago]
НО сейчас тесты (правда, после добавления ролей и переделки имплементации) валятся, если делать все сразу пачкой. А если каждый тест поштучно, то проходит... Там походу в одном тесте видны результаты работы другого теста в БД...


ilya t. [4 hours ago]
аа, я думал что там нужно писать вместо аннотаций какой-то конкретный код, спасибо :slightly_smiling_face: А до добавления ролей не валились пачкой? (edited)


Oleksii Leshchenko [4 hours ago]
нет, не валились. но не факт, что транзакции подхватились. типа работало, но не понятно как


Yevhen Maksymovych [Today at 5:44 PM]
in #hw6
а кто-то разобрался с редиректами во вью?


10 replies
Oleksii Leshchenko [4 hours ago]
особо не разбирался... но кинул пару ссылок в соед. сообщении


Yevhen Maksymovych [4 hours ago]
да я почитал их ещё в уроке, но что-то не доганяю


Yevhen Maksymovych [4 hours ago]
там по тексту
```@RequestMapping(value = "/files/{path}", method = RequestMethod.POST)
public String upload(...) {
    // ...
    return "redirect:files/{path}";
}```


Yevhen Maksymovych [4 hours ago]
должно работать


Yevhen Maksymovych [4 hours ago]
а у меня такая конструкция посылает на /files/files/{path}


Yevhen Maksymovych [4 hours ago]
вот и пытаюсь понять, что я делаю не так


Oleksii Leshchenko [4 hours ago]
попробуй:
return "redirect:/files/{path}";


Yevhen Maksymovych [4 hours ago]
ага, уже разобрался, из-за "/" всё и было


Yevhen Maksymovych [4 hours ago]
спасибо :slightly_smiling_face:


Oleksii Leshchenko [4 hours ago]
я там сам запутался - тупо подбирал варианты перебором :slightly_smiling_face:


Yevhen Maksymovych [Today at 5:44 PM]
in #hw6
у меня какая-то фигня выходит


2 replies
Oleksii Leshchenko [4 hours ago]
https://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/mvc.html#mvc-redirecting-redirect-prefix


Oleksii Leshchenko [4 hours ago]
https://stackoverflow.com/questions/4764405/how-to-use-relative-paths-without-including-the-context-root-name (edited)


Yevhen Maksymovych [5:45 PM]
    ```@GetMapping("/delete/{id}")
    String deleteMeal(Model model, @PathVariable Integer id) {
        mealService.delete(id, AuthorizedUser.id());
        model.addAttribute("meals", MealsUtil.getWithExceeded(mealService.getAll(AuthorizedUser.id()), AuthorizedUser.getCaloriesPerDay()));
        return "redirect:meals";
    }```
возвращает на /delete/meals
а мне надо просто на meals

Yevhen Maksymovych [5:50 PM]
а, пропустил "/"
    ```@GetMapping("/delete/{id}")
    String deleteMeal(Model model, @PathVariable Integer id) {
        mealService.delete(id, AuthorizedUser.id());
        return "redirect:/meals";
    }```


Anton Kiselev [Today at 6:19 PM]
in #hw6
Подскажите, пожалуйста, как редиректиться с /filter на /meals с передачей фильтрованного списка еды.
Смотрю в сторону RedirectAttributes но пока безуспешно


17 replies
druxa [3 hours ago]
return "meals";


Anton Kiselev [3 hours ago]
тогда у меня url: meals/filter


druxa [3 hours ago]
попробуй jstl тэг использовать в форме фильтра <c:url var="addAction" value="/meals/filter"/>


druxa [3 hours ago]
<form method="post" action=${addAction}>

Anton Kiselev [2 hours ago]
@druxa спасибо, попробую

Anton Kiselev [2 hours ago]
по сути тоже самое выходит, после фильтрации .../meals/filter (edited)


druxa [1 hour ago]
У меня тоже так же, не заметил, сейчас исправил :sunglasses::grin:


druxa [1 hour ago]
Подсказка по /meals может ловиться и get и post запросы и это могут быть в разным метода


druxa [1 hour ago]
причем когда было /meals/filter не окрашивались поля в красный или зеленый


Anton Kiselev [1 hour ago]
у  меня уже getAll на GET, createOrEdit на POST)

druxa [1 hour ago]
у createOrEdit @PostMapping("/meals") ?


Anton Kiselev [1 hour ago]
Да

Anton Kiselev [1 hour ago]
не хотелось растаскивать на два post


druxa [41 minutes ago]
@PostMapping("/meals/add") а если так будет у createOrEdit или так не работает у тебя?


druxa [39 minutes ago]
типа если узер обращается по "/meals/add" то еда создается или обновляется и потом redirect:/meals


Anton Kiselev [38 minutes ago]
у меня форма на добавление по этому url открывается


Anton Kiselev [36 minutes ago]
```@GetMapping("/add")
public String addMeal(){
...
return "mealForm";}```


Vyacheslav [6:41 PM]
added and commented on this Plain Text snippet: Уже голову сломал 
@Controller
public class JspMealController {
  @Autowired
  private MealService service;
  
   @GetMapping("/meals")
  public String getAllMeal(Model model){
    model.addAttribute("meals", service.getAll(AuthorizedUser.id()));
    return "meals";
  }
}
Collapse 
Tomcat бросает ошибку:

Vyacheslav [6:42 PM]
org.apache.jasper.JasperException: An exception occurred processing JSP page [/WEB-INF/jsp/meals.jsp] at line [46]

43:         </tr>
44:         </thead>
45:         <c:forEach items="${meals}" var="meal">
46:             <jsp:useBean id="meal" scope="page" type="ru.javawebinar.topjava.to.MealWithExceed"/>
47:             <tr data-mealExceed="${meal.exceed}">
48:                 <td>
49:                         <%--${meal.dateTime.toLocalDate()} ${meal.dateTime.toLocalTime()}--%>

Vyacheslav [6:42 PM]
java.lang.ClassCastException: ru.javawebinar.topjava.model.Meal cannot be cast to ru.javawebinar.topjava.to.MealWithExceed

Tanya [6:43 PM]
ну тут ясно написано Meal cannot be cast to MealWithExceed
отдаешь список meal вместо mealWithExceed

Vyacheslav [6:44 PM]
Дак в MealServlet так и есть.


Vyacheslav [Today at 6:45 PM]
in #hw6
default:
               request.setAttribute("meals", mealController.getAll());
               request.getRequestDispatcher("/meals.jsp").forward(request, response);
               break;


4 replies
druxa [3 hours ago]
там с контролера вызывается getAll, а ты из сервиса


druxa [3 hours ago]
сделай JspMealController extends MealRestController и вызывай методы через super


Vyacheslav [3 hours ago]
Я понял, что  MealRestController здесь использовать не надо. Типа он позже использоваться будет. Сделал через MealsUtil. (edited)


druxa [3 hours ago]
Наследовать можно :grin:


Vitaly M. [8:10 PM]
Запутался я в POST и GET...

вначале отлавливаю:
 ```@GetMapping("/meals")
    public String meals...{
...
case "create":
                create(request, response);
                break;
...
}```

потом попадаем сюда:
```private void create(HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException {
        final Meal meal = new Meal(LocalDateTime.now().truncatedTo(ChronoUnit.MINUTES), "", 1000);
        request.setAttribute("meal", meal);
        request.getRequestDispatcher("/WEB-INF/jsp/mealForm.jsp").forward(request, response);
    }```

а вот дальше, я не пойму... 
после нажатия SUBMIT возникает событие POST, которое требует
```processing POST request for [/topjava/meals]```

я создал
```@PostMapping("/meals")
    public String setMeal...{
}```
НО здесь request.getParameter("action") всегда null, т.е. я не пойму как отличить create от update
и даже если просто попробовать реализовать здесь
```create((Meal) request.getAttribute("meal"));```
вылазит ошибка, что объект не новый...

Помогите разобраться.


Vitaly M. [Today at 8:10 PM]
in #hw6
Запутался я в POST и GET...

вначале отлавливаю:
 ```@GetMapping("/meals")
    public String meals...{
...
case "create":
                create(request, response);
                break;
...
}```


потом попадаем сюда:
```private void create(HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException {
        final Meal meal = new Meal(LocalDateTime.now().truncatedTo(ChronoUnit.MINUTES), "", 1000);
        request.setAttribute("meal", meal);
        request.getRequestDispatcher("/WEB-INF/jsp/mealForm.jsp").forward(request, response);
    }```


а вот дальше, я не пойму... 
после нажатия SUBMIT возникает событие POST, которое требует
```processing POST request for [/topjava/meals]```


я создал
```@PostMapping("/meals")
    public String setMeal...{
}```
НО здесь request.getParameter("action") всегда null, т.е. я не пойму как отличить create от update
и даже если просто попробовать реализовать здесь
```create((Meal) request.getAttribute("meal"));```
вылазит ошибка, что объект не новый...

Помогите разобраться.


10 replies
Pavel Klindziuk [1 hour ago]
2 метода в контроллере создай :
1 @PostMapping(/create)
2 @PostMapping(/update/{id}) (edited)


Vitaly M. [1 hour ago]
сделал, но он в них не идет, а ищет Looking up handler method for path /meals


ilya t. [1 hour ago]
>не пойму как отличить create от update
в методе который отвечает за пост можно отличать по id еды и в зависимости от этого создавать или обновлять, если я правильно понял суть вопроса

ilya t. [1 hour ago]
вообще по кускам кода тяжело смотреть что не так (edited)

Vitaly M. [1 hour ago]
Илья, а ты так делал? Что-то мне подсказывает, что подобная логика в контроллере не пройдет ревью


ilya t. [1 hour ago]
да, я в отдельный метод пост вынес реализацию создания или обновления еды, а почему не пройдет ревью, что не так? (edited)

Vitaly M. [1 hour ago]
а POST мапится /meals ?

ilya t. [1 hour ago]
у меня нет, я замапил /meals/post

ilya t. [1 hour ago]
могу в лс кинуть


Vitaly M. [1 hour ago]
кинь пжлста


Grigory Kislin [Yesterday at 11:15 PM]
in #hw6
по ТЗ - раскидать запросы по разным методам и лучше вообще без actions (edited)


1 reply
Zhivchik [12 minutes ago]
А почему лучше не использовать action, этот вариант чем то хуже?


realcorwin [11:22 PM]
не находится css-файл... <link rel="stylesheet" href="resources/css/style.css">
что не так?..

Grigory Kislin [11:29 PM]
смотри вкладку Network в браузере
