Grigory Kislin [12:54 AM]
joined #hw4.

Grigory Kislin [12:57 AM]
Добро пожаловать:
https://github.com/JavaWebinar/topjava/blob/doc/doc/lesson04.md
урок и ДЗ небольшие (хотя тема JPA обширная)
поэтому для равномерной нагрузки сделал изменения в расписании для уроков 5 и 6 (у нас был перерыв между 6 и 7). 
см. https://github.com/JavaWebinar/topjava (edited)

Daniil Kulak [1:03 AM]
joined #hw4 along with 18 others.


alexey [Today at 12:56 PM]
in #hw4
народ напомните пожалуйста директория $HOME в travis.yml что за директория и где ее прописывать? где то уже было, найти не могу.


1 reply
Grigory Kislin [5 hours ago]
это деректория на сервере travis, тебе ничего не надо прописывать. с чем вопрос связан?


realcorwin [Today at 1:20 PM]
in #hw4
популирование - это размножение в смысле? :slightly_smiling_face: то бишь заполнение базы данных?


2 replies
ilya t. [4 hours ago]
да, populate - заполнение



pro [2 hours ago]
@realcorwin populate="населить" (edited)


Artem Murk [Today at 3:48 PM]
in #hw4
Кто уже добрался до QAPlug? Плагин установился, но при попытке анализа кода вылетает ошибка, как можно полечить? Ошибка в QAPlug - Hammurapi
```Found interface com.intellij.openapi.roots.LanguageLevelModuleExtension, but class was expected```


4 replies
ilya t. [2 hours ago]
попробуй другую версию плагина, видимо конфликтует с идеей.


Artem Murk [2 hours ago]
Ага, Гугл тоже говорит что конфликт с идеей


Artem Murk [1 hour ago]
Я должен установить плагины PMD, FIndBugs and CheckStyle перед установкой Хамурапи?


Artem Murk [1 hour ago]
Отвечаю на свой же вопрос, надо было)


Vyacheslav [7:45 PM]
Что-то я не заметил на каком моменте javaee.jar в мой проект залетел. просто обнаружил его в Local Changes. Ну и в корне, в папке lib.

Ivan A [7:49 PM]
uploaded and commented on this image: Безымянный.png 

repository все равно горит красным

Yevhen Maksymovych [4:49 PM]
а после накатки патчей тесты и должны падать, или это что-то у меня криво встало?


Yevhen Maksymovych [Today at 4:50 PM]
in #hw4
 ```Error creating bean with name 'entityManagerFactory' defined in class path resource [spring/spring-db.xml]: Invocation of init method failed; nested exception is java.lang.NoClassDefFoundError: javax/xml/bind/JAXBException```


11 replies
Aleksey Vra [1 hour ago]
>Тесты и приложение ломаются. MealServiceTest починится после выполнения HW04 (JpaMealRepositoryImpl)


Yevhen Maksymovych [1 hour ago]
но это юзер, который уже вроде как полноценно имплементирован


Yevhen Maksymovych [1 hour ago]
у меня контекст не заводится


Mikhail Makar [44 minutes ago]
@Yevhen Maksymovych тесты юзера должны работать, по крайней мере у меня после накатки патчей работают.
Откатить пробовал?


Yevhen Maksymovych [44 minutes ago]
разобрался


Yevhen Maksymovych [44 minutes ago]
из-за Java9


Yevhen Maksymovych [43 minutes ago]
JAXBException перенесли в другую библиотеку


Mikhail Makar [43 minutes ago]
Да, с девяткой могут быть проблемы


aleksey [42 minutes ago]
Я вчера весь вечер бодался с этой ошибкой. Склонировал проект из гита в новую папку и все магически заработало. (edited)


Yevhen Maksymovych [39 minutes ago]
я так починил :slightly_smiling_face:


Yevhen Maksymovych [39 minutes ago]
добавил зависимость
```<dependency>
    <groupId>javax.xml.bind</groupId>
    <artifactId>jaxb-api</artifactId>
    <version>2.3.0</version>
</dependency>```


Ma3stro [5:16 PM]
uploaded and commented on this image: image.png 

IDEA почему-то ругаться стала


Viktor [7:32 PM]
@Ma3stro важный навык разработчика - имение найти ответ. Гугл тебе в помощь


qf05 [Yesterday at 7:37 PM]
in #hw4
Кто столкнулся с LazyInitializationException: could not initialize proxy - no Session подскажите, в какую сторону думать? 
И надо ли менять что то в тестах? В видео вроде говорилось что тесты у нас уже готовые, но у нас же приходит actual из нашей базы, а expected из MealTestData, но ведь в expected поля user = null. Или я что то не понимаю?


26 replies
qf05 [1 day ago]
Это конечно очень забавно, когда ставишь брекпоинт в репозитории и получаешь ошибку сравнения пользователя у еды, а если убираешь брекпоинт, то ошибку инициализации... Но у нас же не курс квантовой физики, когда от наличия наблюдателя может меняться состояние объекта!... Подскажите, чего я не понял???? Что почитать? куда смотреть?


ilya t. [1 day ago]
у нас user объявлен FetchType.LAZY, попробуй поменять на EAGER


ilya t. [1 day ago]
тоже столкнулся с таким эксепшеном, поменял fetchtype, этот эксепшн ушел, зато пришли другие :slightly_smiling_face:


Viktor [1 day ago]
https://www.google.ru/search?q=LazyInitializationException&cad=h

ilya t. [1 day ago]
короче юзеры сравниться не могут между собой поскольку ленивая загрузка как я понял


qf05 [1 day ago]
поменять на EAGER - это первое что я сделал))) 
Но у нас тогда при необходимости кому то удалить какую нибудь еду будет подниматься вся база пользователей. Надо делать Lazy. По идее сравнивать пользователей не должно быть никаких проблем, т.к. при ленивой загрузке они должны загружаться когда они нам понадобятся, а не посылать нас ... разбирать стектрейс с эксепшенами.


ilya t. [1 day ago]
ага, и еще у меня при одинаковых списках (одни и те же данные) пишется что данные разные по результату теста, это при EAGER (edited)


qf05 [1 day ago]
@Viktor Спасибо! Помогло! Вот только осталось решить надо в тестовую еду пихать тестовых юзеров или думать дальше?


Viktor [1 day ago]
@qf05 тестовые данные для каких тестов?

qf05 [1 day ago]
"Произошла незаконная операция с отражающим доступом" походу полиция java за мной уже выехала))))


qf05 [1 day ago]
@Viktor тестовые данные в MealTeastData, которые у нас захардкожены. Они вроде для всех тестов. Просто в них все поля user = null. По этому и думаю как нам сравнивать эти объекты, с теми которые у нас в базе?

Viktor [1 day ago]
@qf05 какие варианты есть? (edited)


qf05 [1 day ago]
@Viktor в смысле все поля user у еды.


qf05 [1 day ago]
@Viktor можно всей еде, захардкодить userов, что мне кажется наиболее правильным, или сравнивать еду без учета пользователя, или пихать в тестовую еду пользователя во время выполнения теста, пока больше идей нет.


Yevhen Maksymovych [1 day ago]
сравнивать без учета пользователей некорректно,мы ведь помимо прочего должны проверять, что нельзя выполнить операции с чужой едой


Yevhen Maksymovych [1 day ago]
@qf05 так как поборол ЛэйзиИнициализейшн? Сделал его егерем или фетч джойн?


qf05 [1 day ago]
если бы в видео не прозвучала фраза, что тесты у нас уже готовы, я бы не задумываясь захардкодил бы еде юзеров.

qf05 [1 day ago]
ЛэйзиИнициализейшн - Transactional на класс тестов.


Viktor [1 day ago]
@qf05 я бы сравнивал без учета пользователей. Т.е. сначала сравнил бы еду, а потом проверил бы кому она принадлежит.

qf05 [1 day ago]
Ну я захардкодил юзеров в статик блоке, не прошел только update. Чаю попью и буду разбираться дальше.


Yevhen Maksymovych [1 day ago]
а у меня наоборот, апдейт проходит, но на сейв ругается


qf05 [1 day ago]
проверь не захардкодил ли ты чего в getCreated(). или может в самом репозитории реализация что то  не делает.


Yevhen Maksymovych [1 day ago]
семён семёныч


Yevhen Maksymovych [1 day ago]
точно

qf05 [1 day ago]
А кто знает Rule все самим писать или изголяться так сказать с готовыми? Я что то туда глянул, мне не понравилось...


Grigory Kislin [24 hours ago]
почитать подсказки в уроке:
1. Если делаете debug (на тему квантовой физики)
2. Когда будете чинить MealServiceTest, помните, что тесты пишутся для приложения, а не наоборот.
(означает что не надо вводить в приложение доп. функциональность для своих тестов. нужно тесты делать основываясь на приложении) (edited)


Dmitry Neustupov [Yesterday at 7:47 PM]
in #hw4
Товарищи, подскажите, Travis работает с HSQLDB? Не могу примеров найти.


4 replies
Grigory Kislin [23 hours ago]
опиши, что делал и в чем проблема


Dmitry Neustupov [13 hours ago]
@Grigory Kislin на сайте трэвиса есть примеры подключения и создания разных баз данных, MySql, Mongo, Postgress и т.д. А по поводу HSQL инфы ноль. Оставил .yml файл без настроек для БД - сборка прошла успешно. Т.е., если БД - in memory, то для тревиса ничего прописывать не надо?


Grigory Kislin [5 hours ago]
inmemory- в памяти. не только для тревиса- никому не надо


Dmitry Neustupov [3 hours ago]
@Grigory Kislin понял, спасибо!


Grigory Kislin [10:06 PM]
commented on Ma3stro’s file image.png
IDEA написала в чем проблема..
попробуй maven reimport.
если зависимость не хочет подтягиваться -  удали ее в локальном репозитории и снова попробуй reimport

Arthur [10:54 PM]
Друзья, может я что-то пропустил, но вопрос такой: как assertMatch() сделать порядконезависимым?

Viktor [11:14 PM]
@Arthur assertMatch и так порядконезависимый :smiley: порядкозависимым другой метод

Yevhen Maksymovych [11:25 PM]
ребят, уже сломал голову, но как побороть метод save? если туда попадает на вход новый meal, ему в user подставляется em.getReference(User.class, userId), и он персистится в БД. Но если я теперь что-то попытаюсь сделать с этим meal'ом - я выхватываю эксепшн. Я так понимаю, из-за того, что по сути мой мил не был создан через EntityManager, а был собран вручную, а юзера ему подсунули не настоящего, а прокси-объект, создаваемый EM'ом, и теперь при попытке обратиться к юзеру, запрос переадресуется к проксе, а в проксе нет информации о Meal'е
ффух, как-то нелепо сформулировал, но лучше не смог
```Meal created = getCreated();
        service.create(created, USER_ID); << вот тут всё путём
        assertMatch(service.getAll(USER_ID), created, MEAL6, MEAL5, MEAL4, MEAL3, MEAL2, MEAL1); <<а вот тут created пытается обратиться к проксе```

Tanya [11:29 PM]
а ты не сравнивай по юзеру


aleksey [Yesterday at 11:31 PM]
in #hw4
Ок, нам в этом конкретном случае не нужно по юзеру сравнивать, а как быть в других случаях с другими энтити и полями? Или это и есть одна из основных болей в хибернейт?


1 reply
Grigory Kislin [5 hours ago]
мы будем даствать и юзера у еды и еду у юзера, точбы потренироваться


Yevhen Maksymovych [Yesterday at 11:34 PM]
in #hw4
но ведь мы не можем просто взять и выбросить юзера из сравнения...


1 reply
Grigory Kislin [5 hours ago]
почему неможешь:)?


Yevhen Maksymovych [11:34 PM]
uploaded this image: image.png 

Arthur [11:37 PM]
ты про MEAL6, MEAL5 и тому подобные сейчас говоришь?

aleksey [11:52 PM]
Вот раз тут уже есть дошедшие до тестов, можете пояснить, как работает lazy load. Вот я делаю getAll для Meal просто left join в query, у меня вместо юзера там заглушка. Как теперь мне его подгрузить например в том же методе getAll?
Через getUser() возвращает заглушку (edited)

Arthur [11:59 PM]
не знаю правильно я сделал или нет, но я над юзером написал 
@ManyToOne(fetch = FetchType.EAGER)

После чего он стал сразу без заглушки вытаскиваться (edited)

aleksey [12:02 AM]
ну так это понятно, так оно и работает. Я хочу понять, как через lazy load

Yevhen Maksymovych [12:21 AM]
угу, я тоже на этом несколько сломался. то ли мы отказываемся от проверки юзера в тестах и оставляем все на откуп проверкам в namedQuery, то ли дейсытно меняем все на егеря

aleksey [12:24 AM]
Видимо это потому что объект detached и вся эта магия произойдет, только если открыть новую сессию, перевести объект в persist и там уже эти lazy загрузки будут работать.
Чтоб не менять все на егеря можем явно указать в getAll "left join fetch m.user" . Но это все только в том случае, если у меня в голове не полная каша и я не несу ересь (edited)

Yevhen Maksymovych [12:27 AM]
я не настоящий сварщик, но мне кажется, что left join fetch делает то же самое, что смена типа инициализации на егеря

Viktor [12:32 AM]
@Yevhen Maksymovych юзера можно просто ручками сравнить, т.е. не класть его в тестовые данные еды. В тестах мы знаем свои тестовые данные и какая еда какому пользователю принадлежит, этим можно воспользоваться.
@aleksey смотря с какой целью хочешь вытащить пользователя. Если что-то в нем посмотреть, то доверь это хибернейту и lazyLoad. Если отдать куда-то наружу, тут появляются проблемы и надо выкручиваться, по разному делают :smiley:

aleksey [12:35 AM]
@Yevhen Maksymovych но делает это конкретно в одном методе а не глобально, а по умолчанию. Вдруг ты в getBetweenl не хочешь такого результата. 
Я, если правильно понял, надо ручками сессии создавать для lazy load, мы используем EntityManager, он является оберткой над Session, и мы просто не имеем возможности что-то явно делать с объектом когда он в состоянии persist внутри EntityManager.
А когда он вне его, он уже detached (edited)

Yevhen Maksymovych [12:38 AM]
@Viktor, ок, мы выбросим проверку юзера из ассертов, и будем просто в тестах подставлять нужные милы. Но как быть с этим?
```@Test(expected = NotFoundException.class)
    public void updateNotFound() throws Exception {
        service.update(MEAL1, ADMIN_ID);
    }```
здесь проверка должна быть на стороне сервиса. Если в MEAL1 нет информации о юзере, как мы его проверим на не соответствие админу?

Viktor [12:39 AM]
@Yevhen Maksymovych ты точно знаешь какая еда и какому юзеру принадлежит (в тестовых данных) + ты можешь получить юзера при lazy load у meal, ну а дальше сам придумай :smiley:

Yevhen Maksymovych [12:40 AM]
что-то уже голова не варит. пойду спать, завтра на свежую голову начну решать.
что-то мне кажется, Григорий нас обманул, что это задание самое короткое :slightly_smiling_face:

Arthur [12:41 AM]
оно по объему нового кода наверно короткое... (edited)

Viktor [12:43 AM]
не, просто я может быть вас не туда веду...

aleksey [12:47 AM]
@Viktor вот ты говоришь, доверься хибернейту и lazy load. Можешь привести пример кода lazy load ?

Yevhen Maksymovych [12:47 AM]
гхм
я вот только что заметил
что я тут демагогствую последние два часа, а тесты не провожу
а они-то проходят
когда это они проходить стали-то, непонятно

Arthur [12:48 AM]
может они по ошибке проходят :slightly_smiling_face:

Viktor [12:48 AM]
@aleksey не совсем понял. Lazy load поле а весь код - поле в аннотации (edited)

Arthur [12:50 AM]
у меня save и update сейчас не проходят, потому что вместо юзера стоит заглушка. Несмотря на то, что включена EAGER

aleksey [12:51 AM]
@Viktor Предположим я получил из базы Meal, но не с EAGET  а с LAZY, как мне подгрузить юзера?

Viktor [12:52 AM]
meal.getUser()

Arthur [12:52 AM]
где ты это напишешь?

aleksey [12:52 AM]
@Viktor ты пробовал? Что-то ты упускаешь из описания. (edited)

Yevhen Maksymovych [12:53 AM]
но это сработает, если meal получен из энтитиманагера, а не сформирован локально

Viktor [12:53 AM]
там где мне понадобится пользователь, да пробовал :smiley:
@aleksey ты наверно про LazyLoadException, но она выбрасывается не из-за обращения к lazy полю, точнее из-за этого, но там ещё одно важное обстоятельство.
@Yevhen Maksymovych насчет локально собранного, честно не знаю. Ну при обращении к заглушке полученной getReference будет либо ошибка либо прокси. Если прокси то проблем нет, если ошибка, то решать её
https://docs.oracle.com/javaee/7/api/javax/persistence/EntityManager.html#getReference-java.lang.Class-java.lang.Object-
доки говорят, что все будет норм :slightly_smiling_face: (edited)

Yevhen Maksymovych [12:59 AM]
короче, ладно, парни, я спать, чтобы не мучались, добавляйте к тестам @Transactional, так лэйзи будет работать

aleksey [1:19 AM]
Спасибо, это одна из причин по которой у меня все криво было.

Aleksey Vra [7:30 AM]
>ВНИМАНИЕ: патч меняет postgres.properties
>IDEA может ${jdbc.initLocation} подчеркивать красным - тупит...
оставить как есть? или както лечится? (edited)

Yevhen Maksymovych [9:07 AM]
тут должна быть картинка с подмигивающим микки-маусом и надписью "да и черт с ним"


Vitaly M. [Today at 9:13 AM]
in #hw4
Как правильно query написать?
```SELECT m FROM Meal m WHERE m.user=?1 AND m.dateTime BETWEEN ?2 AND ?3 ORDER BY m.dateTime DESC"```
у меня в этом запросе
```AND m.dateTime BETWEEN``` 
ругается, что m.dateTime - Tipe mistmach


4 replies
Yevhen Maksymovych [12 hours ago]
он будет ругаться, но выполнит корректно. насколько я понимаю, hsql уже научился работать с LocalDateTime, а валидатор идеи пока об этом не знает

Vitaly M. [12 hours ago]
ну я так и мыслил, но решил спросить )
а еще вопрос, я правильно понял синтаксис ?1 ?2 ?3, это он будет брать переменные по порядку ?


qf05 [11 hours ago]
тоже с этим столкнулся и решил что >= и <= вместо BETWEEN более красиво, т.к. идея на это не ругается.


Dmitry Neustupov [10 hours ago]
@Vitaly M. да, по порядку


Arthur [Today at 11:53 AM]
in #hw4
кто-нибудь optional смотрел уже?
Я про Rule... (edited)


5 replies
Yevhen Maksymovych [10 hours ago]
Да, там все просто на самом деле


Pavel Zaitcev [9 hours ago]
Да, все есть по ссылке что дана в задании. А итоговую сводку (п. 3.3) сделал через @AfterClass.


Arthur [9 hours ago]
я про время выполнения не сразу нашел...


Yevhen Maksymovych [9 hours ago]
я просто создал анонимный класс на основе TestWatcher'а, в нём можно зафиксировать время перед тестом и после


Arthur [8 hours ago]
ты самопальным путем время высчитываешь?
Я нашел способ: TimeUnit


Oleksii Leshchenko [Today at 12:16 PM]
in #hw4
Ради интереса, почему мы перешли на HSLDB с PostgreSQL? Просто для тренировки охватить по-больше продуктов/технологий?



1 reply
Grigory Kislin [5 hours ago]
мы не перешли:) в xml остался postgres. ввели- да, потренироваться (edited)


Dmitry Neustupov [12:18 PM]
@Oleksii Leshchenko hsqldb быстрее работает, удобно использовать на тестах, имхо.


Oleksii Leshchenko [Today at 1:00 PM]
in #hw4
Тоже чисто ради интереса...
В https://en.wikibooks.org/wiki/Java_Persistence/ManyToOne используется 2 референса одновременно: @ManyToOne и @OneToMany.... Мы же используем только @ManyToOne.... Почему?


1 reply
Oleksii Leshchenko [9 hours ago]
Хммм. Нашел ответ в 1м же абзаце в той статье:
>A ManyToOne relationship in Java is where the source object has an attribute that references another object, the target object. I.e. the rather typical Java case that one object holds a reference to another object. A ManyToOne relationship can be specified unidirectional. However, it is typical that the target object has the inverse relationship specified back to the source object. This would be a OneToMany relationship specification in the target object. All relationships in Java and JPA are unidirectional, in that if a source object references a target object there is no guarantee that the target object also has a relationship to the source object. This is different than a relational database, in which relationships are defined through foreign keys and querying such that the inverse query always exists.
(edited)


Anton Kiselev [1:00 PM]
Подскажите, у кого-нибудь было подобное?
```java.lang.AssertionError: 
Expecting value <null> in field <"user"> but was <User{id=100001, email=admin@gmail.com, name=Admin, enabled=true, roles=[ROLE_ADMIN], caloriesPerDay=2000}> in <Meal{id=100008, dateTime=2015-06-01T14:00, description='Админ ланч', calories=510}>.
Comparison was performed on all fields```

запускаю тест get. в assertMatch вижу что приходят оба Meal потом магия и null.


Oleksii Leshchenko [Today at 1:25 PM]
in #hw4
У нас добавилось новое поле в *Meal* - `User user`. Ранее его не было. И я так подозревая, в сервис приходит Meal без юзера. У нас есть только user_id при этом. Т.е. для сохранения через JPA мне надо создать пустого юзера и передать ему только свой id... Так?


1 reply
ilya t. [8 hours ago]
в подсказках первый пункт


Oleksii Leshchenko [3:06 PM]
У меня тест для get() падает на `assertMatch`.
Если юзер в мил прописан так:
`@ManyToOne(fetch = FetchType.LAZY)`
`@JoinColumn(name = "user_id")`
`@NotNull`
`private User user;`
то при сравнении ошибка:
LazyInitializationException: could not initialize proxy - no Session
А если вместо LAZY поставить EAGER, то вылетает с :
Expecting value <null> in field <"user"> but was <User{id=100001, ....}>.

Viktor [3:21 PM]
@Oleksii Leshchenko а какое поведение тебе нужно?

Oleksii Leshchenko [3:22 PM]
assertMatch должен сравнить 2 объекта и не вылетить по эксепшену. Пока только могу поставить поле user в игнор при сравнении объектов

Arthur [3:24 PM]
если идти по этому пути, можно таким же макаром и другие поля заигнорить


druxa [Today at 3:25 PM]
in #hw4
Не могу запустить тесты MealServiceTest и UserServiceTest из-за SLF4JBridgeHandler IDEA пишет Error:(5, 24) java: package org.slf4j.bridge does not exist


2 replies
Arthur [6 hours ago]
в мавене этот пакет есть?


Arthur [6 hours ago]
jul-to-slf4j


druxa [3:27 PM]
патч не правильно накатил или библиотека не загрузилась?

druxa [3:33 PM]
да есть, посмотрел в загруженных библиотеках в jar там один класс SLF4JBridgeHandler
Arthur
jul-to-slf4j
From a thread in #hw4
Today at 3:28 PM


Arthur [Today at 3:37 PM]
in #hw4
идея этот импорт подсвечивает как ошибка?
import org.slf4j.bridge.SLF4JBridgeHandler;


1 reply
druxa [6 hours ago]
Нет


Viktor [Today at 3:52 PM]
in #hw4
@druxa удали библиотку из локального репозитория и сделай reimport, может во время загрузки что-то сломалось


4 replies
druxa [6 hours ago]
из локального это .m2? удалил и сделал   reimport не помогло


Grigory Kislin [5 hours ago]
похоже у тебя чтото с проектом-идеей
1. пропробуй запустить не из idea: mvn test
2. я вчекинил патчи- попробуй сделать git clone и сделать в новом проекте


druxa [4 hours ago]
первый пункт не понял как сделать, а второй сделал clone и проблема решилась, только запутался, в MealServiceTest 3 теста прошли из 9, это потому что JpaMealRepositoryImpl заглушка?


Grigory Kislin [4 hours ago]
> первый пункт не понял как сделать
из cmd либо terminal в каталоге проекта набери: mvn test
> только запутался
я все таки призываю вас начинать думать, а не просто патчи накатывать...
есть дебаг, есть логирование (edited)


Viktor [3:54 PM]
@Oleksii Leshchenko ну тогда просто во время сравнения лови Throwable и возвращай true, объекты будут сравниваться, а если вдруг вылетит Exception любой, ты его поймаешь и все будет хорошо :slightly_smiling_face:

Grigory Kislin [4:47 PM]
Дополнил п.5:

*5: Когда будете чинить MealServiceTest, помните, что тесты пишутся для приложения, а не наоборот. Это означает, что если нашему приложению `Meal.user` не требуется, не следует его доставать исключительно для тестов. В следующем уроке мы будет разными способами доставать зависимости `Meal.user` и `User.meals`*

Aleksey Vra [5:37 PM]
>database.url=jdbc:hsqldb:file:media/vra/temp
путь должен начинаться без слеша.. мож кому пригодится


Aleksey Vra [Today at 6:01 PM]
in #hw4
почему не проходит тест на удаление? записи же одинаковые
>>>java.lang.AssertionError: 
Expecting:
<"[Meal{id=100007, dateTime=2015-05-31T20:00, description='Ужин', calories=510},
   Meal{id=100006, dateTime=2015-05-31T13:00, description='Обед', calories=1000},
   Meal{id=100005, dateTime=2015-05-31T10:00, description='Завтрак', calories=500},
   Meal{id=100004, dateTime=2015-05-30T20:00, description='Ужин', calories=500},
   Meal{id=100003, dateTime=2015-05-30T13:00, description='Обед', calories=1000}] (ArrayList@3a342944)">
to be equal to:
<"[Meal{id=100007, dateTime=2015-05-31T20:00, description='Ужин', calories=510},
   Meal{id=100006, dateTime=2015-05-31T13:00, description='Обед', calories=1000},
   Meal{id=100005, dateTime=2015-05-31T10:00, description='Завтрак', calories=500},
   Meal{id=100004, dateTime=2015-05-30T20:00, description='Ужин', calories=500},
   Meal{id=100003, dateTime=2015-05-30T13:00, description='Обед', calories=1000}] (ArrayList@3a342944)">
but was not.


3 replies
ilya t. [4 hours ago]
выше в ветках обсуждалось - по юзеру еще сравнение идет


ilya t. [4 hours ago]
т.е. насколько я понял нам на данном этапе надо исключить сравнение по юзеру


Aleksey Vra [3 hours ago]
спс, разобрался


Vitaly M. [Today at 6:02 PM]
in #hw4
тяжело мне тесты даются...
Вот тест
```service.delete(MEAL1_ID, USER_ID);```
Вот вывод теста
```Hibernate: 
    /* Meal.delete */ delete 
    from
        meals 
    where
        id=? 
        and user_id=?```
Чего там около id=? и user_id=? пусто?


3 replies
Grigory Kislin [4 hours ago]
если хочется значения нужно или уровень дебага ставит trace или использовать jdbc4j вроде. в видео Круглова про нее есть


Vitaly M. [3 hours ago]
trace не помог ))) сделал простынку раз в 10 длиннее, но id=? и user_id=? пустыми так и остались...
Ладно это не важно, просто запомню, что так задумано )


Viktor [3 hours ago]
@Vitaly M. хибернейт всегда так пишет. Но есть какой-то хак, который это исправляет, погугли


Grigory Kislin [19 hours ago]
https://www.google.ru/search?q=hibernate+show+parameters+in+log


realcorwin [Yesterday at 9:57 PM]
in #hw4
у кого-нибудь ещё QAPlugin с "потомками" отказывался работать после инсталляции?


2 replies
Grigory Kislin [19 hours ago]
у меня счас EAP 2018.1- все ок
попробуй idea обновить (хотябы до 2017.3.5)


realcorwin [19 hours ago]
ок. у меня сейчас 2.6. спасибо


poleg [Yesterday at 10:07 PM]
in #hw4
При накате патча 4_3_improve_code.patch выдается сообщение: File to patch found outside content root: .travis.iml. Этот файл почему-то создается выше папки проекта. Что я делаю не так?


2 replies
Grigory Kislin [19 hours ago]
трудно сказать, не зная как ты патч накатываешь (edited)


poleg [19 hours ago]
Как обычно, правой кнопкой мыши - применить патч. \


Aleksey Vra [Today at 12:02 AM]
in #hw4
что то с update никак не выходит, не такое уж простое ДЗ, прошлое гораздо легче было как мне кажется


1 reply
Ilya [9 hours ago]
главное из подсказок учесть все пункты (особенно 1й и 5й) и тогда все ок!


AntonY [Today at 1:21 PM]
in #hw4
Перечитал все комментарии в теме, но так и не понял в какую сторону двигаться.

Аксакалы советуют (если я правильно все понял) совсем убрать userId из сравнения.
В данных, которые мы берем из базы юзера не будет, так как он lazy и в наших тестовых данных его тоже нет.
Но при таком варианте как обеспечить достоверное сравнение?
Моя голова не способна этого постичь. Нужна помощь.


6 replies
ilya t. [5 hours ago]
5: Когда будете чинить MealServiceTest, помните, что тесты пишутся для приложения, а не наоборот. Это означает, что если нашему приложению `Meal.user` не требуется, не следует его доставать исключительно для тестов. В следующем уроке мы будет разными способами доставать зависимости `Meal.user` и `User.meals`

так что да, убирай


AntonY [5 hours ago]
Спасибо. Из сравнения уберу, но ощущение, что тест после этого станет бесполезным меня не покидает :slightly_smiling_face:


Aleksei Kirillov [5 hours ago]
Посмотрел, что в тестировании jdbc user равен null, значит не сравнивается. Поэтому и в jpa убрал.


AntonY [4 hours ago]
@Aleksei Kirillov спасибо большое за наводку. Я кажется начал понимать как работает то, что я пишу :wink:
Вся магия сравнения происходит на уровне репозитория, а там у нас все есть в полном объеме.


Grigory Kislin [3 hours ago]
ты же достаешь из базы по user_id надеюсь. как же он может быть недостоверный? какой смысл его сравнивать с user_id... (edited)


AntonY [3 hours ago]
@Grigory Kislin согласен. когда до этого доходишь становится очевидно, а тех пор "загадка".


Anton Kiselev [Today at 2:58 PM]
in #hw4
У кого какой метод дольше всех отрабатывает?)


7 replies
Arthur [3 hours ago]
delete, updateNotFound (hsqldb:file) (edited)


Arthur [3 hours ago]
Самая быстрая база - hsqldb:mem.
К моему удивлению - Postgres и hsqldb:file дают очень близкий результат (edited)


Anton Kiselev [3 hours ago]
у меня update самый долгий. подозреваю что криво сделал (edited)


Arthur [3 hours ago]
Меня печалит другой момент: то что на фоне общего времени загрузки приложения - выйгрыш от применения hsqldb:mem сводится к нулю.


Arthur [3 hours ago]
Общее впемя выполнения теста:
hsqldb:file 11с
hsqldb:mem 10с
postgres 11с (edited)


Yevhen Maksymovych [1 hour ago]
да откуда взяться разнице-то? hsqldb:file читает из файла перед, и записывают в память после сеанса. постгрес аналогично, по дефолту, емнип, 256мб сразу в память читает. учитывая, что размер нашей бд копеечный, во всех трёх случая операции выполняются в памяти


Aleksey Vra [22 minutes ago]
у меня updateNotFound самый долгий и save


poleg [5:51 PM]
Тестирую     public List<Meal> getAll(int userId) {
       return em.createNamedQuery(Meal.ALL_SORTED, Meal.class).setParameter("user_id", userId).getResultList();
   }
Получаю:
java.lang.AssertionError: 
Expecting:
<"[Meal{id=100007, dateTime=2015-05-31T20:00, description='Ужин', calories=510},
   Meal{id=100006, dateTime=2015-05-31T13:00, description='Обед', calories=1000},
   Meal{id=100005, dateTime=2015-05-31T10:00, description='Завтрак', calories=500},
   Meal{id=100004, dateTime=2015-05-30T20:00, description='Ужин', calories=500},
   Meal{id=100003, dateTime=2015-05-30T13:00, description='Обед', calories=1000},
   Meal{id=100002, dateTime=2015-05-30T10:00, description='Завтрак', calories=500}] (ArrayList@c5285de)">
to be equal to:
<"[Meal{id=100007, dateTime=2015-05-31T20:00, description='Ужин', calories=510},
   Meal{id=100006, dateTime=2015-05-31T13:00, description='Обед', calories=1000},
   Meal{id=100005, dateTime=2015-05-31T10:00, description='Завтрак', calories=500},
   Meal{id=100004, dateTime=2015-05-30T20:00, description='Ужин', calories=500},
   Meal{id=100003, dateTime=2015-05-30T13:00, description='Обед', calories=1000},
   Meal{id=100002, dateTime=2015-05-30T10:00, description='Завтрак', calories=500}] (ArrayList@c5285de)">
but was not.
Почему тест не проходит, ведь данные одинаковые?

Kashchavtsev Andrey [30 minutes ago]
В тестовых данных в еду добавь юзера


Aleksey Vra [30 minutes ago]
чуть выше вопрос я задавал, и еще выше обсуждалось


Aleksey Vra [29 minutes ago]
не нужно юзера добавлять


poleg [18 minutes ago]
Спасибо, помогло. Мда, чем дальше в лес, тем толще партизаны. HW03 было попроще.


dmitry_ov [5:56 PM]
@Grigory Kislin lombok можно использовать при решении ДЗ ?


Nedfrench [6:25 PM]
Пугает большое количество используемых в проекте аннотаций jpa.


Ma3stro [Today at 6:38 PM]
in #hw4
Как сделать в Meal.java foreign key на userId, имея юзера?..


1 reply
poleg [32 minutes ago]
@JoinColumn(name = "user_id", nullable = false)


Ma3stro [7:04 PM]
У меня во всех тестах вылетает NPE.
После всех патчей, как вижу, проект продолжает работать с postgres, с ней и тестирую, но такое чувство, будто данные с базы просто не видны приложению:/
Не могу разобраться (edited)


Nedfrench [7:10 PM]
Господа, а как hibernate узнает к какой базе коннектиться? Не видать файл конфигурации.

Ma3stro [7:10 PM]
`<context:property-placeholder location="classpath:db/postgres.properties" system-properties-mode="OVERRIDE"/>` (edited)


Nedfrench [1 day ago]
Спасибо, в видео "ORM. Hibernate. JPA."упустил этот момент.


Yevhen Maksymovych [7:38 PM]
ребят, а почему в пропертях, которые мы указываем в .xml конфиге практически все проперти (доступные) дублируются как property и property-ref. Т.е. есть "dataSource" и "dataSource-ref", "packagesToScan" и "packagesToScan-ref". Но мы используем именно dataSource-ref, но packagesToScan (не-реф)?


Yevhen Maksymovych [Yesterday at 7:39 PM]
in #hw4
ну, т.е. понятно, что в другом случае контекст просто не заведётся, я уже проверил, но что это за -ref? я посмотрел в исходниках бина, там ничего подобного нет


4 replies
Yevhen Maksymovych [1 day ago]
не, всё ок


Yevhen Maksymovych [1 day ago]
с -ref ты указываешь в качестве параметра бины


Yevhen Maksymovych [1 day ago]
а без ref стринги


Grigory Kislin [10 hours ago]
ref- это ссылка на объявленный уже бин
если он нужен нескольким другим бинам- только через него


qf05 [Yesterday at 8:17 PM]
in #hw4
Блин, я всё таки не понимаю, почему мы должны иметь в еде юзера, а не просто int с его id. Это же намного проще.


5 replies
Viktor [1 day ago]
а как в таком случае получить юзера?


qf05 [1 day ago]
а нафиг нам юзер в еде вообще нужен? у нас везде где еда юзера касается ей только его айди нужен.


qf05 [1 day ago]
например: 
если у еды id юзера - то это как у тебя в шкафу висит 20 костюмов, они твои потому что на них бирочка с твоим именем.
если у еды есть юзер - то это как у тебя есть 20 костюмов, и они твои потому что каждый надет на твоего клона.


Viktor [23 hours ago]
Тут скорее для удобства, для более простых модификаций в будущем. Ведь если тебе в еде понадобиться ещё и имя пользователя, то либо ещё одну колоку заводи, либо переписывай все обращения с id на user.id


Grigory Kislin [10 hours ago]
в п.5: В следующем уроке мы потренируемся разными способами доставать зависимости Meal.user и User.meals


Ma3stro [Yesterday at 8:18 PM]
in #hw4
Подскажите, пожалуйста, почему следующий код отказывается работать:
JpaMeal:
    ```@Override
    @Transactional
    public boolean delete(int id, int userId) {
        return em.createNamedQuery(Meal.DELETE, Meal.class)
                .setParameter("id", id)
                .setParameter("user_id", userId)
                .executeUpdate() != 0;
    }```
В Meal:
 ```@NamedQuery(name = Meal.DELETE, query = "DELETE FROM Meal m WHERE m.id=:id AND m.user.id=:user_id"),``` 


У меня на всех тестах просто NPE вылетает


26 replies
ilya t. [1 day ago]
А для delete разве пишется Meal.class?


ilya t. [1 day ago]
Попробуй удали (edited)


qf05 [1 day ago]
em.createNamedQuery(Meal.DELETE)...


Ma3stro [1 day ago]
@ilya t., @qf05
Да, действительно, исправил. Но у меня по прежнему NPE... У меня нигде при run'e не фигурируют данные из базы, как это было в примерах выше от других (edited)

ilya t. [1 day ago]
@Ma3stro проверь популируется ли бд


ilya t. [1 day ago]
Потому что куери и метод такой же у меня и все работает


Ma3stro [1 day ago]
@ilya t. сама бд непосредственно популируется, вижу все тестовые данные справа во вкладочке. Возможно, я неправильно сделал Meal entity hibernate?
```@NamedQueries({
        @NamedQuery(name = Meal.DELETE, query = "DELETE FROM Meal m WHERE m.id=:id AND m.user.id=:user_id"),
        @NamedQuery(name = Meal.ALL, query = "SELECT m FROM Meal m LEFT JOIN FETCH m.user.id ORDER BY m.dateTime DESC"), //на исправление
        @NamedQuery(name = Meal.ALL_BETWEEN, query = "SELECT m FROM Meal m WHERE m.user=?1 AND m.dateTime BETWEEN ?2 AND ?3 ORDER BY m.dateTime DESC")
})
@Entity
@Table(name = "meals")
public class Meal extends AbstractBaseEntity {

    public static final String DELETE = "Meal.delete";
    public static final String ALL = "Meal.getAll";
    public static final String ALL_BETWEEN = "Meal.getBetween";

    @Column(name = "date_time")
    @NotNull
    private LocalDateTime dateTime;

    @Column(name = "description")
    @NotBlank
    private String description;

    @Column(name = "calories")
    @NotNull
    private int calories;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", nullable = false)
    private User user;
***Геттеры и сеттеры***```


ilya t. [1 day ago]
Джойн фетч убери

ilya t. [1 day ago]
И сделай просто через where с сортировкой

ilya t. [1 day ago]
А, она у тебя есть


qf05 [1 day ago]
илья, можешь объяснить в двух словах что такое этот джойн фетч лефт, я уже кучу статей перечитал, но там всё так заумно, никак не могу понять суть.


Ma3stro [1 day ago]
Я исправлю эти запросы с getAll. Я хочу понять, почему у меня тот же delete не работает

ilya t. [1 day ago]
@Ma3stro с энтити вроде порядок, значит не здесь


ilya t. [1 day ago]
@qf05 https://stackoverflow.com/questions/6838574/difference-between-left-join-and-left-join-fetch-in-hibernate
Fetch в hibernate говорит загрузить полностью вместо ленивой загрузки.
LEFT JOIN - это запрос который возвращает все записи из левой таблицы а из правой только если условие удовлетворяется
stackoverflow.com
Difference between LEFT JOIN and LEFT JOIN FETCH in Hibernate?
I am trying to understand the difference between LEFT JOIN and LEFT JOIN FETCH in Hibernate. Can anyone explain this? Thanks
 


qf05 [1 day ago]
маэстро, не много не в тему, но у тебя calories это int, они и так не могут быть null, там должно быть другое ограничение.

ilya t. [1 day ago]
https://www.w3schools.com/sql/sql_join_left.asp
w3schools.com
SQL LEFT JOIN Keyword
Well organized and easy to understand Web building tutorials with lots of examples of how to use HTML, CSS, JavaScript, SQL, PHP, and XML.


ilya t. [1 day ago]
Соответственно тем записям которым условие не удовлетворяется в колонке второй таблицы ставится null (edited)

qf05 [1 day ago]
спасибо, ещё бы понять что значит левая, и правая таблица...

ilya t. [1 day ago]
@qf05 иди на тот сайт что выше и посмотри наглядно, нажми там try it to yourself и запусти запрос (edited)


ilya t. [1 day ago]
@qf05 сразу поймёшь

ilya t. [1 day ago]
@qf05 если не понял то скажи


Ma3stro [1 day ago]
Исправил NPE добавив уникальность в Meal для user_id и date_time


qf05 [1 day ago]
@ilya t. то есть создаётся как бы отдельная таблица из значений в которую попадает выбранная колонка из 1-й таблицы и выбранная колонка из 2-й таблицы, но во второй колонке если значения нет или оно не удовлетворяет условию то ставится null


ilya t. [1 day ago]
@qf05 да все именно так. Собственно синтаксис запроса говорит сам за себя :)


ilya t. [1 day ago]
@qf05 join - объединение


qf05 [1 day ago]
@ilya t. спасибо, вроде понял)


knkv [Yesterday at 8:19 PM]
in #hw4
Из-за чего может вылетать такая ошибка?
Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name ‘entityManagerFactory’ defined in class path resource [spring/spring-db.xml]: Invocation of init method failed; nested exception is javax.persistence.PersistenceException: [PersistenceUnit: default] Unable to build Hibernate SessionFactory


21 replies
Yevhen Maksymovych [1 day ago]
не девятая ли джава часом?


knkv [1 day ago]
Нет.  “1.8.0_151”


Yevhen Maksymovych [1 day ago]
а весь стектрейс покажи


knkv [1 day ago]
https://gist.github.com/vknk/3e607be2c37e53ef2cb6f13632bba06f


Yevhen Maksymovych [1 day ago]
синтаксическая ошибка в @NamedQuery


knkv [1 day ago]
Понял, будем разбираться. Спасибо.


Yevhen Maksymovych [1 day ago]
а зачем ты вручную через namedQuery его вообще вставляешь? оставил бы на откуп EntityManager'у, у тебя ведь нет какой-то хитрой механики по обработке полей перед вставкой, а "как есть" записываешь


knkv [1 day ago]
Если Как есть, то без user id же будет записываться.

Yevhen Maksymovych [1 day ago]
странно, у меня с юзером всё ок записывается

knkv [1 day ago]
em.persist(meal) - нормально отрабатывает?


Yevhen Maksymovych [1 day ago]
ага


knkv [1 day ago]
Ок. Может у меня ошибка в другом месте.

qf05 [1 day ago]
а ты перед персист кладёшь рефернс на юзера в еду?


Yevhen Maksymovych [1 day ago]
ага

knkv [1 day ago]
Да, пришлось подсказки подсмотреть))

Yevhen Maksymovych [1 day ago]
:+1:

knkv [1 day ago]
А как meal c id возвращать?)


Yevhen Maksymovych [1 day ago]
да он после persist() будет заполнен


Yevhen Maksymovych [1 day ago]
просто возвращаешь этот же meal


knkv [1 day ago]
Действительно. Как это? :thinking_face:


Yevhen Maksymovych [1 day ago]
магия jpa :slightly_smiling_face:


Andrew Manik [10:57 PM]
Думаю пригодится кому-нибудь, особенно когда будете делать свой проект:

когда мы добавляем в spring_db.xml namespase "tx" Intellij IDEA делает такой финт
xmlns:tx="http://www.springframework.org/schema/cache" 
и еще такой
xsi:schemaLocation=...http://www.springframework.org/schema/cache
http://www.springframework.org/schema/cache/spring-cache.xsd...

что приводит вот к этому: 
Caused by: org.springframework.beans.factory.NoSuchBeanDefinitionException: No bean named 'cacheManager' available

Я наткнулся на эту штуку, т.к. делаю параллельный проект, т.е. просто по видео Григория набиваю код и правлю, чтобы работало
(в противном случае моя "запоминалка" работает значительно хуже), это я к тому, что при накатке патчей получается нормальный неймспейс и проблемы не возникает.

Лечится это просто (перебивается руками):
xmlns:tx="http://www.springframework.org/schema/tx"
xsi:schemaLocation=... http://www.springframework.org/schema/tx
http://www.springframework.org/schema/tx/spring-tx.xsd (edited)

Kirilo [2:01 AM]
фу-ух... Вот это упражнение на внимательность... postgres.properties как-то криво накатился... Неужели так и нужно его подправлять?

Хэм [3:44 AM]
Использовать hibernate sessionFactory или JPA entityManager?
на сколько важно использование одного или другого?

Хэм [3:52 AM]
если делать на JPA, то можно будет в любой момент поменять вендора(т.е. Hibernate на какой-нибудь другой). А если такого не планируется, то можно на Native API.
Так зачем тогда вообще нужен JPA, и что он из себя представляет? По аналогии с slf4j и log4j могу предположить, что JPA(как slf4j в логах) - это такая "обертка", под которой должен работать какой-то конкретный вендор. Так ли это?
Использовать Hibernate API однозначно. Это поможет понять лучше сам ORM и получить доступ к функциональности большей чем JPA.
А история здесь такая. J2EE это набор спецификаций. Чтобы получить J2EE сертификацию серверу необходимо пройти огромный набор определенных тестов. Таким образом официально J2EE совместемый сервер это уже залог некоторого достаточно высокого качества.

В старых версиях J2EE было некоторое подобие ORM, где приходилось делать выбор между "быстро делаем, медленно работает" и "долго делаем, быстро работает". Hibernate же предлагал разработчикам полноценный ORM, который включал лучшее из этих двух вариантов. Поэтому Hibernate на несколько лет стал стандартом де-факто в J2EE. В конце концов такой хороший ORM нельзя было не стандартизировать. Так и появилась спецификация JPA, которая основана на Hibernate, даёт простор другим вендорам и является частью J2EE.


Ilya [Today at 8:58 AM]
in #hw4
@Grigory Kislin Пытаюсь осознать все происходящее, остались вопросы:
1. На данный момент в проекте в POM есть зависимость:
<artifactId>spring-orm</artifactId>
Мы это с учетом на следующий урок сделали ? У нас же, вроде как, на данный момент хибернейт везде используется.

2. Стало интересно по поводу Spring Boot - получается так, что если мы используем spring-boot-starter-data-jpa из коробки, то в нем встроены как <artifactId>hibernate-core</artifactId> так и <artifactId>spring-data-jpa</artifactId>. Если я, допустим, использую аннотации JPA для маппинга entity, то там юзается hibernate автоматом, а когда делаю класс репозитория для работы с БД и использую JpaRepository или CrudRepository, т.е. использую spring-data-jpa для работы с БД. Вопрос - это ведь нормальная практика, мешать одно с другим ?  Понимаю, что делают они разные вещи, но стало интересно. (edited)


3 replies
Grigory Kislin [10 hours ago]
1. это же проще чем вопрос писать- попробуй вернуть как было и скомпилить
2. хибернате под jpa везде используется. data-jpa у нас впереди, но если когда например нужен для запроса другой entity, мы будем челать  чз EntityManager (edited)


Ilya [9 hours ago]
@Grigory Kislin да, спасибо. судя по всему entityManagerFactory живет в спринговском api, а без него никуда. 
Еще вопрос -  мы entityManager не закрываем явно в коде, как в нашем случае жизненный цикл entity происходит, разве не буду копиться объекты в persistence-context постоянно ? 
гуглил, не совсем понял, как приминимо к нашему случаю.


Grigory Kislin [9 hours ago]
по поводу что такое EntityManager у меня вроде в видео будет. это под капотом каждый раз обертка над hibertate factory создается


Yevhen Maksymovych [10:29 AM]
+пару дней назад тоже на это наткнулся :slightly_smiling_face:


poleg [Today at 10:47 AM]
in #hw4
А почему в JpaUserRepositoryImpl в гетах в createNamedQuery мы передаем User.class, а в delete - нет?
em.createNamedQuery(User.ALL_SORTED, User.class).getResultList();
em.createNamedQuery(User.BY_EMAIL, User.class)

em.createNamedQuery(User.DELETE)


4 replies
dustnfox [11 hours ago]
`get` заканчивается `getResultList` который должен вернуть entity, чтобы собрать сущность ему нужно знать ее класс. У `delete` такой необходимости нет. Он заканчивается  `executeUpdate` и возвращает лишь число entity которые попали под запрос.



AntonY [11 hours ago]
@dustnfox а как такое же выделение красным делать?


dustnfox [11 hours ago]
` вот такими символами выделяй. Это кнопка с буковой ё на клавиатуре :slightly_smiling_face: (edited)


AntonY [11 hours ago]
`спасибо`


Ivan Koshelia [12:13 PM]
тестирую  @Override
   @Transactional
   public boolean delete(int id, int userId) {
       return em.createQuery("DELETE FROM Meal m WHERE m.id=:id AND m.user.id=:user_id")
               .setParameter("id", id)
               .setParameter("user_id", userId)
               .executeUpdate() != 0;
   } и получаю org.hibernate.LazyInitializationException: could not initialize proxy - no Session
    at org.hibernate.proxy.AbstractLazyInitializer.initialize(AbstractLazyInitializer.java:155)
    at org.hibernate.proxy.AbstractLazyInitializer.getImplementation(AbstractLazyInitializer.java:268)
    at org.hibernate.proxy.pojo.javassist.JavassistLazyInitializer.invoke(JavassistLazyInitializer.java:73)
    at ru.javawebinar.topjava.model.User_$$_jvst260_0.equals(User_$$_jvst260_0.java)
    at org.assertj.core.util.Objects.areEqual(Objects.java:41)
    at org.assertj.core.internal.Objects.propertyOrFieldValuesAreEqual(Objects.java:675)
    at org.assertj.core.internal.Objects.isEqualToIgnoringGivenFields(Objects.java:651)
    at org.assertj.core.internal.Objects.areEqualToIgnoringGivenFields(Objects.java:790)   В чем может быть проблема?

Oleksii Leshchenko [10 hours ago]
в assertMath идет сравнение по всем полям, включая User. Этот Юзер не может подтянуться из базы в Мил. Для тестов надо исключить сранение по полю Юзер



Oleksii Leshchenko [10 hours ago]
@Ivan Koshelia ответ выше)


saudabaew [Today at 12:45 PM]
in #hw4
А такой ошибки ни у кого не было? 
16:45:36.534 ERROR org.hibernate.engine.jdbc.spi.SqlExceptionHelper.logExceptions:131 - ОШИБКА: столбец meal0_.datetime не существует
 Подсказка: Возможно, предполагалась ссылка на столбец "meal0_.date_time".


18 replies
Yevhen Maksymovych [10 hours ago]
ну, судя по всему, у тебя столбец в таблице называется "date_time"


saudabaew [10 hours ago]
да не, так и называется datetime


Oleksii Leshchenko [9 hours ago]
А как называется поле в Энтити, и как в БД?


Yevhen Maksymovych [9 hours ago]
тогда странно. попробуй таблицы пересоздать


Yevhen Maksymovych [9 hours ago]
не стоит случаем чего-то типа "hbm2ddl=create" в параметрах хибернейта? а то он может каким-то образом до твоего инита их сам создаёт, и именует по своим правилам?


saudabaew [9 hours ago]
@Oleksii Leshchenko в ентити: 
@Column(name = "datetime", nullable = false, unique = true)
   @NotBlank
   private LocalDateTime dateTime;


saudabaew [9 hours ago]
Может быть где-то здесь косяк: 
@NamedQuery(name = Meal.DELETE, query = "DELETE FROM Meal m WHERE m.id=:id AND m.user.id=:userId") 
?


saudabaew [9 hours ago]
@Override
   public boolean delete(int id, int userId) {
       return em.createNamedQuery(Meal.DELETE)
               .setParameter("id", id)
               .setParameter("userId", userId)
               .executeUpdate() != 0;
   }


Yevhen Maksymovych [9 hours ago]
ну, если ты не менял скрипт initDb.sql Григория, то у него там иначе (edited)


Yevhen Maksymovych [9 hours ago]
```CREATE TABLE meals (
  id          INTEGER PRIMARY KEY DEFAULT nextval('global_seq'),
  user_id     INTEGER   NOT NULL,
  date_time   TIMESTAMP NOT NULL,```


Yevhen Maksymovych [9 hours ago]
т.е. date_time

Oleksii Leshchenko [9 hours ago]
и в самой базе тоже колонка datetime? или там date_time таки?


saudabaew [9 hours ago]
запутался. в таблице meals колонка называется date_time. скрипты не менял...


Yevhen Maksymovych [9 hours ago]
ну вот и указывай в своей энтити, как в таблице. как он иначе тогда их соотнесёт


Yevhen Maksymovych [9 hours ago]
своё имя столбца ты можешь указывать либо если на откуп хибернейта оставляешь создание таблиц, либо если заранее озаботился, чтобы в таблице это имя соответствовало тому, как ты обзываешь столбец


saudabaew [9 hours ago]
чет у меня даже юзер тесты сломались. видимо где то выше косяк.


saudabaew [9 hours ago]
пишу правильные названия - идея ругается, но тест проходит...Пишу без нижнего подчеркивания, идея не ругается, но тест падает.


Pavel Klindziuk [1 hour ago]
не обращай внимания,пусть ругается ) пиши как в скиртаху Григория!


Vladimir Gorbatenko [2:50 PM]
вероятно было..
@test
   public void get() throws Exception {
       Meal actual = service.get(ADMIN_MEAL_ID, ADMIN_ID);
       ADMIN_MEAL1.setUser(ADMIN);
       assertMatch(actual, ADMIN_MEAL1);
   }
Не проходил тест пока в ADMIN_MEAL1 не добавил юзера. В комментах выше не понял, таки надо юзера добавлять как это сделал я или нет???

test [2:50 PM]
joined #hw4 by invitation from Vladimir Gorbatenko.


alexey [Today at 4:17 PM]
in #hw4
Почему  public Meal save(Meal meal, int userId) {

       if (meal.isNew()) {
           User ref = em.getReference(User.class, userId);
           meal.setUser(ref);
           em.persist(meal);
           return meal;
       }    для Postgress работает, а когда переключаешься на Hsql  то вылетает с ошибкой?! (edited)


18 replies
Oleksii Leshchenko [6 hours ago]
А какое именно сообщение обь ошибке?

alexey [6 hours ago]
Caused by: org.hsqldb.HsqlException: user lacks privilege or object not found: NEXTVAL


alexey [6 hours ago]
mentioned this image: 11.jpg
2 Comments


Oleksii Leshchenko [6 hours ago]
Для Hsql надо было в настройках прописывать другой файлик инициализации БД... Скорее всего база не полностью создалась


alexey [6 hours ago]
остальные тесты проходит, все кроме сейва


Yevhen Maksymovych [6 hours ago]
судя по логу, нет сиквенса global_seq, потому и не даёт сохранить. проверь, что он создаётся

Oleksii Leshchenko [6 hours ago]
база в памяти или на диске? если на диске - подкючись и проверь, есть ли этот сиквенс


alexey [6 hours ago]
сиквенс же у нас привязан к id

alexey [6 hours ago]
захожу в таблицу, айдишники есть


alexey [6 hours ago]
или я чего то не понимаю!?


Yevhen Maksymovych [6 hours ago]
сиквенс не привязан к айдишникам, айдишники привязаны к сиквенсу

Yevhen Maksymovych [6 hours ago]
изначально данные добавляются с указанными ид, если ты пытаешься добавить в таблицу запись без ид, она берётся из сиквенса по правилам, которые прописаны в этом сиквенсе


Yevhen Maksymovych [6 hours ago]
судя по тому, что у тебя не работает сохранения, бд по какой-то причине не может сгенерировать новый ид из этого сиквенса


Yevhen Maksymovych [6 hours ago]
собственно, об этом она тебе и пишет в ошибках, что либо нет сиквенса, либо прав на него


alexey [6 hours ago]
Просто не пойму тогда где ошибка. Если другая БД правильно отрабатывает с методом save, значит дело точно не репозитории?!


Yevhen Maksymovych [6 hours ago]
дела в инициализации таблицы


Yevhen Maksymovych [6 hours ago]
покажи гит


alexey [6 hours ago]
https://github.com/alexey8686/topjava.git


alexey [4:26 PM]
uploaded this image: 11.jpg 


Vladimir Gorbatenko [4:37 PM]
Все переделывали 2 метода MealTestData.assertMatch чтоб не учитывалось поле "user"?

Ma3stro [4:39 PM]
Угу.

qf05 [4:44 PM]
А я правильно понимаю, что если метод помечен аннотацией Transactional, и в этом методе есть несколько операций записи в базу, то это гарантирует что либо выполнятся все операции либо ни одной.


Vladimir Gorbatenko [Today at 4:51 PM]
in #hw4
Валятся тесты "updateNotFound()" и "update()". Виноват ведь "public Meal save(Meal meal, int userId)" потому что user==null. Подскажите как решить.


2 replies
qf05 [5 hours ago]
я сделал с двумя запросами в базу, но на сколько это правильно пока не знаю. это всё что я смог придумать.


Grigory Kislin [5 hours ago]
Подсказки по HW4 п.1


Slav [4:53 PM]
Почему у меня вообще нет опции HSQLDB (Embeded) при выборе Data Source? Предлагаются только HSQLDB (Remote) и HSQLDB (In-memory).

Viktor [4:56 PM]
Ребята если у вас что-то падает с ошибкой, читайте ошибку и пытайтесь с ней разобраться, spring и hibernate пишут выкидывают говорливые  exception читайте и решайте. Если сами решить не смогли и гугл не помог или сломался, выкладывайте вместе с вопросом стек ошибки, тут очень мало экстрасенсов.

Vladimir Gorbatenko [5:09 PM]
added this Plain Text snippet: Из MealTestData 
public static Meal getUpdated() {
    Meal meal = new Meal(MEAL1_ID, MEAL1.getDateTime(), "Обновленный завтрак", 200);
    meal.setUser(USER);
    return meal;
  }

Vladimir Gorbatenko [5:10 PM]
Изменил таким образом MealTestData, и тесты прошли, но вот сомневаюсь в правильности такого решения.

Grigory Kislin [5:11 PM]
commented on alexey’s file 11.jpg
чтото с правами. гуглил?


Aleksey Vra [Today at 5:13 PM]
in #hw4
 ```em.find(Meal.class, id);```
намекните как сделать, чтоб при поиске учитывался еще и user_id.. у меня получается сначала достаю еду а потом сравниваю userID


5 replies
Grigory Kislin [5 hours ago]
можно либо так либо чз NamedQuery и WHERE



Ma3stro [3 hours ago]
Я сделал getAll и сделал поиск циклом хд


Ma3stro [3 hours ago]
Но что-то я сомневаюсь в правильности)


Pavel Klindziuk [1 hour ago]
сначала достнать юзера а потом передавай его параметром в  NamedQuery


Aleksey Vra [1 hour ago]
это двойная работа.. 
Григорий выше ответил, в принципе, так и сделал 2 мя выриантами, просто думал может еще проще можно, оказалось и так нормально


Vladimir Gorbatenko [5:14 PM]
commented on Из MealTestData
И собственно такой save
@Override
   @Transactional
   public Meal save(Meal meal, int userId) {
       if (meal.isNew()) {
           User user = em.getReference(User.class, userId);
           meal.setUser(user);
           em.persist(meal);
           return meal;
       } else {
           Meal result = em.find(Meal.class, meal.getId());
           if(result.getUser().getId() != userId) {
               throw new NotFoundException("Not found!");
           }
           return em.merge(meal);
       }
   }

alexey [6:54 PM]
commented on 11.jpg
гуглил, но копал в сторону сиквенса. пока не разобрался

Ma3stro [7:18 PM]
@Vladimir Gorbatenko, работа с исключениями у нас пока строго в сервисе. Не нужно их здесь кидать
Попробуй для update сделать запрос на подобии того, что было в Jdbc реализации (edited)

Pavel Klindziuk [9:04 PM]
commented on Vladimir Gorbatenko’s snippet Из MealTestData
на слое репозитория ты должен отдавать в  слой серисов "null", а не выбрасывать эксепшн. NotFoundException должен бросать слой сервисов.


roma [11:17 PM]
Ребята как только добавляю @Entity над класом мил у меня отваливаютя UserService Tests
```Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'entityManagerFactory' defined in class path resource [spring/spring-db.xml]: Invocation of init method failed; nested exception is javax.persistence.PersistenceException: [PersistenceUnit: default] Unable to build Hibernate SessionFactory```
Почему отваливатся юзер тесты - я их класы вообще не трогал... почему не может оздать Hibernate SessionFactory? (edited)


roma [Mar 26th at 11:24 PM]
in #hw4
Помогите плиз разобраться


3 replies
Fedor [2 days ago]
Попробуй все остальные аннотации добавить в мил, по заданию, потом все заработает


roma [2 days ago]
@Fedor Все добавил вроде и поcле добавления @Entity вылетаю - мне кажется дело в этом:
    ```@ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id")
    private User user;```
но не уверен (edited)


roma [2 days ago]
Охренеть ) нашел ошибку )))) - было:
    ```@Column(name = "description", nullable = false)
    @NotBlank
    private int calories;```


saudabaew [7:43 AM]
uploaded this image: в локал ченж обнаружил скачанный javaee.jar. Просто удалить? 

This message was deleted.

Reomor [1 day ago]
причем тут я вообще?)


Kirilo [23 hours ago]
:slightly_smiling_face:


Kirilo [9:38 AM]
@saudabaew я откатывался и обновлял проект уже с боковой панельки (edited)

poleg [9:39 AM]
У меня после просмотра видео по jpa осталась кучка вопросов и непоняток. ДЗ по аналогии сделать было несложно, но вот это ощущение долбаной черной магии раздражало. Поэтому если у кого остались непонятки, рекомендую почитать вот это (ссылки есть в уроке, но если вдруг кто мимо них):
https://easyjava.ru/data/jpa/hello-jpa-i-hibernate/
https://easyjava.ru/data/jpa/jpa-entity-mapping/
https://easyjava.ru/data/jpa/jpa-entitymanager-upravlyaem-sushhnostyami/
и вообще этот раздел:
https://easyjava.ru/category/data/jpa/

Куча вопросов снялось. (edited)
EasyJava
Hello, JPA (и Hibernate)
JDBC предоставляет вполне достаточный интерфейс для работы с базами данных в Java. Однако этот интерфейс весьма многословен и довольно неудобен и даже Spring JDBC не делает его сильно лучше. По сути дела проблема в том, что реляционные базы данных работают с таблицами... #h2 #helloworld #hibernate
Mar 4th, 2016
https://easyjava.ru/wp-content/uploads/2016/03/orm.png
EasyJava
JPA entity mapping
Главное в любом ORM решении, это описать, как ваши классы (entity) отображаются (maps) на реляционные таблицы. В JPA это делается с помощью аннотаций. Как я уже писал, перед тем, как начать использовать класс в качестве JPA сущности, надо убедиться, что он соответствует... #h2 #hibernate #jpa
Mar 18th, 2016
https://easyjava.ru/wp-content/uploads/2016/03/operations_details.png
EasyJava
JPA EntityManager: управляем сущностями
Как определять сущности и связи между ними я уже писал. Пора рассказать, как сущностями управлять. Хотя в сущности :) большую часть управления сущностями я описал в вводном примере. Фабрика Управление сущностями начинается с создания EntityManagerFactory, которая отвечает за... #h2 #hibernate #jpa
Apr 19th, 2016
https://easyjava.ru/wp-content/uploads/2016/04/tmp2f4191_thumb-600x398.jpg
EasyJava
Данные – Java Persistence API
JPA – это технология, обеспечивающая объектно-реляционное отображение простых JAVA объектов и предоставляющая API для сохранения, получения и управления такими объектами. JPA – это спецификация (документ, утвержденный как стандарт, описывающий все аспекты технологии), часть EJB3 спецификации...

Aleksey Vra [9:42 AM]
а обязательно выставлять  @JoinColumn(name = ..) над полем User user?

Kirilo [9:46 AM]
http://qaru.site/questions/20587/jpa-joincolumn-vs-mappedby
qaru.site
java - JPA JoinColumn vs mappedBy - Qaru
В чем разница между: @Entity public class Company { @OneToMany(cascade = CascadeType.ALL , fetch = FetchType.LAZY) @JoinColumn(name = "companyIdRef", referencedColumnName = "companyId") private List<Branch> branches; ... } и

Ilya [10:03 AM]
@Aleksey Vra кстати, хороший вопрос. В ссылке выше ответа не нашел. (edited)


Sergey [Yesterday at 10:15 AM]
in #hw4
Народ, доброго времени суток всем. Есть вопрос оп optional. Для вывода имени теста и затраченного времени заэкстендил StopWatch JUnit'овский. Переопределил методы, все красиво, в консоль пишет. А в лог не пишет. Смотрю по дебагу а логгер, который я пытаюсь получить в своем StopWatch классе  вот таким образом:     private final Logger log = LoggerFactory.getLogger(getClass()); - null. Не могу понять, почему он null...


3 replies
Aleksey Vra [1 day ago]
сделай Logger статическим и пропиши вручную .class..


Aleksey Vra [1 day ago]
хотя у меня и без статик работает..


Sergey [1 day ago]
Победил. На самом деле просто не прописал в logback-test.xml аппендер с указанием, что в него надо  писать из ru.javawebinar.topjava


Хэм [10:36 AM]
возник вопрос почему бы не сделать один `@NamedQuery` на `List<Meal> getAll(int userid)` а дальше как в первом уроке уже сортировать например стримами? (edited)

Ilya [10:45 AM]
@Хэм на сколько я понимаю - фильтровать нужно на уровне БД, ибо не по понятиям грузить в хип кучу мусора.

Vladimir Gorbatenko [10:50 AM]
а разве не сегодня должно было появиться hw5?

Хэм [10:57 AM]
у меня уже чайник закипел никак не могу победить namedQuery  для BETWEEN идые ругается подскажите кто как реализовал а то в интернетах только про sql BETWEEN  а я так понимаю надо hql

Хэм [12:12 PM]
<jdbc:initialize-database data-source="dataSource" enabled="${database.init}">
       <jdbc:script location="classpath:db/`${jdbc.initLocation}`"/> ===> вот эта штукенция горит красным idea ругается
       <jdbc:script encoding="utf-8" location="classpath:db/populateDB.sql"/>
   </jdbc:initialize-database>

Хэм [12:12 PM]
`${jdbc.initLocation}`cannot resolve file (edited)

Хэм [12:15 PM]
нет его нигде

Arthur [12:27 PM]
postgres.properties у тебя в проекте есть?

Хэм [12:40 PM]
да увидел все прописано как  надо но почему то все равно горит красным :thinking_face:

Arthur [12:45 PM]
проект запускается и работает?

Хэм [12:50 PM]
postgres.properties все серое все unused

Arthur [12:51 PM]
ты в spring-db.xml ничего не менял?

Fedor [12:51 PM]
Попробуй закрыть spring-db и снова открыть, все опять станет серым
Только не кликай по нему

Хэм [12:52 PM]
да не что мне там менять))
<beans xmlns="http://www.springframework.org/schema/beans"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:p="http://www.springframework.org/schema/p"
      xmlns:context="http://www.springframework.org/schema/context"
      xmlns:jdbc="http://www.springframework.org/schema/jdbc"
      xmlns:tx="http://www.springframework.org/schema/tx"
      xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
      http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
      http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc.xsd
      http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd">

   <!-- Change DB by comment/uncomment property-placeholder -->

   <context:property-placeholder location="classpath:db/postgres.properties" system-properties-mode="OVERRIDE"/>
   <!--<context:property-placeholder location="classpath:db/hsqldb.properties" system-properties-mode="OVERRIDE"/>-->

   <context:component-scan base-package="ru.javawebinar.**.repository.jpa"/>

   <jdbc:initialize-database data-source="dataSource" enabled="${database.init}">
       <jdbc:script location="classpath:db/${jdbc.initLocation}"/>
       <jdbc:script encoding="utf-8" location="classpath:db/populateDB.sql"/>
   </jdbc:initialize-database>

   <!--no pooling-->
   <bean id="dataSource"
         class="org.springframework.jdbc.datasource.DriverManagerDataSource">
       <property name="driverClassName" value="${database.driverClassName}"/>
       <property name="url" value="${database.url}"/>
       <property name="username" value="${database.username}"/>
       <property name="password" value="${database.password}"/>
   </bean>

   <bean id="entityManagerFactory" class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"
         p:dataSource-ref="dataSource"
         p:packagesToScan="ru.javawebinar.**.model">
       <!--p:persistenceUnitName="persistenceUnit">-->

       <property name="jpaPropertyMap">
           <map>
               <entry key="#{T(org.hibernate.cfg.AvailableSettings).FORMAT_SQL}" value="${hibernate.format_sql}"/>
               <entry key="#{T(org.hibernate.cfg.AvailableSettings).USE_SQL_COMMENTS}" value="${hibernate.use_sql_comments}"/>
               <!--<entry key="#{T(org.hibernate.cfg.AvailableSettings).HBM2DDL_AUTO}" value="${hibernate.hbm2ddl.auto}"/>-->
           </map>
       </property>

       <property name="jpaVendorAdapter">
           <bean class="org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter"
                 p:showSql="${jpa.showSql}">
           </bean>
       </property>
   </bean>

   <tx:annotation-driven/>

   <!-- Transaction manager for a single JPA EntityManagerFactory (alternative to JTA) -->
   <bean id="transactionManager" class="org.springframework.orm.jpa.JpaTransactionManager"
         p:entityManagerFactory-ref="entityManagerFactory"/>

<!--
   <context:component-scan base-package="ru.javawebinar.**.repository.jdbc"/>
   <bean id="jdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate">
       <constructor-arg ref="dataSource"/>
   </bean>

   <bean id="namedJdbcTemplate" class="org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate">
       <constructor-arg ref="dataSource"/>
   </bean>
-->
</beans>
userservicetest работает
просто идея тупит что ли?

Arthur [12:56 PM]
похоже на то

Andrew Manik [1:12 PM]
я просто руками путь вбил, та-же проблема, тоже не врубаюсь

realcorwin [2:05 PM]
написал же Григорий: "IDEA может ${jdbc.initLocation} подчеркивать красным - тупит..."
немцы в таких случаях говорят: "У тех, кто умеет читать, явное преимущество". :slightly_smiling_face:

Andrew Manik [2:17 PM]
ну что поделать:) видать малость разучился:)

Хэм [2:19 PM]
да читать вещь полезная штука))

roma [3:07 PM]
Народ есть кто живой?


roma [Yesterday at 3:08 PM]
in #hw4
Нужна помощь


18 replies
Fedor [1 day ago]
Чем помочь?


roma [1 day ago]
    ```@ManyToOne(fetch = FetchType.EAGER)
    @JoinColumn(name = "user_id")
    private User user;```
и
  ```@NamedQuery(name = Meal.GET, query = "SELECT m FROM Meal m LEFT JOIN FETCH m.user WHERE m.id=:id AND m.user.id=:userId"), ````
и
    ```@Override
    public Meal get(int id, int userId) {
        Meal result = (Meal) em.createNamedQuery(Meal.GET)
                .setParameter("id", id)
                .setParameter("userId", userId)
                .getSingleResult();
    return result.getUser().getId()!=userId?null:result;
    }при так```
такойой реализации летит такая фигня
 ```java.lang.AssertionError: 
Expecting value <null> in field <"user"> but was <User{id=100001, email=admin@gmail.com, name=Admin, enabled=true, roles=[ROLE_ADMIN], caloriesPerDay=2000}> in <Meal{id=100008, dateTime=2015-06-01T14:00, description='Админ ланч', calories=510}>.
Comparison was performed on all fields```
(edited)


roma [1 day ago]
@Fedor выше вопрос


Viktor [1 day ago]
куда летит?

roma [1 day ago]
@Viktor ой ) исправил вопрос - то что летит в стек трейс (edited)


Viktor [1 day ago]
@roma что именно не понятно?

roma [1 day ago]
Не понятно почему юзер не достается и как его достать


Viktor [1 day ago]
юзер достается

roma [1 day ago]
запустался я совсем - это у меня что ли в тестовых данных юзера нет


Fedor [1 day ago]
Я не думаю что по юзеру надо сравнивать

roma [1 day ago]
Тоесть, мы в мил добавили поле юзер, а в тестовых данных его не добавили - блин я думал у меня из базы не достается юзер, а в тестовых данных он есть (edited)

Fedor [1 day ago]
Ты в UserTestData поправил два метода assertMatch, чтобы исключить юзера из сравнений?

roma [1 day ago]
нет конечно - сейчас когда догнал - начал судорожно править


roma [1 day ago]
спасибо

roma [1 day ago]
можно еще вопрос маленький

Fedor [1 day ago]
Вернее в MealTestData, сорри

Fedor [1 day ago]
давай

roma [1 day ago]
Снялся вопрос ) - не повторить эксепшен ))) Спасбио большое - большая часть тестов заработала - сейчас с остатками разберусь


Artem Murk [3:34 PM]
Всем привет, нужна помощь с update, никак не могу понять почему он не апдейтит Meal, пытаюсь сделать с помощью NamedQuery.
    ```@Transactional
    public Meal save(Meal meal, int userId) {

        if (meal.isNew()){
            User user = em.getReference(User.class, userId);
            meal.setUser(user);
            em.persist(meal);
            return meal;
        } else {
            if (em.createNamedQuery(Meal.UPDATE)
                    .setParameter("meal",meal )
                    .setParameter("mealId" ,meal.getId() )
                    .setParameter("userId" ,userId ).executeUpdate() !=0) {
                return meal;
            }
        }
        return null;
    }```
в jpaRepo.
        ```@NamedQuery(name = Meal.UPDATE, query = "UPDATE Meal m SET m=:meal WHERE m.id=:mealId AND m.user.id=:userId"),```
мой query в Meal. Хелп!


Artem Murk [Yesterday at 3:37 PM]
in #hw4
метод get возвращает старое значение, новое значение в базу не заноситься, хотя ошибки не вылетает, в if-е условие не равно нулю, тест на NotFoundException проходит нормально


11 replies
Aleksey Vra [1 day ago]
у меня что то похожее было..
записывал meal не полностью а по полям
SET m.discription=:discription


Artem Murk [1 day ago]
пытался так сделать, ругается на AND. WTF?


Artem Murk [1 day ago]
@Aleksey Vra


Aleksey Vra [1 day ago]
а запятая если? точно помню что поля записывал по-отдельности, открыть проект сейчас не могу посмотреть


Artem Murk [1 day ago]
точно, голова уже не варит как их связать....

Aleksey Vra [1 day ago]
HQL по сути как SQL только проще)

Artem Murk [1 day ago]
Если знаешь нормально SQL, то наверное ты прав, хотя ничего не подвижного не вижу, время улетает в трубу на изучение нового материала, а на носу 5 урок и выпускной проект...


Artem Murk [1 day ago]
ура, прощло


Artem Murk [1 day ago]
@Aleksey Vra спасибо)

Pavel Klindziuk [1 day ago]
можно и без неймед квери апдейтнуть :
if (null != meal.getUser() && meal.getUser().getId() == userId) {
           return em.merge(meal); (edited)


Aleksey Vra [1 day ago]
@Pavel Klindziuk а разве проверку не так надо делать? 
if (null != meal && ...)
ведь find может вернуть null и meal.getUser() выдаст NPE


roma [4:43 PM]
    ```@Transactional
    public Meal save(Meal meal, int userId)
    {
        if (meal.isNew()) {
            em.persist(meal);
            return meal;
        } else {
            return (meal.getUser().getId()!=userId)?null: em.merge(meal);
        }
    }```
и получаю:
```org.springframework.transaction.TransactionSystemException: Could not commit JPA transaction; nested exception is javax.persistence.RollbackException: Error while committing the transaction```

Oleksii Leshchenko [1 day ago]
meal.getId()!=userId
ты сравниваешь разные айдишники, от разных энтити... Они никогда не будут равны, тем более у нас один сиквенс на всех...


roma [1 day ago]
@Oleksii Leshchenko согласен косяк адский но если сделать так вылетает с тем же эксепшеном
    ```@Transactional
    public Meal save(Meal meal, int userId)
    {
        if (meal.isNew()) {
            em.persist(meal);
            return meal;
        } else {
            return (meal.getUser().getId()!=userId)?null: em.merge(meal);
        }
    }```
(edited)


Oleksii Leshchenko [1 day ago]
а можно все сообщение со стеком целиком?


Pavel Klindziuk [1 day ago]
Ты пытаешься замапить Meal у которого поле user : null
Один из способов пофиксить :
User user = em.getReference(User.class, userId);
           meal.setUser(user);

           
           
Джони [12:00 PM]
uploaded and commented on this image: error.jpg 

ребята, кто работает в postgres на linux, помогите разобраться. 
1. у меня версия psql 9.5.12. роль "user" он мне не дал создать, в итоге я создал "username"
2. базу topjava локально создал
3. поставил pgadmin4, но он её не видит. вообще ничего не видит.
4. в idia postgres подключил
5. после накатки патчей с 4_1 по 4_4 приложение запускается, но при нажатии кнопки "select" выходит следующее сообщение об ошибке:  Servlet.init() for servlet [mealServlet] threw exception

В каком месте я мог накосячить?

Джони [12:00 PM]
uploaded this image: idia.jpg 


Джони [12:00 PM]
uploaded this image: pgadmin.jpg 


Oleksii Leshchenko [12:04 PM]
commented on Джони’s file error.jpg
Я чего user не дало создать?
я делал по инструкции:
https://www.digitalocean.com/community/tutorials/postgresql-ubuntu-16-04-ru


Viktor [Today at 12:05 PM]
in #hw4
1. в postgers.properties у тебя стоит порт 5432(дефолт) в браузере 5050, почему так?
2. В postgers.properties укажи диалект для БД


2 replies
tema.emelyan [3 hours ago]
пгадмин 4 работает на порт 5050, это браузер пгадмина у него открыт


Viktor [2 hours ago]
не знал об этом :slightly_smiling_face: спасибо


Viktor [12:06 PM]
3. Заходи в логи томката и смотри весь стек.

tema.emelyan [12:26 PM]
commented on Джони’s file error.jpg
побольше бы знать об ошибке :smiley:
tema.emelyan [12:28 PM]
Георгий вроде бы давал уточнение, что нужно кавычки вокруг user ставить, чтобы можно было создать такого пользователя

Alexander Shnaider [1:46 PM]
друзья, я тут недавно восстанавливал проект на другом ноуте, и вот сейчас понял что у меня логирование не работает.  Нужно ведь было только создать файл `topjava/log/topjava.log` и создать переменную среды `TOPJAVA_ROOT` с путём к папке `topjava`, так? Никак не пойму, почему не логируется ничего? Запускаю тест, например InMemoryAdminRestControllerTest, лог файл остаётся пустым, что я упускаю?
блин, написал вопрос и понял что у нас два разных конфига для логирования в тесте и в продакшине, всё заработало


Grigory Kislin [11:00 AM]
commented on Джони’s file error.jpg
поправка- Григорий
tema.emelyan [1:51 PM]
пардон, всё время путаю


dmitry_ov [6:54 PM]
added and commented on this Java snippet: Untitled 
@Override
public boolean delete(int id, int userId) {
​
Query query = em.createQuery("DELETE FROM Meal m WHERE m.id=:id AND m.user.id=:userId");
    return query
        .setParameter("id", id)
        .setParameter("userId", userId)
        .executeUpdate() != 0;
}
​
​
javax.persistence.TransactionRequiredException: Executing an update/delete query
	at org.hibernate.query.internal.AbstractProducedQuery.executeUpdate(AbstractProducedQuery.java:1496)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.springframework.orm.jpa.SharedEntityManagerCreator$DeferredQueryInvocationHandler.invoke(SharedEntityManagerCreator.java:379)
	at com.sun.proxy.$Proxy63.executeUpdate(Unknown Source)
	at ru.javawebinar.topjava.repository.jpa.JpaMealRepositoryImpl.delete(JpaMealRepositoryImpl.java:56)
Collapse 
Коллеги кто ниубдь сталкивался с такого рода ошибками при удалении из таблицы meals ?

realcorwin [7:24 PM]
не хватает @Transactional?

realcorwin [7:25 PM]
> @Override
   @Transactional
   public boolean delete(int id, int userId) {
       return em.createNamedQuery(Meal.DELETE)
               .setParameter("id", id)
               .setParameter("userId", userId)
               .executeUpdate() != 0;
   }


dmitry_ov [2 hours ago]
Спасибо. Да, вы правы.


realcorwin [1 day ago]
давайте на ты :slightly_smiling_face:


Евгений [10:40 PM]
@Grigory Kislin У вас в материалах к уроку есть статья про стратегии отображения наследования в Hibernate. На Хабре есть аналог статьи на русском, мб его добавить в список (или заменить английский вариант)? Возможно, многим будет удобнее.  https://habrahabr.ru/post/337488/
Хабрахабр
Наследование в Hibernate: выбор стратегии
Наследование является одним из основных принципов ООП. В то же время, значительное количество корпоративных приложений имеют в своей основе реляционные базы...
https://habrastorage.org/getpro/habr/post_images/3b5/974/f53/3b5974f533b24e6f1ed9fdea8300898c.jpg


Евгений [10:25 PM]
Спасибо что добавили)) теперь можно и похвастаться, что статья моя ^_^ (edited)
Открыто достижение - "Уроборос": пройдите стажировку, в учебных материалах которой будет статья, которую вы написали


Serhii [12:34 AM]
Помогите пожалуйста !!! С чем может быть связана ошибка org.hibernate.DuplicateMappingException: Duplicate query mapping Meal.getAllSorted ? (edited)


Viktor [Today at 12:35 AM]
in #hw4
@Serhii эм.. с дубликатами?


3 replies
Serhii [11 hours ago]
Да


Serhii [11 hours ago]
Где смотреть?


Viktor [10 hours ago]
Meal.getAllSorted куда-то туда наверно